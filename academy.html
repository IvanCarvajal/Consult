<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calypso Labs - Sistema de Acreditación</title>
    <meta name="description" content="Academia de tecnología de Calypso Labs: Explora recursos, aprende tecnologías y crea soluciones en electrónica, IoT, robótica y más.">
    <link rel="icon" href="https://store.calypsolabs.com.mx/assets/images/CalypsoLabs_Logo.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <style>
        :root {
          --theme-bg-primary: #000;
          --theme-bg-secondary: #1a1a1a;
          --theme-bg-tertiary: #1c1c1c; /* Un poco más claro para contraste */
          --theme-text-primary: #e0e0e0;
          --theme-text-secondary: #b0b0b0;
          --theme-accent-primary: #00FF7F; /* Verde menta vibrante */
          --theme-accent-secondary: #33FF99; /* Un tono más claro de menta */
          --theme-accent-glow: rgba(0, 255, 127, 0.5);
          --theme-glass-bg: rgba(25, 28, 32, 0.75);
          --theme-glass-border: rgba(0, 255, 127, 0.2);
          --app-background-image: none; /* Será seteado por JS */
          --app-background-aurora: radial-gradient(ellipse at top left, rgba(0, 255, 127, 0.08) 0%, transparent 50%),
                                     radial-gradient(ellipse at bottom right, rgba(0, 123, 255, 0.08) 0%, transparent 50%);
          --blur-intensity: 8px;

          --bg-color: #181b20;

                --glass-bg: rgba(28, 33, 42, 0.85); /* Increased opacity slightly */
                --glass-border: rgba(34, 229, 132, 0.22); /* Slightly more visible border */
                --glass-shadow-1: rgba(22, 170, 255, 0.13);
                --glass-shadow-2: rgba(0,0,0,0.18);

                --neon-text-color: #22e584;
                --neon-text-shadow-1: rgba(34, 229, 132, 0.6);
                --neon-text-shadow-2: rgba(22, 170, 255, 0.4);

                --btn-primary-bg: #16aaff;
                --btn-primary-text: #101214;
                --btn-primary-shadow-1: rgba(22,170,255,0.22);
                --btn-primary-shadow-2: rgba(0,0,0,0.3);
                --btn-primary-hover-bg: #22e584;
                --btn-primary-hover-text: #101214;
                --btn-primary-hover-shadow-1: rgba(34,229,132,0.45);
                --btn-primary-hover-shadow-2: rgba(0,0,0,0.34);

                --btn-secondary-text: #22e584;
                --btn-secondary-border: #22e584;
                --btn-secondary-hover-bg: #22e584;
                --btn-secondary-hover-text: #101214;
                --btn-secondary-hover-shadow: rgba(34,229,132,0.35);

                --link-hover-color: #22e584;
                --link-accent-color: #16aaff;

                --input-bg: #14161a;
                --input-border: rgba(34, 229, 132, 0.3);
                --input-text-color: #fafbfc;

          --calypso-error: #FF4747;
          --calypso-success: #22e584;
          --calypso-warning: #FFD700;
          --sidebar-width: 280px;
          transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;

        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
          font-family: 'Inter', sans-serif;
          line-height: 1.6;
          background-color: var(--theme-bg-primary);
          color: var(--theme-text-primary);
          transition: background-color 0.3s ease, color 0.3s ease;
          overflow-x: hidden; /* Prevenir scroll horizontal por animaciones */
        }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }

        .app-wrapper {
            position: relative;
            min-height: 100vh;
            width: 100%;
            background-image: var(--app-background-image), var(--app-background-aurora);
            background-size: cover, 100% 100%;
            background-position: center, center;
            background-attachment: fixed, fixed;
            transition: background-image 0.5s ease-in-out;
            overflow: hidden; /* Contener el sidebar */
        }
        .app-container {
          width: 100%;
          min-height: 100vh;
          background-color: transparent; /* Para ver el fondo del wrapper */
          display: flex;
          flex-direction: column;
          margin: 0 auto;
          box-shadow: 0 0 30px rgba(0,0,0,0.3);
          transition: background-color 0.3s ease;
        }

        .glass {
          background: var(--theme-glass-bg);
          border: 1.5px solid var(--theme-glass-border);
          backdrop-filter: blur(var(--blur-intensity));
          -webkit-backdrop-filter: blur(var(--blur-intensity));
          border-radius: 1rem;
          box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 0 50px rgba(0,0,0, 0.15);
          transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .text-gradient-green {
          background: linear-gradient(90deg, var(--theme-accent-primary), var(--theme-accent-secondary), var(--theme-accent-primary));
          -webkit-background-clip: text; -webkit-text-fill-color: transparent;
          background-clip: text; text-fill-color: transparent;
          animation: gradientShimmer 5s ease infinite;
          background-size: 200% 200%;
        }
        @keyframes gradientShimmer {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }

        ::-webkit-scrollbar { width: 8px; background: var(--theme-bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--theme-accent-primary); border-radius: 4px; transition: background-color 0.2s ease; }
        ::-webkit-scrollbar-thumb:hover { background: var(--theme-accent-secondary); }

        .btn {
          font-family: 'Orbitron', sans-serif; font-weight: 700; padding: 0.65rem 1.1rem; border-radius: 0.6rem;
          font-size: 0.9rem; letter-spacing: 0.05em;
          transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
          display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer;
          text-decoration: none; position: relative; overflow: hidden;
        }
        .btn-primary {
          background: var(--theme-accent-primary); color: var(--theme-bg-primary);
          box-shadow: 0 0 12px -2px var(--theme-accent-glow), 0 3px 6px rgba(0,0,0,0.25);
          border: 1px solid var(--theme-accent-primary);
        }
        .btn-primary:hover {
          background-color: var(--theme-accent-secondary); border-color: var(--theme-accent-secondary);
          transform: translateY(-3px) scale(1.02);
          box-shadow: 0 0 18px 0px var(--theme-accent-glow), 0 5px 10px rgba(0,0,0,0.3);
        }
        .btn-primary:active { transform: translateY(-1px) scale(0.98); box-shadow: 0 0 10px -4px var(--theme-accent-glow), 0 2px 4px rgba(0,0,0,0.2); }

        .btn-secondary {
          color: var(--theme-accent-primary); border: 1px solid var(--theme-accent-primary);
          background-color: transparent;
        }
        .btn-secondary:hover {
          background: var(--theme-accent-glow); color: var(--theme-accent-secondary);
          border-color: var(--theme-accent-secondary); transform: translateY(-2px);
        }
        .btn-secondary:active { transform: translateY(0px); background: var(--theme-accent-primary); color: var(--theme-bg-primary); }

        .btn:disabled, .btn.disabled {
          background-color: var(--theme-bg-tertiary); color: var(--theme-text-secondary);
          border-color: var(--theme-glass-border); box-shadow: none; cursor: not-allowed;
          opacity: 0.6; transform: none !important;
        }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }

        .btn-spinner {
            display: inline-block; width: 1em; height: 1em;
            border: 2px solid currentColor; border-right-color: transparent;
            border-radius: 50%; animation: spin 0.75s linear infinite;
            margin-right: 0.5em; vertical-align: text-bottom;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


        input[type="text"], input[type="url"], input[type="email"], input[type="tel"], input[type="password"], input[type="number"], textarea, select {
          background-color: var(--theme-bg-tertiary); border: 1.5px solid var(--theme-glass-border);
          color: var(--theme-text-primary); border-radius: 0.6rem; padding: 0.7rem 0.9rem;
          width: 100%; font-size: 0.9rem;
          transition: background-color 0.3s ease, border-color .2s ease-out, box-shadow .2s ease-out, color 0.3s ease;
          font-family: 'Inter', sans-serif;
        }
        input:focus, textarea:focus, select:focus {
          border-color: var(--theme-accent-primary) !important;
          box-shadow: 0 0 0 3px var(--theme-accent-glow), 0 0 12px 2px var(--theme-accent-glow) !important;
          outline: none !important; background-color: var(--theme-bg-secondary);
        }
        input[type="radio"] { margin-right: 8px; accent-color: var(--theme-accent-primary); transform: scale(1.1); vertical-align: middle; cursor:pointer; }
        label, fieldset legend { color: var(--theme-text-secondary); font-weight: 500; font-size: .9rem; margin-bottom: 6px; display: block; transition: color 0.3s ease; }
        label.inline-label { display: inline-flex; align-items: center; color: var(--theme-text-primary); margin-bottom: 0.5rem; padding: 0.6rem 0.8rem; border-radius: 0.5rem; transition: background-color 0.2s ease, color 0.3s ease; cursor: pointer; border: 1px solid transparent; }
        label.inline-label:hover { background-color: var(--theme-bg-tertiary); border-color: var(--theme-glass-border); }
        /* label.inline-label input[type="radio"]:checked + span { color: var(--theme-accent-primary); font-weight: bold; } */ /* Needs JS or more complex CSS for checked styles if span is sibling */

        textarea { min-height: 75px; resize: vertical; }

        .calypso-header {
          background: var(--theme-bg-tertiary); padding: 0;
          border-bottom: 1px solid var(--theme-glass-border);
          display: flex; justify-content: space-between; align-items: center;
          box-shadow: 0 2px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 999;
          transition: background-color 0.3s ease, border-color 0.3s ease;
          max-height: 4rem; /* Adjusted to fit logo */
        }
        .header-left { display: flex; align-items: center; flex-shrink: 0; }
        .sidebar-toggle, .theme-toggle-btn, .mobile-nav-toggle {
            background: none; border: none; color: var(--theme-accent-primary);
            font-size: 1.6rem; cursor: pointer; margin-right: 0.75rem;
            padding: 0.2rem; line-height: 1; border-radius: 50%;
            transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease;
        }
        .sidebar-toggle:hover, .theme-toggle-btn:hover, .mobile-nav-toggle:hover {
            color: var(--theme-accent-secondary); background-color: var(--theme-glass-bg);
            transform: scale(1.1);
        }
        .calypso-header .logo {
          font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: 700;
          color: var(--theme-accent-primary); text-decoration: none;
          transition: color 0.2s ease, text-shadow 0.2s ease;
        }
        .calypso-header .logo:hover { color: var(--theme-accent-secondary); text-shadow: 0 0 8px var(--theme-accent-glow); }
        .calypso-header img { /* For the SVG logo */
            height: 2.5em; /* Adjust as needed */
            width: auto;
            margin-right: 0.5rem; /* Space before "| Academy" */
            vertical-align: middle;
        }


        .calypso-nav { display: flex; align-items: center; flex-grow: 1; justify-content: flex-end; }
        .calypso-nav a, .calypso-nav button.btn-nav {
          font-family: 'Inter', sans-serif; text-decoration: none; color: var(--theme-text-secondary);
          padding: 0.2rem 0.5rem; margin-left: 0.5rem; border-radius: 0.5rem;
          transition: color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
          font-size: 0.9rem; background: none; border: none; cursor: pointer; white-space: nowrap;
        }
        .calypso-nav a:hover, .calypso-nav button.btn-nav:hover {
          color: var(--theme-accent-primary); background-color: var(--theme-bg-primary);
        }
        .calypso-nav a.nav-active {
          color: var(--theme-accent-primary); font-weight: 700;
          box-shadow: inset 0 -2.5px 0 var(--theme-accent-primary);
        }
        .calypso-nav button.btn-nav-action { background-color: var(--theme-accent-primary); color: var(--theme-bg-primary); font-weight: 500; }
        .calypso-nav button.btn-nav-action:hover { background-color: var(--theme-accent-secondary); }
        .calypso-nav button.btn-nav-logout { background-color: var(--calypso-error); color: var(--theme-text-primary); }
        .calypso-nav button.btn-nav-logout:hover { background-color: #ff6666; }

        main#app-root {
            padding: 2.5rem 1.5rem; flex-grow: 1; width: 100%;
            max-width: 1200px; margin: 0 auto;
            opacity: 0;
            animation: fadeInView 0.5s ease-out forwards;
        }
        @keyframes fadeInView {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        main#app-root > section { margin-bottom: 3rem; }
        main#app-root > section:last-child { margin-bottom: 0; }

        .view-title {
          font-family: 'Orbitron', sans-serif; font-size: 2.5rem; font-weight: 700;
          margin-bottom: 1.5rem; text-align: center; color: var(--theme-accent-primary);
          transition: color 0.3s ease;
        }
        .view-subtitle {
          font-family: 'Inter', sans-serif; font-size: 1.1rem; color: var(--theme-text-secondary);
          text-align: center; margin-top: -1rem; margin-bottom: 2rem;
          max-width: 700px; margin-left: auto; margin-right: auto;
          transition: color 0.3s ease;
        }

        .module-card {
          background: var(--theme-bg-tertiary); border: 1px solid var(--theme-glass-border);
          border-radius: 0.8rem; padding: 1.5rem;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94), background-color 0.3s ease, border-color 0.3s ease;
          position: relative; overflow: hidden;
          display: flex; flex-direction: column; /* For button alignment */
        }
        .module-card::before { /* Subtle glow effect on hover */
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border-radius: inherit;
            box-shadow: 0 0 30px -10px var(--theme-accent-glow);
            opacity: 0; transition: opacity 0.3s ease; z-index: -1;
        }
        .module-card:hover {
          transform: translateY(-6px) scale(1.01);
          box-shadow: 0 10px 30px -5px var(--theme-accent-glow), 0 6px 12px rgba(0,0,0,0.2);
          border-color: var(--theme-accent-secondary);
        }
        .module-card:hover::before { opacity: 0.7; }

        .module-card-title {
          font-family: 'Orbitron', sans-serif; font-size: 1.5rem; color: var(--theme-accent-secondary);
          margin-bottom: 0.75rem; transition: color 0.3s ease;
        }
        .module-card-description { color: var(--theme-text-secondary); font-size: 0.9rem; margin-bottom: 1rem; min-height: 60px; transition: color 0.3s ease; flex-grow: 1; /* For button alignment */ }


        .module-card .status-badge { font-size: 0.75rem; font-weight: 700; padding: 0.25rem 0.6rem; border-radius: 1rem; display: inline-block; margin-bottom: 1rem; }
        .status-completed { background-color: var(--calypso-success); color: var(--theme-bg-primary); }
        .status-inprogress { background-color: var(--calypso-warning); color: var(--theme-bg-primary); }
        .status-failed { background-color: var(--calypso-error); color: var(--theme-text-primary); }
        .status-notstarted { background-color: var(--theme-bg-secondary); color: var(--theme-text-secondary); border: 1px solid var(--theme-glass-border); }
        .completed-check-icon { position: absolute; top: 1rem; right: 1rem; font-size: 1.8rem; color: var(--calypso-success); filter: drop-shadow(0 0 5px var(--calypso-success)); }

        .module-detail-container, .lesson-detail-container {
          background: var(--theme-bg-tertiary); border: 1px solid var(--theme-glass-border);
          border-radius: 0.8rem; padding: 2rem;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .module-detail-title, .lesson-detail-title { font-family: 'Orbitron', sans-serif; font-size: 2rem; color: var(--theme-accent-primary); margin-bottom: 0.5rem; }
        .module-detail-description, .lesson-detail-description { color: var(--theme-text-primary); margin-bottom: 1.5rem; line-height: 1.7; }

        .module-resources h3, .lesson-resources h3, .module-evaluation h3, .lesson-evaluation h3, .lesson-challenge h3, .lesson-objectives h3 {
          font-family: 'Orbitron', sans-serif; font-size: 1.3rem; color: var(--theme-accent-secondary);
          margin-top: 1.5rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem;
          border-bottom: 1px solid var(--theme-glass-border); 
        }
        .module-resources ul, .lesson-resources ul { list-style: none; padding-left: 0; }
        .module-resources li, .lesson-resources li { margin-bottom: 0.5rem; color: var(--theme-text-secondary); }
        .module-resources li strong, .lesson-resources li strong { color: var(--theme-accent-primary); }
        .module-resources li a, .lesson-resources li a { color: var(--theme-accent-secondary); text-decoration: none; transition: color 0.2s ease, text-decoration 0.2s ease; }
        .module-resources li a:hover, .lesson-resources li a:hover { text-decoration: underline; color: var(--theme-accent-primary); }

        .form-container { max-width: 450px; margin: 2rem auto; padding: 2rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-message {
            text-align: center; font-size: 0.9rem;
            opacity: 0; max-height: 0; overflow: hidden;
            border-radius: 0.5rem;
            transition: opacity 0.3s ease, max-height 0.3s ease, padding 0.3s ease, margin-top 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
        }
        .form-message.show {
            opacity: 1; max-height: 100px; /* Adjust as needed */
            padding: 0.75rem; margin-top: 1rem;
        }
        .form-message-error { background-color: rgba(255, 71, 71, 0.2); color: var(--calypso-error); border: 1px solid var(--calypso-error); }
        .form-message-success { background-color: rgba(34, 229, 132, 0.2); color: var(--calypso-success); border: 1px solid var(--calypso-success); }

        .profile-cover {
            width: 100%; height: 250px; background-size: cover; background-position: center;
            border-radius: 0.8rem 0.8rem 0 0; display: flex; align-items: flex-end; padding: 20px;
            position: relative; box-shadow: inset 0 -80px 80px -80px rgba(0,0,0,0.7);
            transition: background-image 0.5s ease;
        }
        .profile-avatar-main {
            width: 120px; height: 120px; border-radius: 50%;
            border: 4px solid var(--theme-accent-primary);
            box-shadow: 0 0 20px var(--theme-accent-glow);
            object-fit: cover; position: relative; bottom: -40px; margin-left: 20px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .profile-info-bar {
            padding: 20px; padding-top: 50px; border-radius: 0 0 0.8rem 0.8rem;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start;
            background-color: var(--theme-bg-tertiary);
        }
        .profile-main-details { flex-basis: 60%; }
        .profile-username-main { font-family: 'Orbitron', sans-serif; font-size: 2rem; color: var(--theme-accent-primary); margin-bottom: 0.2rem; }
        .profile-email-main { color: var(--theme-text-secondary); font-size: 1rem; margin-bottom: 1rem; }
        .profile-meta-details { flex-basis: 35%; text-align: right; font-size: 0.9rem; color: var(--theme-text-secondary); }
        .profile-meta-details p { margin-bottom: 0.3rem; }
        .profile-meta-details .font-orbitron { color: var(--theme-text-primary); }
        .profile-content-area { margin-top: 1.5rem; padding: 1rem; }
        .profile-section-title {
            font-family: 'Orbitron', sans-serif; font-size: 1.5rem; color: var(--theme-accent-secondary);
            margin-top: 2rem; margin-bottom: 1rem; padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--theme-glass-border);
            /* padding: 1rem; */ /* Removed redundant padding here */
        }
        .profile-progress-list li, .profile-achievements-grid > .achievement-card {
            background: var(--theme-bg-tertiary); padding: 1rem; border-radius: 0.5rem;
            border: 1px solid var(--theme-glass-border); margin-bottom: 0.75rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .profile-progress-list li:hover, .profile-achievements-grid > .achievement-card:hover {
            transform: translateX(5px); box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .achievement-card {
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
         .achievement-card:hover {
            transform: translateY(-4px) scale(1.03);
            background-color: var(--theme-bg-secondary);
            box-shadow: 0 5px 15px var(--theme-accent-glow);
        }
        .achievement-card .achievement-icon { font-size: 2.5rem; margin-bottom: 0.5rem; color: var(--theme-accent-primary); transition: transform 0.3s ease; }
        .achievement-card:hover .achievement-icon { transform: scale(1.2) rotate(5deg); }
        .achievement-card .achievement-title { font-size: 0.9rem; font-weight: 500; color: var(--theme-text-primary); }
        .achievement-card .achievement-date { font-size: 0.75rem; color: var(--theme-text-secondary); }

        .memberships-table-container { overflow-x: auto; margin-top: 1.5rem; }
        .memberships-table { min-width: 100%; border-collapse: collapse; }
        .memberships-table th, .memberships-table td {
            padding: 0.75rem 1rem; text-align: left;
            border-bottom: 1px solid var(--theme-glass-border); font-size: 0.9rem;
            transition: background-color 0.2s ease;
        }
        .memberships-table th { font-family: 'Orbitron', sans-serif; color: var(--theme-accent-primary); background-color: var(--theme-bg-tertiary); }
        .memberships-table tbody tr:hover td { background-color: var(--theme-bg-secondary); }
        .memberships-table td.text-center { text-align: center; }
        .memberships-table .icon-check { color: var(--calypso-success); }
        .memberships-table .icon-limited { color: var(--calypso-warning); }
        .memberships-table .icon-cross { color: var(--calypso-error); }

        .calypso-footer {
          background: var(--theme-bg-tertiary); color: var(--theme-text-secondary);
          text-align: center; padding: 1.5rem 1rem; font-size: .9rem;
          border-top: 1.5px solid var(--theme-glass-border); letter-spacing: 0.02em;
          margin-top: auto;
          transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .calypso-footer a { color: var(--theme-accent-primary); text-decoration: none; font-weight: 500; transition: color 0.2s ease; }
        .calypso-footer a:hover { color: var(--theme-accent-secondary); text-decoration: underline; }
        .footer-links-container {
            margin-top: 0.75rem; padding-top: 0.75rem;
            border-top: 1px solid var(--theme-glass-border);
            font-size: 0.8rem;
            display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem 1rem;
        }

        #caly-chat-widget-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        #caly-widget {
            width: 300px; border-radius: 0.8rem; overflow: hidden;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            border: 1px solid var(--theme-glass-border);
            max-height: 50px; /* Initial collapsed height */
            transition: max-height 0.3s ease-in-out, box-shadow 0.3s ease;
        }
        #caly-widget.open { max-height: 400px; /* Expanded height */ }

        #caly-header {
            background: linear-gradient(135deg, var(--theme-accent-primary), var(--theme-accent-secondary));
            color: var(--theme-bg-primary); padding: 0.75rem 1rem;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; font-family: 'Orbitron', sans-serif;
        }
        #caly-header h3 { font-size: 1rem; font-weight: 700; }
        #caly-toggle-icon { transition: transform 0.3s ease-in-out; display: inline-block; }
        #caly-widget.open #caly-toggle-icon { transform: rotate(180deg); }

        #caly-body {
            background-color: var(--theme-bg-secondary); padding: 1rem;
            height: 0; opacity: 0; overflow: hidden;
            transition: height 0.3s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease-in-out;
        }
        #caly-widget.open #caly-body {
            height: auto; opacity: 1; padding: 1rem; 
        }
        #caly-messages { height: 200px; overflow-y: auto; margin-bottom: 0.75rem; padding-right: 5px; }
        #caly-messages div {
            padding: 0.5rem 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem;
            font-size: 0.85rem; max-width: 85%; word-wrap: break-word;
            opacity: 0; transform: translateY(10px);
            animation: slideInMessage 0.3s ease-out forwards;
        }
        @keyframes slideInMessage { to { opacity: 1; transform: translateY(0); } }

        #caly-messages .user-message { background-color: var(--theme-accent-primary); color: var(--theme-bg-primary); margin-left: auto; text-align: right; }
        #caly-messages .caly-response { background-color: var(--theme-bg-tertiary); color: var(--theme-text-primary); margin-right: auto; }
        #caly-input-area { display: flex; }
        #caly-input { flex-grow: 1; border-right: none; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        #caly-send { border-top-left-radius: 0; border-bottom-left-radius: 0; padding: 0 1rem; }

        .text-center { text-align: center; }
        .mb-1 { margin-bottom: 0.25rem; } .mb-2 { margin-bottom: 0.5rem; } .mb-3 { margin-bottom: 0.75rem; } .mb-4 { margin-bottom: 1rem; } .mb-6 { margin-bottom: 1.5rem; } .mb-8 { margin-bottom: 2rem; }
        .mt-1 { margin-top: 0.25rem; } .mt-2 { margin-top: 0.5rem; } .mt-4 { margin-top: 1rem; } .mt-6 { margin-top: 1.5rem; }
        .grid { display: grid; } .gap-6 { gap: 1.5rem; }
        .md\:grid-cols-2 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .lg\:grid-cols-3 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        @media (min-width: 768px) { .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); } .lg\:grid-cols-3 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        .hidden { display: none !important; }

        #calypso-sidebar {
          position: fixed; left: calc(-1 * var(--sidebar-width)); top: 0;
          width: var(--sidebar-width); height: 100vh;
          background-color: var(--theme-bg-secondary);
          border-right: 1px solid var(--theme-glass-border);
          box-shadow: 2px 0 15px rgba(0,0,0,0.3);
          padding: 1.5rem 0; overflow-y: auto; z-index: 1001;
          transition: left 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94), background-color 0.3s ease, border-color 0.3s ease;
          display: flex; flex-direction: column;
        }
        #calypso-sidebar.open { left: 0; }
        .sidebar-close-btn {
            position: absolute; top: 10px; right: 10px; background: none; border: none;
            color: var(--theme-accent-primary); font-size: 1.8rem; cursor: pointer;
            padding: 0.3rem; line-height: 1; border-radius: 50%;
            transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease;
        }
        .sidebar-close-btn:hover { color: var(--theme-accent-secondary); background-color: var(--theme-glass-bg); transform: rotate(90deg) scale(1.1); }
        .sidebar-section { padding: 0 1.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--theme-glass-border); padding-bottom: 1.5rem; transition: border-color 0.3s ease; }
        .sidebar-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
        .sidebar-section-title {
            font-family: 'Orbitron', sans-serif; font-size: 1.1rem; color: var(--theme-accent-primary);
            margin-bottom: 1rem; display: flex; align-items: center; transition: color 0.3s ease;
        }
        .sidebar-section-title svg { margin-right: 0.75rem; width: 22px; height: 22px; fill: var(--theme-accent-primary); transition: fill 0.3s ease; }
        .sidebar-profile-info { text-align: center; }
        .sidebar-profile-info img {
            width: 80px; height: 80px; border-radius: 50%;
            border: 3px solid var(--theme-accent-secondary); margin-bottom: 0.5rem; object-fit: cover;
            box-shadow: 0 0 10px var(--theme-accent-glow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .sidebar-profile-info img:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--theme-accent-secondary); }
        .sidebar-profile-info h4 { font-size: 1.1rem; color: var(--theme-text-primary); margin-bottom: 0.2rem; }
        .sidebar-profile-info p { font-size: 0.8rem; color: var(--theme-text-secondary); }
        .sidebar-kpis { margin-top: 1rem; font-size: 0.9rem; }
        .sidebar-kpis div { margin-bottom: 0.5rem; display: flex; justify-content: space-between; }
        .sidebar-kpis span:first-child { color: var(--theme-text-secondary); }
        .sidebar-kpis span:last-child { color: var(--theme-text-primary); font-weight: 500; }
        .sidebar-progress-bar-container { background-color: var(--theme-bg-tertiary); border-radius: 5px; height: 10px; overflow: hidden; margin-top:0.2rem; }
        .sidebar-progress-bar { background-color: var(--theme-accent-primary); height: 100%; width: 0%; border-radius: 5px; transition: width 0.5s ease, background-color 0.3s ease; }

        .sidebar-module-list, .sidebar-resource-list { list-style: none; padding: 0; }
        .sidebar-module-list li a, .sidebar-resource-list li a {
            display: block; padding: 0.6rem 0.2rem; 
            color: var(--theme-text-secondary); text-decoration: none; font-size: 0.9rem;
            border-radius: 0.3rem;
            transition: color 0.2s ease, background-color 0.2s ease, padding-left 0.2s ease, transform 0.2s ease;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .sidebar-module-list li a:hover, .sidebar-resource-list li a:hover {
            color: var(--theme-accent-primary); background-color: var(--theme-bg-tertiary);
            padding-left: 0.7rem; transform: translateX(3px);
        }
        .sidebar-module-list li a.active-module-link {
            color: var(--theme-accent-primary); font-weight: bold;
            background-color: var(--theme-accent-glow); padding-left: 0.7rem;
        }
        .sidebar-module-item { display: flex; justify-content: space-between; align-items: center; }
        .sidebar-main-module-link { flex-grow: 1; padding: 0.6rem 0.2rem; }
        .lesson-toggle-btn {
            background: none; border: none; color: var(--theme-text-secondary);
            cursor: pointer; padding: 0.6rem 0.5rem; font-size: 0.8rem; margin-left: 5px;
            transition: color 0.2s ease, transform 0.25s ease-in-out;
        }
        .lesson-toggle-btn:hover { color: var(--theme-accent-primary); }
        .lesson-toggle-btn[aria-expanded="true"] { transform: rotate(180deg); color: var(--theme-accent-primary); }

        .sidebar-lesson-list {
            list-style: none; padding-left: 1.5rem; margin-top: 0.3rem; margin-bottom: 0.5rem;
            border-left: 1px solid var(--theme-glass-border);
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; opacity: 0;
        }
        .sidebar-lesson-list.expanded {
            max-height: 500px; /* Adjust as needed */
            opacity: 1;
        }
        .sidebar-lesson-list li a.sidebar-lesson-link { font-size: 0.85rem; color: var(--theme-text-secondary); padding: 0.4rem 0; }
        .sidebar-lesson-list li a.sidebar-lesson-link:hover { color: var(--theme-accent-secondary); background-color: transparent; padding-left: 0.2rem; }

        .mobile-nav-toggle { display: none; }
        @media (max-width: 960px) {
          .calypso-nav {
            display: none; flex-direction: column; position: absolute;
            top: 100%; right: 0; width: 250px;
            background-color: var(--theme-bg-tertiary);
            box-shadow: -5px 5px 15px rgba(0,0,0,0.25); z-index: 998;
            border-left: 1px solid var(--theme-glass-border);
            border-bottom: 1px solid var(--theme-glass-border);
            border-radius: 0 0 0 0.5rem;
            max-height: 0; overflow: hidden; opacity: 0;
            transition: max-height 0.3s ease-in-out, opacity 0.2s ease-in-out;
          }
          .calypso-nav.open { display: flex; max-height: 500px; opacity: 1; }
          .calypso-nav a, .calypso-nav button.btn-nav { width: 100%; margin-left: 0; text-align: left; padding: 0.8rem 1rem; border-bottom: 1px solid var(--theme-glass-border); border-radius: 0;}
          .calypso-nav a:last-child, .calypso-nav button.btn-nav:last-child { border-bottom: none; }
          .mobile-nav-toggle { display: block; }
        }
        @media (max-width: 480px) {
            .calypso-header .logo { font-size: 1.2rem; }
             .calypso-header img { height: 2em; }
            .sidebar-toggle, .mobile-nav-toggle, .theme-toggle-btn { font-size: 1.5rem; margin-right: 0.5rem;}
            main#app-root { padding: 1.5rem 1rem; }
            .view-title {font-size: 2rem;}
            .view-subtitle {font-size: 1rem;}
        }

        #dynamic_island_section .glass {
            transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease, transform 0.3s ease;
        }
        #dynamic_island_section .glass:hover { transform: scale(1.01); }
        #dynamic_island_section .glass.di-success { background-color: rgba(0, 255, 127, 0.15); border-color: var(--theme-accent-primary); box-shadow: 0 0 25px rgba(0, 255, 127, 0.3); }
        #dynamic_island_section .glass.di-info { background-color: rgba(22, 170, 255, 0.1); border-color: #16aaff88; box-shadow: 0 0 20px rgba(22, 170, 255, 0.25); }
        #dynamic_island_section .glass.di-warning { background-color: rgba(255, 215, 0, 0.1); border-color: #FFD70088; box-shadow: 0 0 20px rgba(255, 215, 0, 0.25); }

        .dynamic-island-content { font-size: 1rem; line-height: 1.7; opacity: 0; animation: fadeInContent 0.5s 0.2s ease-out forwards; padding: 1rem; }
        @keyframes fadeInContent { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .dynamic-island-content h3 { font-family: 'Orbitron', sans-serif; color: var(--theme-accent-primary); font-size: 1.3rem; margin-bottom: 0.75rem; }
        .dynamic-island-content p { margin-bottom: 0.5rem; color: var(--theme-text-primary); }
        .dynamic-island-content .di-highlight { color: var(--theme-accent-secondary); font-weight: bold; }

        .lessons-container ul { list-style: none; padding-left: 0; }
        .lesson-list-item { margin-bottom: 1rem; }
        .lesson-list-item a { text-decoration: none; color: var(--theme-accent-secondary); transition: color 0.2s ease; }
        .lesson-list-item a:hover { color: var(--theme-accent-primary); text-decoration: underline; }
        .lesson-list-item.glass:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.2), 0 0 10px var(--theme-accent-glow); transform: translateX(4px); }

        #certificate-actions button { margin: 5px; }
        #qr-code-container { 
            margin-top: 15px; padding:10px; background: white; /* White background for QR code */
            display: inline-block; border-radius: 5px;
            /* Initially hidden, will be shown by JS before capture */
         }
        #qr-code-container img { display: block; margin: auto; } /* If QRCode.js generates an img tag */
        #qr-code-container canvas { display: block; margin: auto; } /* If QRCode.js generates a canvas */


        /* Loader Styles */
        .calypso-loader-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 3rem 1rem; text-align: center; min-height: 200px;
            color: var(--theme-text-secondary);
        }
        .calypso-loader {
            border: 4px solid var(--theme-glass-border);
            border-top: 4px solid var(--theme-accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        .calypso-loader-container p { font-size: 0.9rem; }

        .philosophy-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            max-width: 1200px; 
            margin: 0 auto;
        }

        .philosophy-card {
          padding: 1.5rem; 
          display: flex;
          flex-direction: column;
          height: 100%; 
          transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .philosophy-card:hover {
          transform: translateY(-5px) scale(1.01);
          box-shadow: 0 8px 25px var(--theme-accent-glow); 
        }

        .philosophy-card-header {
          display: flex;
          align-items: center;
          margin-bottom: 1rem;
        }

        .philosophy-card-icon {
          font-size: 2rem; 
          margin-right: 0.75rem;
          color: var(--theme-accent-primary);
          line-height: 1; 
        }

        .philosophy-card-title {
          font-family: 'Orbitron', sans-serif;
          font-size: 1.3rem;
          color: var(--theme-accent-secondary);
          font-weight: 700;
        }

        .philosophy-card p {
          color: var(--theme-text-secondary); 
          font-size: 0.95rem;
          line-height: 1.65;
          flex-grow: 1; 
        }
        .philosophy-card p strong {
            color: var(--theme-text-primary); 
        }

        dialog {
          background-color: var(--theme-bg-tertiary);
          color: var(--theme-text-primary);
          border: 1px solid var(--theme-glass-border);
          border-radius: 0.8rem;
          padding: 1.5rem;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          max-width: 500px;
          width: 90%;
          margin: auto;
        }

        dialog::backdrop {
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
        }
        dialog h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--theme-accent-primary);
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        dialog p, dialog li {
            font-size: 0.9rem;
            color: var(--theme-text-secondary);
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        dialog strong { color: var(--theme-text-primary); }
        dialog a { color: var(--theme-accent-secondary); text-decoration: none; }
        dialog a:hover { color: var(--theme-accent-primary); text-decoration: underline; }
        dialog button { margin-top: 1rem; }


        dialog input[type="email"],
        dialog input[type="password"],
        dialog input[type="text"] {
          background-color: var(--input-bg);
          border: 1px solid var(--input-border);
          color: var(--input-text-color);
          padding: 0.5rem; border-radius: 0.25rem; width: 100%;
        }

        dialog#resourceModal {
            max-width: 90vw; /* Use viewport width */
            width: 80%; /* Or a fixed max-width like 1000px */
            max-height: 90vh; /* Use viewport height */
            border-radius: 0.8rem;
            padding: 1rem; /* Reduced padding to maximize iframe space */
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        dialog#resourceModal iframe {
            display: block; /* Ensure it's a block element */
        }
        
        dialog#resourceModal::backdrop {
            background-color: rgba(0,0,0,0.65); /* Darker backdrop */
            backdrop-filter: blur(5px);
        }

        .infra-card { background: var(--glass-bg); border: 1px solid var(--glass-border); backdrop-filter: blur(12px); border-radius: 1.25rem; box-shadow: 0 4px 24px 0 var(--glass-shadow-1), 0 1.5px 4px var(--glass-shadow-2); padding: 1.5rem; min-height: 210px; display: flex; flex-direction: column;}
        .infra-card h4 { font-family: 'Orbitron', sans-serif; color: var(--neon-text-color); font-size: 1.1rem; margin-bottom: 0.5rem; }
        .infra-card p { font-size: 0.98rem; color: var(--theme-text-secondary); margin-bottom: 0.6rem; flex-grow: 1;} /* Adjusted text color for theme */
        .infra-card ul { list-style: disc inside; color: var(--theme-text-secondary); font-size: 0.88rem; margin-bottom: 0;} /* Adjusted text color */
        .lesson-content-wrapper {
            display: flex;
            flex-direction: column;
            gap: 2rem; /* Espacio entre las secciones de objetivos y recursos */
        }

        /* Estilos comunes para las secciones */
        .lesson-objectives, .lessons-container,
        .lesson-resources {
            padding: 0.5rem;
            border-radius: var(--border-radius-base);
            border: 1px solid var(--theme-border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .lesson-objectives h2,
        .lesson-resources h2 {
            font-size: 1.5rem; /* 24px si base es 16px */
            color: var(--theme-text-primary);
            margin-top: 0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem; /* Espacio entre el icono del título y el texto */
        }

        .lesson-objectives h2 .fas, /* Icono en el título */
        .lesson-resources h2 .fas {
            color: var(--theme-accent-primary);
            font-size: 1.25rem; /* Un poco más pequeño que el texto del título */
        }

        .lesson-objectives ul,
        .lesson-resources ul {
            list-style: none;
            padding-left: 0;
            margin-bottom: 0; /* Quita el margen inferior por defecto de las listas */
        }

        /* --- Estilos Específicos para Objetivos de la Lección --- */
        .lesson-objectives ul li {
            display: flex;
            align-items: flex-start; /* Alinea el icono con la primera línea de texto si el texto es largo */
            gap: 0.75rem; /* Espacio entre el icono y el texto del objetivo */
            padding: 0.5rem 0;
            color: var(--theme-text-primary);
            font-size: 1rem; /* 16px */
            line-height: 1.6;
        }

        .lesson-objectives ul li .fas.fa-check-circle { /* Icono de check */
            color: #28a745; /* Un color verde para éxito/completado */
            margin-top: 0.2em; /* Pequeño ajuste vertical para alinear mejor con el texto */
            font-size: 1.1rem;
        }

        /* --- Estilos Específicos para Recursos de la Lección --- */
        .lesson-resources ul li {
            margin-bottom: 1.5rem;
        }

        .lesson-resources ul li:last-child {
            margin-bottom: 0;
        }

        .lesson-resources ul li a {
            display: flex;
            margin: .2rem;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border: 1px solid var(--theme-border-color);
            border-radius: var(--border-radius-base);
            text-decoration: none;
            color: var(--theme-text-primary);
            transition: border-color 0.2s ease-in-out, transform 0.1s ease-out;
        }

        .lesson-resources ul li a:hover .fas,
        .lesson-resources ul li a:focus .fas,
        .lesson-resources ul li a:hover .resource-meta,
        .lesson-resources ul li a:focus .resource-meta {
            color: var(--theme-bg-primary); /* O blanco, para que contraste con el fondo accent */
        }

        .lesson-resources ul li a .fas { /* Icono del recurso */
            font-size: 1.2rem;
            color: var(--theme-accent-primary);
            flex-shrink: 0; /* Evita que el icono se encoja */
            width: 20px; /* Ancho fijo para alineación */
            text-align: center;
        }

        .lesson-resources ul li a .resource-name {
            flex-grow: 1; /* Hace que el nombre ocupe el espacio disponible */
            font-weight: 500;
        }

        .lesson-resources ul li a .resource-meta {
            font-size: 0.875rem; /* 14px */
            color: var(--theme-text-secondary);
            white-space: nowrap; /* Evita que la meta información se parta en dos líneas */
            margin-left: auto; /* Empuja la meta información a la derecha si hay espacio */
            padding-left: 0.5rem; /* Un pequeño espacio si está justo al lado del nombre */
        }

        /* Ajustes para pantallas más pequeñas (opcional) */
        @media (max-width: 768px) {
            .lesson-objectives h2,
            .lesson-resources h2 {
                font-size: 1.3rem;
            }

            .lesson-resources ul li a {
                padding: 0.6rem 0.8rem;
                /* Podrías querer que resource-meta vaya abajo en móviles */
                /* flex-wrap: wrap; */
            }

        }
        .lesson-challenge {
            padding: 1.5rem;
            border-radius: var(--border-radius-base);
            border: 1px solid var(--theme-border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            /* Podrías darle un borde de acento para distinguirlo más */
            border-left: 5px solid var(--theme-accent-primary); 
            /* padding-left: calc(1.5rem - 5px); */
            margin-bottom: 1.5rem;
        }

        .lesson-challenge h2 { /* Título principal de la sección */
            font-size: 1.5rem;
            color: var(--theme-text-primary);
            margin-top: 0;
            margin-bottom: 1.5rem; /* Más espacio después del título principal */
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .lesson-challenge h2 .fas { /* Icono en el título principal */
            color: var(--theme-accent-primary);
            font-size: 1.25rem;
        }

        .lesson-challenge .challenge-description,
        .lesson-challenge .challenge-criteria,
        .lesson-challenge .challenge-submission {
            margin-bottom: 1.5rem; /* Espacio entre las subsecciones del desafío */
        }

        .lesson-challenge .challenge-description:last-child,
        .lesson-challenge .challenge-criteria:last-child,
        .lesson-challenge .challenge-submission:last-child {
            margin-bottom: 0;
        }

        .lesson-challenge h3 { /* Títulos de las subsecciones (Criterios, Entrega) */
            font-size: 1.2rem; /* 19-20px */
            color: var(--theme-text-primary);
            margin-top: 0;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .lesson-challenge h3 .fas { /* Iconos en los títulos de subsección */
            color: var(--theme-text-secondary); /* Un color más sutil para estos iconos */
            font-size: 1rem;
        }

        .lesson-challenge p {
            line-height: 1.6;
            color: var(--theme-text-secondary);
            margin-bottom: 0.75rem;
        }
        .lesson-challenge .challenge-description p:last-child {
            margin-bottom: 0;
        }

        .lesson-challenge .challenge-description strong {
            color: var(--theme-text-primary);
            font-weight: 600;
        }

        .lesson-challenge .challenge-criteria ul {
            list-style: none;
            padding-left: 0;
            margin-bottom: 0;
        }

        .lesson-challenge .challenge-criteria ul li {
            display: flex;
            align-items: flex-start;
            gap: 0.6rem;
            padding: 0.3rem 0;
            color: var(--theme-text-secondary);
            font-size: 0.95rem; /* Ligeramente más pequeño */
        }

        .lesson-challenge .challenge-criteria ul li .fas.fa-check { /* Icono de check para criterios */
            color: var(--theme-accent-primary); /* O un color verde como #28a745 */
            margin-top: 0.2em;
            font-size: 1rem;
        }

        .lesson-challenge .challenge-submission .btn-submit-challenge {
            display: inline-flex; /* Para alinear icono y texto */
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            font-size: 1rem;
            font-weight: 500;
            text-decoration: none;
            color: #fff; /* Asumiendo que btn-primary tiene fondo oscuro */
            background-color: var(--theme-accent-primary);
            border: 1px solid var(--theme-accent-primary);
            border-radius: var(--border-radius-base);
            transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
            cursor: pointer;
            margin-bottom: 0.75rem; /* Espacio antes de la fecha límite */
        }

        .lesson-challenge .challenge-submission .btn-submit-challenge:hover,
        .lesson-challenge .challenge-submission .btn-submit-challenge:focus {
            background-color: #0056b3; /* Un tono más oscuro del accent-primary para hover */
            border-color: #0056b3;
            transform: translateY(-1px);
        }
        .lesson-challenge .challenge-submission .btn-submit-challenge .fas {
            font-size: 0.9rem;
        }

        .lesson-challenge .challenge-submission .challenge-deadline {
            font-size: 0.9rem;
            color: var(--theme-text-secondary);
            margin-top: 0.5rem; /* Espacio después del botón */
        }

        .lesson-challenge .challenge-submission .challenge-deadline strong {
            color: var(--theme-text-primary);
        }
        .lesson-prerequisites {
            padding: 1.5rem;
            border-radius: var(--border-radius-base);
            border: 1px solid var(--theme-border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03); /* Sombra más sutil */
        }

        .lesson-prerequisites h2 {
            font-size: 1.5rem;
            color: var(--theme-text-primary);
            margin-top: 0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .lesson-prerequisites h2 .fas {
            color: var(--theme-accent-primary);
            font-size: 1.25rem;
        }

        .lesson-prerequisites p {
            line-height: 1.6;
            color: var(--theme-text-secondary);
            margin-bottom: 1rem;
        }

        .lesson-prerequisites ul {
            list-style: none;
            padding-left: 0;
            margin-bottom: 1.5rem; /* Espacio antes de la nota final */
        }

        .lesson-prerequisites ul li {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.25rem; /* Padding vertical y un poco horizontal */
            color: var(--theme-text-primary);
            font-size: 1rem;
            border-bottom: 1px dashed var(--theme-border-color); /* Separador sutil */
        }

        .lesson-prerequisites ul li:last-child {
            border-bottom: none;
        }

        .lesson-prerequisites ul li .fas { /* Icono del prerrequisito */
            color: var(--theme-accent-primary);
            font-size: 1.1rem;
            width: 20px; /* Ancho fijo para alineación */
            text-align: center;
            flex-shrink: 0;
        }

        .lesson-prerequisites ul li a {
            text-decoration: none;
            color: var(--theme-accent-primary);
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .lesson-prerequisites ul li a:hover {
            color: #0056b3; /* Un tono más oscuro del accent */
            text-decoration: underline;
        }

        .lesson-prerequisites .prerequisites-note {
            font-size: 0.9rem;
            font-style: italic;
            color: var(--theme-text-secondary);
            text-align: center;
            margin-top: 1rem;
            margin-bottom: 0;
            padding-top: 1rem;
            border-top: 1px solid var(--theme-border-color);
        }

        /* --- Estilos Específicos para Soporte Calypso Labs --- */
        .lesson-caly-support, {
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            background-color: rgba(0, 255, 127, 0.15); border-color: var(--theme-accent-primary); 
            box-shadow: 0 0 25px rgba(0, 255, 127, 0.3);
            margin-bottom: 1.5rem;
        }

        .lesson-list-item {
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
          background-color: rgba(0, 255, 127, 0.15); border-color: var(--theme-accent-primary); 
          box-shadow: 0 0 25px rgba(0, 255, 127, 0.3);
          margin-bottom: 1.5rem;
          padding: 1.5rem;
          margin-top: 1.5rem;
        }

        .lesson-caly-support h2 {
            font-size: 1.5rem;
            color: var(--theme-text-primary);
            margin-top: 0;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .lesson-caly-support h2 .fas.fa-headset {
            color: var(--theme-accent-primary);
            font-size: 1.35rem; /* Un poco más grande el icono principal de soporte */
        }

        .lesson-caly-support .support-channel {
            display: flex;
            align-items: flex-start; /* Alinear icono con la parte superior del texto */
            gap: 1.25rem; /* Espacio entre el icono grande y el bloque de texto */
            padding: 1rem 0;
            border-bottom: 1px solid var(--theme-border-color);
        }

        .lesson-caly-support .support-channel:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .lesson-caly-support .support-channel:first-of-type {
            padding-top: 0;
        }


        .lesson-caly-support .support-channel > .fas, /* Icono grande del canal */
        .lesson-caly-support .support-channel > .fab { /* Para iconos de marca como Discord */
            font-size: 2.5rem; /* Iconos grandes y llamativos */
            color: var(--theme-accent-primary);
            margin-top: 0.25rem; /* Pequeño ajuste vertical */
            flex-shrink: 0;
            width: 40px; /* Ancho para el icono */
            text-align: center;
        }

        .lesson-caly-support .support-channel div { /* Contenedor para h3 y p */
            flex-grow: 1;
        }

        .lesson-caly-support .support-channel h3 {
            font-size: 1.15rem;
            color: var(--theme-text-primary);
            margin-top: 0;
            margin-bottom: 0.35rem;
            font-weight: 600;
        }

        .lesson-caly-support .support-channel p {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--theme-text-secondary);
            margin-bottom: 0;
        }

        .lesson-caly-support .support-channel p a {
            color: var(--theme-accent-primary);
            text-decoration: none;
            font-weight: 500;
        }

        .lesson-caly-support .support-channel p a:hover {
            text-decoration: underline;
            color: #0056b3; /* Un tono más oscuro del accent */
        }

    </style>
</head>
<body>
    <div class="app-wrapper">
        <aside id="calypso-sidebar">
            <button class="sidebar-close-btn" id="sidebar-close-btn" aria-label="Cerrar menú">✖</button>
            <div id="sidebar-content">
                <!-- Content generated by JS -->
            </div>
        </aside>

        <div class="app-container">
            <header class="calypso-header">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebar-toggle-btn" aria-label="Abrir menú lateral">☰</button>
                    <img src="https://store.calypsolabs.com.mx/assets/images/CalypsoLabs_Logo.svg" 
                         alt="Calypso Labs Logo">
                    <a href="#/" class="logo">| Academy</a>
                </div>
                <nav class="calypso-nav" id="main-nav">
                    <a href="#/" data-navlink>Inicio</a>
                    <a href="#/curso" data-navlink>Academia</a>
                    <a href="#/membresias" data-navlink>Membresías</a>
                    <a href="#/perfil" data-navlink id="nav-perfil" class="hidden">Mi Perfil</a>
                    <button id="nav-login" data-navlink class="btn-nav">Iniciar Sesión</button>
                    <button id="nav-register" data-navlink class="btn-nav">Registrarse</button>
                    <button id="nav-logout" class="btn-nav btn-nav-logout hidden">⍈</button>
                </nav>
                 <button class="theme-toggle-btn" id="theme-toggle-btn" aria-label="Cambiar tema">☼</button>
                 <button class="mobile-nav-toggle" id="mobile-nav-toggle-btn" aria-label="Abrir navegación">👤</button>
            </header>

            <main id="app-root">
                <!-- Content injected by router -->
            </main>

            <footer class="calypso-footer">
                © <span id="current-year"></span> <a href="https://www.calypsolabs.com.mx" target="_blank" rel="noopener noreferrer">Calypso Labs</a>. Todos los derechos reservados.
                <div class="footer-links-container">
                  <a href="#aviso-privacidad" onclick="document.getElementById('avisoPrivacidad').showModal();return false;">Aviso de Privacidad</a>
                  <a href="#terminos-condiciones" onclick="document.getElementById('terminosCondiciones').showModal();return false;">Términos y Condiciones</a>
                  <a href="#politica-cookies" onclick="document.getElementById('politicaCookies').showModal();return false;">Política de Cookies</a>
                  <a href="https://www.calypsolabs.com.mx/#recursos" target="_blank" rel="noopener noreferrer">Recursos Calypso</a>
                </div>
            </footer>
        </div>
    </div>

    <div id="caly-chat-widget-container">
        <!-- Chat widget injected by JS -->
    </div>

    <dialog id="avisoPrivacidad">
      <h2>Aviso de Privacidad</h2>
      <p><strong>Responsable:</strong> Calypso Labs (Ivan Carvajal Ruiz), con domicilio en Ciudad de México.</p>
      <p><strong>Finalidad:</strong> Los datos personales recabados serán utilizados exclusivamente para gestionar su participación en cursos, contacto, consultas o acceso a los servicios ofrecidos en Calypso Labs Academy.</p>
      <p><strong>Derechos ARCO:</strong> Usted puede ejercer sus derechos de acceso, rectificación, cancelación u oposición (ARCO) enviando un correo electrónico a <a href="mailto:hola@calypsolabs.com.mx">hola@calypsolabs.com.mx</a>.</p>
      <p><strong>Transferencias:</strong> Sus datos personales no serán transferidos a terceros sin su consentimiento, salvo las excepciones previstas por la ley.</p>
      <p>Para más información, puede solicitar el aviso de privacidad integral a través del correo electrónico proporcionado.</p>
      <button onclick="document.getElementById('avisoPrivacidad').close()" class="btn btn-secondary">Cerrar</button>
    </dialog>

    <dialog id="terminosCondiciones">
      <h2>Términos y Condiciones</h2>
      <p>Bienvenido a Calypso Labs Academy. Al acceder y utilizar este sitio web, usted acepta estar sujeto a los siguientes términos y condiciones:</p>
      <ul>
        <li>El contenido y los recursos proporcionados son para fines educativos y de consulta. La reproducción total o parcial sin autorización previa de Calypso Labs está prohibida.</li>
        <li>El usuario se compromete a utilizar el sitio y sus servicios de manera ética, legal y respetuosa, sin realizar actividades que puedan dañar la plataforma o a otros usuarios.</li>
        <li>Calypso Labs se reserva el derecho de modificar estos términos y condiciones en cualquier momento. Las modificaciones entrarán en vigor inmediatamente después de su publicación en el sitio.</li>
        <li>Calypso Labs no se hace responsable por interrupciones del servicio o por la precisión absoluta de toda la información, aunque se esfuerza por mantenerla actualizada y correcta.</li>
        <li>El acceso a ciertas herramientas y recursos puede estar condicionado a la finalización de módulos o al cumplimiento de requisitos específicos, como se detalla en la plataforma.</li>
      </ul>
      <button onclick="document.getElementById('terminosCondiciones').close()" class="btn btn-secondary">Cerrar</button>
    </dialog>

    <dialog id="politicaCookies">
      <h2>Política de Cookies</h2>
      <p>Este sitio web, Calypso Labs Academy, utiliza cookies propias y de terceros para mejorar la experiencia del usuario, analizar la navegación y ofrecer funcionalidades personalizadas.</p>
      <p><strong>¿Qué son las cookies?</strong> Son pequeños archivos de texto que se almacenan en su dispositivo cuando visita un sitio web.</p>
      <p><strong>Tipos de cookies utilizadas:</strong></p>
      <ul>
        <li><strong>Cookies técnicas:</strong> Esenciales para el funcionamiento del sitio, como mantener la sesión de usuario.</li>
        <li><strong>Cookies de análisis:</strong> (Ej. Google Analytics) Nos permiten entender cómo los usuarios interactúan con el sitio para mejorarlo. Estas cookies recopilan información de forma anónima.</li>
        <li><strong>Cookies de personalización:</strong> Permiten recordar preferencias del usuario (como el tema oscuro/claro).</li>
      </ul>
      <p>Usted puede gestionar o desactivar las cookies a través de la configuración de su navegador. Sin embargo, desactivar ciertas cookies puede afectar la funcionalidad del sitio.</p>
      <p>Al continuar navegando en Calypso Labs Academy, usted acepta el uso de cookies conforme a esta política. No se recopila información personal sensible sin su consentimiento explícito a través de cookies.</p>
      <button onclick="document.getElementById('politicaCookies').close()" class="btn btn-secondary">Cerrar</button>
    </dialog>

    </dialog> <!-- This is the closing tag for politicaCookies -->

    <dialog id="resourceModal">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 id="resourceModalTitle" class="font-orbitron" style="color:var(--theme-accent-primary); font-size: 1.2rem; margin:0;">Cargando Recurso...</h2>
        <button onclick="closeResourceModal()" class="btn btn-secondary btn-sm">Cerrar</button>
      </div>
      <iframe id="resourceModalFrame" 
              src="about:blank" 
              style="width: 100%; height: 75vh; border: none; background-color: #fff;" 
              allowfullscreen>
              Tu navegador no soporta iframes.
      </iframe>
    </dialog>

    <script>        // --- Constants & Initial Data ---
        const GLOBAL_DEFAULT_THEME = {
            light: { '--theme-bg-primary': '#f0f2f5', '--theme-bg-secondary': '#ffffff', '--theme-bg-tertiary': '#e9ecef', '--theme-text-primary': '#212529', '--theme-text-secondary': '#495057', '--theme-accent-primary': '#007bff', '--theme-accent-secondary': '#0056b3', '--theme-accent-glow': 'rgba(0, 123, 255, 0.3)', '--theme-glass-bg': 'rgba(255, 255, 255, 0.8)', '--theme-glass-border': 'rgba(0, 123, 255, 0.25)', '--app-background-image': 'none', '--app-background-aurora': 'none' },
            dark: { '--theme-bg-primary': '#000000', '--theme-bg-secondary': '#1a1a1a', '--theme-bg-tertiary': '#2c2c2c', '--theme-text-primary': '#e0e0e0', '--theme-text-secondary': '#b0b0b0', '--theme-accent-primary': '#00FF7F', '--theme-accent-secondary': '#33FF99', '--theme-accent-glow': 'rgba(0, 255, 127, 0.5)', '--theme-glass-bg': 'rgba(25, 28, 32, 0.75)', '--theme-glass-border': 'rgba(0, 255, 127, 0.2)', '--app-background-image': 'none', '--app-background-aurora': 'radial-gradient(ellipse at top left, rgba(0, 255, 127, 0.08) 0%, transparent 50%), radial-gradient(ellipse at bottom right, rgba(0, 123, 255, 0.08) 0%, transparent 50%)'}
        };

        const CATEGORIES_DATA = [
            {
                id: "M1", order: 1, title: "Filosofía & Fundamentos Esenciales", icon_class: "💡",
                description: "Sumérgete en el vibrante pensamiento maker, la ética fundamental del open-hardware, la inspiradora historia de Calypso Labs y la visión transformadora detrás del proyecto CL-4i. Esta es tu puerta de entrada para unirte, contribuir y crecer exponencialmente dentro de la comunidad Calypso.",
                theme: { 
                  light: { '--theme-accent-primary': '#4CAF50', '--app-background-image': 'url("https://www.transparenttextures.com/patterns/project-paper.png")' },
                    dark: { '--theme-accent-primary': '#81C784', '--app-background-image': 'url("https://www.transparenttextures.com/patterns/project-paper.png")' }
                     },
                benefits: [
                    "Participación activa y privilegiada en la comunidad Calypso, con acceso exclusivo a canales de Discord y mentoría básica personalizada.",
                    "Acceso prioritario a eventos exclusivos, desafíos de ingeniería estimulantes y sorteos emocionantes (con premios como Jetson Nano, SSDs de alto rendimiento, horas de laboratorio gratuitas)."
                ],
                resources: [
                    { name: "Historia Detallada CL-4i (PDF Interactivo)", url: "#", type: "PDF" },
                    { name: "Manifiesto Open Hardware de Calypso Labs", url: "#", type: "PDF" },
                    { name: "Video: La Visión de Calypso Labs", url: "#", type: "video"}
                ]
            },
            {
                id: "M2", order: 2, title: "Diseño Electrónico y Esquemáticos Profesionales", icon_class: "⚡",
                description: "Domina los fundamentos cruciales de la electrónica aplicada, aprende a interpretar datasheets como un experto, utiliza simbología estándar internacional y diseña tus propios PCBs (Printed Circuit Boards) con herramientas líderes como KiCad y EasyEDA.",
                theme: { 
                    light: { '--theme-accent-primary': '#FF9800', '--app-background-image': 'url("https://www.transparenttextures.com/patterns/circuit-board.png")' },
                    dark: { '--theme-accent-primary': '#FFB74D', '--app-background-image': 'url("https://www.transparenttextures.com/patterns/circuit-board.png")' }
                     },
                benefits: [
                    "Acceso ilimitado a nuestro editor Gerber online avanzado, completamente gratuito y sin necesidad de registro previo.",
                    "Capacidad para cargar y visualizar tus diseños PCB de forma instantánea, facilitando la iteración y revisión.",
                    "Servicio de solicitud de maquila express para tus prototipos, acelerando tu ciclo de desarrollo."
                ],
                resources: [
                    { name: "Guía Práctica CAD/CAM Express (PDF)", url: "#", type: "PDF" },
                    { name: "Tutorial EasyEDA: De Cero a PCB (Video)", url: "#", type: "video"},
                    { name: "Editor Gerber Online (Ucamco)", url: "https://gerber-viewer.ucamco.com/", type: "tool" }
                ]
            },
            {
                id: "M3", order: 3, title: "Modelado e Impresión 3D: Diseño y Fabricación Digital", icon_class: "🧊", // Ícono cambiado
                description: "Domina el arte del modelado 3D para crear piezas funcionales y estéticas. Aprende los principios de diseño para la fabricación aditiva (DFAM), opera impresoras 3D FDM y SLA, y transforma tus ideas digitales en objetos físicos con precisión.",
                theme: {
                    light: { '--theme-accent-primary': '#795548', '--app-background-image': 'url("https://www.transparenttextures.com/patterns/cubes.png")' }, // Theme actualizado
                    dark: { '--theme-accent-primary': '#A1887F', '--app-background-image': 'url("https://www.transparenttextures.com/patterns/cubes.png")' }
                },
                benefits: [
                    "Capacidad para diseñar y modelar tus propias piezas y carcasas para proyectos electrónicos y robóticos.",
                    "Conocimiento práctico para operar y mantener impresoras 3D (FDM y SLA) disponibles en Calypso Labs.",
                    "Acceso a guías de selección de materiales y optimización de parámetros de impresión para resultados profesionales."
                ],
                resources: [
                    { name: "Guía de Introducción al Modelado 3D con Fusion 360 (PDF)", url: "#", type: "PDF" },
                    { name: "Principios de Diseño para Fabricación Aditiva (DFAM)", url: "#", type: "guide" },
                    { name: "Comparativa: Tecnologías de Impresión 3D FDM vs. SLA", url: "#", type: "article"},
                    { name: "Mantenimiento Básico de Impresoras 3D Calypso Labs (Video)", url:"#", type:"video"}
                ]
            },
            {
                id: "M4", order: 4, title: "Firmware, UART y Control Embebido Avanzado", icon_class: "💻",
                description: "Explora el fascinante mundo de los microcontroladores (ESP32, STM32, RP2040), programa eficientemente en C++/MicroPython, controla pines GPIO y periféricos (SPI, I2C, ADC), y domina la programación desde entornos de desarrollo integrados (IDEs) profesionales como VS Code con PlatformIO.",
                theme: { 
                    light: { '--theme-accent-primary': '#2196F3', '--app-background-image': 'url("https://www.transparenttextures.com/patterns/lined-paper.png")' },
                    dark: { '--theme-accent-primary': '#64B5F6', '--app-background-image': 'url("https://www.transparenttextures.com/patterns/lined-paper.png")' }
                     },
                benefits: [
                    "Descarga de ejemplos de código listos para usar y optimizados para tu ESP32, STM32 y otros MCUs populares.",
                    "Acceso beta a nuestra plataforma de simulación de firmware online para probar tu código antes de flashear.",
                    "Soporte interactivo de Caly IA para debugging asistido, optimización de código y explicación de conceptos de firmware."
                ],
                resources: [
                    { name: "Repositorio de Código CL-4i Firmware (GitHub)", url: "https://github.com/CalypsoLabsMX/CL-4i-Firmware", type: "repo" },
                    { name: "Firmware Ejemplo: Control de Motor DC con PWM (C++)", url: "#", type: "code" },
                    { name: "Guía: Configuración de PlatformIO para ESP32", url:"#", type:"guide"}
                ]
            },
            {
                id: "M5", order: 5, title: "Conectividad BLE, Wi-Fi y Provisioning Seguro", icon_class: "📡",
                description: "Implementa soluciones de comunicación inalámbrica robustas y seguras: configuración avanzada de Bluetooth Low Energy (BLE), perfiles GATT, conexión a redes Wi-Fi seguras (WPA2/3), WebSockets para comunicación en tiempo real y desarrollo de APIs RESTful (incluyendo un broker MQTT educativo/test para tus prácticas).",
                theme: { 
                  light: { '--theme-accent-primary': '#9C27B0', '--app-background-image': 'url("https://www.transparenttextures.com/patterns/wavecut.png")' },
                    dark: { '--theme-accent-primary': '#BA68C8', '--app-background-image': 'url("https://www.transparenttextures.com/patterns/wavecut.png")' }
                     },
                benefits: [
                    "Prueba nuestras APIs en modo educativo/test con cuotas generosas, ideales para experimentación y desarrollo.",
                    "Tutorial paso a paso para crear tu primer dashboard MQTT interactivo y visualizar datos de sensores en tiempo real.",
                    "Solicita créditos y recursos adicionales para tus proyectos escolares y universitarios destacados."
                ],
                resources: [
                    { name: "Documentación API MQTT Educativa Calypso", url: "https://docs.calypsolabs.com.mx/api/mqtt", type: "api" },
                    { name: "Ejemplo: Telemetría en Tiempo Real con ESP32 y WebSockets (MicroPython)", url: "#", type: "code" },
                    { name: "Guía: Seguridad en Comunicaciones IoT", url:"#", type:"PDF"}
                ]
            },
            {
                id: "M6", order: 6, title: "Autonomía, Simulación y Fundamentos de IA Embebida", icon_class: "🤖",
                description: "Introduce inteligencia y autonomía a tus proyectos: utiliza sensores IMU (Inertial Measurement Unit) y ToF (Time-of-Flight), crea mapas de proximidad, desarrolla lógica de navegación autónoma, simula el comportamiento de tus robots en entornos 3D realistas e integra modelos básicos de Inteligencia Artificial para toma de decisiones.",
                theme: { 
                    light: { '--theme-accent-primary': '#00BCD4', '--app-background-image': 'url("https://www.transparenttextures.com/patterns/ диаграммы.png")' },
                    dark: { '--theme-accent-primary': '#4DD0E1', '--app-background-image': 'url("https://www.transparenttextures.com/patterns/ диаграммы.png")' }
                },
                benefits: [
                    "Acceso a nuestro simulador online y visualizador 3D ClaySim para probar tus algoritmos de control y navegación.",
                    "Participa en el desafío mensual de navegación autónoma de Calypso Labs, con premios y reconocimientos para los mejores proyectos."
                ],
                resources: [
                    { name: "Simulador Clay 3D (ClaySim) - Acceso Beta", url: "https://calypsolabs.com.mx/claysim", type: "tool" },
                    { name: "Ejemplo: IA Básica para Navegación con Evasión de Obstáculos (Python)", url: "#", type: "code" },
                    { name: "Introducción a Modelos TinyML para Microcontroladores", url:"#", type:"PDF"}
                ]
            },
            {
                id: "M7", order: 7, title: "Proyecto Integrador: Dispositivo IoT Completo", icon_class: "🏆",
                description: "¡Es el momento de consolidar y brillar! Aplica todo el conocimiento y las habilidades adquiridas en Calypso Labs. Diseña, ensambla, programa y conecta un dispositivo IoT completamente funcional, desde el concepto inicial hasta la visualización de datos en la nube y la presentación de tu proyecto.",
                theme: {
                    light: { '--theme-accent-primary': '#795548', '--app-background-image': 'url("https://www.transparenttextures.com/patterns/project-paper.png")' },
                    dark: { '--theme-accent-primary': '#A1887F', '--app-background-image': 'url("https://www.transparenttextures.com/patterns/project-paper.png")' }
                },
                benefits: [
                    "Mentoría especializada y dedicada para guiarte a través de tu proyecto final.",
                    "Oportunidad de presentar tu proyecto innovador a la comunidad Calypso y a potenciales colaboradores o empleadores.",
                    "Obtención del prestigioso Certificado Especial de 'Calypso IoT Innovator' al completar con éxito tu proyecto."
                ],
                resources: [
                    { name: "Guía Completa de Planificación de Proyectos IoT (PDF)", url: "#", type: "PDF" },
                    { name: "Plantillas Profesionales de Documentación de Proyecto (Markdown, Google Docs)", url: "#", type: "template" },
                    { name: "Checklist de Presentación de Proyecto Final", url:"#", type:"guide"}
                ]
            }
        ];

        const LESSONS_DATA = [
        // ----- MÓDULO 1: Bienvenido a Calypso Labs y al Proyecto CL-4i -----
        {
          id: "L1-1", moduleId: "M1", order: 1, title: "La Visión de Calypso Labs y el Nacimiento del CL-4i",
          description: "Descubre la historia inspiradora de Calypso Labs, el legado de su fundador Ing. Pedro Carvajal Lozano, y cómo su visión impulsa el proyecto CL-4i 'Clay'. Entiende la filosofía 'maker' y de open-hardware que nos define.",
          objectives: [
            "Comprender la misión, visión y filosofía de Calypso Labs.",
            "Conocer la historia y motivación detrás del proyecto CL-4i 'Clay'.",
            "Identificar los principios de open-hardware y colaboración en Calypso Labs."
          ],
          difficulty: "Fácil", duration_min: 30, prerequisites: [],
          resources_json: {
            docs: [
              { name: "Documento: La Semilla de Calypso Labs (Historia y Fundador)", url: "https://academy.calypsolabs.com.mx/docs/PDF/Calypso_seed.pdf", type: "pdf" },
              { name: "Manifiesto Open Hardware de Calypso Labs", url: "#", type: "pdf" },
              { name: "Presentación: ¿Qué es el CL-4i 'Clay'?", url: "#", type: "slide" }
            ],
            videos: [{ name: "Video: La Visión de Iván Carvajal para Calypso Labs", url: "#", type: "video" }]
          }, 
          evaluation: {
            type: "auto",
            questions: [
              { q: "¿En honor a quién toma su nombre Calypso Labs?", o: ["Un famoso científico", "El primer servidor de la familia Carvajal, llamado 'Calypso'", "Un personaje de la mitología griega"], a: 1 },
              { q: "¿Cuál es el objetivo principal del proyecto CL-4i 'Clay'?", o: ["Ser un producto comercial cerrado", "Ser una plataforma educativa abierta para el aprendizaje en ingeniería aplicada", "Competir en carreras de drones"], a: 1 },
              { q: "La filosofía de Calypso Labs se basa en la unión de 'Tradición e ...'", o: ["Economía", "Innovación", "Velocidad"], a: 1 }
            ],
            passing_score: 80,
            unlocks: ["badge:filosofia_calypso_entendida"]
          }
        },
        {
          id: "L1-2", moduleId: "M1", order: 2, title: "Infraestructura de Calypso Labs: Tu Laboratorio Maker",
          description: "Realiza un recorrido por las estaciones de trabajo y equipamiento de Calypso Labs (Data Center, Soldadura, Pruebas, Impresión 3D, Fresado CNC, SMD, Code_zone). Aprende qué herramientas están disponibles y cómo puedes acceder a ellas.",
          objectives: [
            "Identificar las principales áreas y equipamiento especializado de Calypso Labs.",
            "Comprender las capacidades de cada estación de trabajo.",
            "Conocer los procedimientos básicos para el uso seguro de la infraestructura del laboratorio (teórico)."
          ],
          difficulty: "Fácil", duration_min: 25, prerequisites: ["L1-1"],
          resources_json: {
            docs: [{ name: "Guía Detallada: Infraestructura y Estaciones de Calypso Labs", url: "#", type: "pdf" }],
            images: [{ name: "Galería Fotográfica: Equipamiento de Calypso Labs", url: "#", type: "gallery" }],
            videos: [{ name: "Video Tour: Estaciones de Trabajo en Calypso Labs", url: "#", type: "video" }]
          },
          evaluation: {
            type: "auto",
            questions: [
              { q: "¿Qué tipo de impresoras 3D se mencionan en la infraestructura de Calypso Labs?", o: ["Solo FDM", "Solo SLA", "Tanto de Filamento (FDM) como de Resina (SLA)"], a: 2 },
              { q: "El 'Code_zone' es un espacio dedicado principalmente a:", o: ["Ensamblaje mecánico", "Pruebas de vuelo de drones", "Programación y desarrollo de sistemas embebidos"], a: 2 }
            ],
            passing_score: 75,
            unlocks: ["badge:conocedor_infraestructura_calypso"]
          }
        },

        // ----- MÓDULO 2: Diseño Electrónico del CL-4i -----
        {
          id: "L2-1", moduleId: "M2", order: 1, title: "Interpretación de Datasheets para el CL-4i",
          description: "Aprende a leer y entender los datasheets de los componentes clave del CL-4i, como el ESP32-S3, el sensor ToF VL53L5CX, y la IMU ICM-20948. Extrae especificaciones críticas para el diseño.",
          objectives: [
            "Identificar las secciones clave de un datasheet (Absolute Maximum Ratings, Electrical Characteristics, Pinout).",
            "Extraer voltajes de operación, corrientes, y timings importantes de los datasheets de los componentes del CL-4i.",
            "Tomar decisiones informadas sobre la interconexión de componentes basadas en sus datasheets."
          ],
          difficulty: "Intermedia", duration_min: 40, prerequisites: [],
          resources_json: {
            docs: [{ name: "Guía Práctica: Cómo Disecar un Datasheet", url: "#", type: "pdf" }],
            datasheets_specific: [
              { name: "Datasheet: ESP32-S3 (Microcontrolador Principal CL-4i)", url: "#", type: "datasheet" },
              { name: "Datasheet: VL53L5CX (Sensor ToF CL-4i)", url: "#", type: "datasheet" },
              { name: "Datasheet: ICM-20948 (IMU CL-4i)", url: "#", type: "datasheet" }
            ]
          },
          challenge: "Del datasheet del ESP32-S3, identifica el rango de voltaje de alimentación recomendado y la corriente máxima que puede suministrar un pin GPIO.",
          evaluation: {
            type: "auto",
            questions: [
              { q: "La sección 'Absolute Maximum Ratings' en un datasheet indica:", o: ["Las condiciones óptimas de funcionamiento.", "Los límites que, si se exceden, pueden causar daño permanente al componente.", "Las características típicas del componente bajo prueba."], a: 1 },
              { q: "¿Qué información crucial encontrarías en la sección 'Pinout' o 'Pin Description' de un datasheet de microcontrolador?", o: ["El precio del componente.", "La función de cada pin (e.g., VCC, GND, GPIO, SPI_MOSI).", "La historia de fabricación del componente."], a: 1 }
            ],
            passing_score: 80,
            unlocks: ["badge:datasheet_interpreter_cl4i"]
          }
        },
        {
          id: "L2-2", moduleId: "M2", order: 2, title: "Introducción al Diseño CAD/CAM, Diseño del 'Cerebro' del CL-4i en Esquemático",
          description: "Aprende a crear esquemáticos. Coloca los símbolos MCU, sensores, conectores y el sistema de gestión de energía.",
          objectives: [
            "Utilizar una interfaz CAD/CAM (editor de esquemáticos) para crear un nuevo proyecto.",
            "Añadir y conectar símbolos de las librerías para los componentes del CL-4i Brain.",
            "Realizar la anotación de componentes y la verificación de reglas eléctricas (ERC)."
          ],
          difficulty: "Intermedia", duration_min: 70, prerequisites: ["L2-1"],
          resources_json: {
            tutorials: [{ name: "Tutorial: Creando Esquemáticos en CAD/CAM", url: "/PCBmkr.html", type: "pdf" }],
            cad_project_files: [
                { name: "Proyecto (Esquemático): CL-4i Brain Board (Plantilla Inicial)", url: "/PCBmkr.html", type: "tool_link" }
            ],
            docs: [{ name: "Lista de Componentes y Conexiones: CL-4i Brain Board", url: "#", type: "pdf" }]
          },
          challenge: "Completa el esquemático del CL-4i Brain Board, asegurando que todos los componentes principales (MCU, IMU´s, ToF´s, conectores de Pods, etc) estén correctamente interconectados. Ejecuta técnicas ERC y corrige los errores.",
          evaluation: {
            type: "mixed",
            questions: [
              { q: "¿Qué es el ERC?", o: ["Una herramienta para exportar archivos Gerber.", "Técnicas para verificar la conectividad lógica y eléctrica del esquemático.", "Una simulación del comportamiento del circuito."], a: 1}
            ],
            practical: { type: "cad_project_submission_service_request", description: "Sube tu proyecto CAD/CAM (solo el archivo .gbl / .gbr) para una revisión simulada de ERC y completitud en nuestros servidores.", file_type: ".zip, .gbr, .gbl" },
            passing_score: 75,
            unlocks: ["badge:cad_schematic_designer_cl4i"]
          }
        },
        {
          id: "L2-3", moduleId: "M2", order: 3, title: "Diseño de PCB para el 'Cerebro' del CL-4i en CAD/CAM",
          description: "Transforma el esquemático del 'Cerebro' del CL-4i en un diseño de PCB profesional. Aprende sobre la asignación de footprints, el layout de componentes, el ruteo de pistas, planos de tierra y la generación de Gerbers para maquila.",
          objectives: [
            "Asignar footprints correctos a todos los componentes del esquemático del CL-4i Brain.",
            "Realizar un layout eficiente de los componentes, considerando la modularidad y conexiones externas.",
            "Rutear las pistas de la PCB, crear planos de tierra y ejecutar la verificación de reglas de diseño (DRC).",
            "Generar el conjunto completo de archivos Gerber para la fabricación de la PCB del CL-4i Brain."
          ],
          difficulty: "Alta", duration_min: 90, prerequisites: ["L2-2"],
          resources_json: {
            tutorials: [{ name: "Video Tutorial: Diseño de PCB del CL-4i Brain en CAD/CAM (Layout y Ruteo)", url: "#", type: "video" }],
            cad_project_files: [
                { name: "Proyecto (PCB): CL-4i Brain Board (Plantilla con Footprints Asignados)", url: "#", type: "cad_cam" }
            ],
            guides: [{ name: "Guía de Buenas Prácticas para Diseño de PCB de Drones", url: "#", type: "pdf" }]
          },
          challenge: "Completa el diseño de la PCB del CL-4i Brain Board. Genera los archivos Gerber y súbelos al Calypso Labs Gerber Viewer para una inspección visual.",
          evaluation: {
            type: "mixed",
            questions: [
              { q: "¿Cuál es el propósito del DRC (Design Rules Check)?", o: ["Asignar footprints a los símbolos.", "Verificar que el diseño de la PCB cumple con las restricciones de fabricación (ancho de pista, espaciado, etc.).", "Simular el consumo de energía de la placa."], a: 1 }
            ],
            practical: { type: "gerber_upload_simulated", description: "Sube tus archivos Gerber (.zip) del CL-4i Brain Board. Caly simulará una revisión de DRC básica.", passing_criteria: { drc_pass: true, layers_detected: ['F.Cu', 'B.Cu', 'Edge.Cuts', 'F.Mask', 'B.Mask', 'F.SilkS'] } },
            passing_score: 80,
            unlocks: ["badge:pcb_designer_cl4i_brain", "badge:gerber_expert", "access:calypso_maquila_service_pcb", "access:calypso_cnc_pcb_maker_basic"]
          }
        },
         {
          id: "L2-4", moduleId: "M2", order: 4, title: "Diseño de Módulos de Propulsión y Conexión del CL-4i",
          description: "Diseña los módulos de propulsión (Pods) del CL-4i, incluyendo la PCB para los ESCs y motores, y los conectores magnéticos (10 pines para alimentación, 3 pines para PWM/GND). Aprende sobre el sistema de identificación de módulos.",
          objectives: [
              "Diseñar el esquemático y PCB para un módulo de propulsión del CL-4i, integrando ESCs, motores y conectores.",
              "Implementar el sistema de conexión magnética para los Pods, considerando la distribución de pines para alta corriente y señales.",
              "Entender y diseñar el circuito de identificación de módulos usando una resistencia en el chasis y una entrada ADC protegida."
          ],
          difficulty: "Alta", duration_min: 75, prerequisites: ["L2-3"],
          resources_json: {
              cad_project_files: [
                  { name: "Proyecto CAD/CAM: Módulo de Propulsión CL-4i (Esquemático y PCB)", url: "#", type: "cad_cam_project" }
              ],
              docs: [
                  { name: "Especificaciones: Conectores Laterales CL-4i (Alimentación y PWM)", url: "#", type: "pdf" },
                  { name: "Documento Técnico: Sistema de Identificación de Módulos CL-4i", url: "#", type: "pdf" }
              ]
          },
          challenge: "Diseña la PCB para un Pod de propulsión del CL-4i, incluyendo los conectores magnéticos y el circuito de identificación. Genera los Gerbers.",
          evaluation: {
              type: "mixed",
              questions: [
                { q: "En el CL-4i, los conectores laterales de 10 posiciones para los Pods se usan principalmente para:", o: ["Comunicación I2C", "Alimentación de alta corriente (VIN+ y VIN-)", "Señales de video FPV"], a: 1 },
                { q: "El sistema de identificación de módulos del CL-4i utiliza una resistencia en el chasis para generar un voltaje único, ¿qué componente se usa para proteger la entrada ADC del microcontrolador de posibles sobrevoltajes?", o: ["Un capacitor", "Un diodo Zener", "Otro resistor en serie"], a: 1}
              ],
              practical: { type: "gerber_upload_simulated", description: "Sube tus archivos Gerber (.zip) del Módulo de Propulsión.", passing_criteria: { drc_pass: true, correct_connector_footprints: true } },
              passing_score: 75,
              unlocks: ["badge:pcb_designer_cl4i_pods"]
          }
        },

        // ----- MÓDULO 3: Diseño y Fabricación 3D para el CL-4i -----
        {
          id: "L3-1", moduleId: "M3", order: 1, title: "Modelado 3D del Chasis y Módulos del CL-4i",
          description: "Aprende a modelar las piezas mecánicas del CL-4i (chasis del 'Cerebro', carcasas de Pods de propulsión) usando software CAD como Fusion 360. Accede a los archivos STEP de referencia y crea tus propios STLs.",
          objectives: [
              "Utilizar herramientas de modelado 3D paramétrico para crear las piezas del CL-4i.",
              "Interpretar las dimensiones de referencia (ej. tamaño tarjeta bancaria) y especificaciones para el CL-4i.",
              "Diseñar para ensamblaje, considerando los espacios para PCBs, baterías, motores y conectores magnéticos.",
              "Exportar modelos 3D en formato STL y STEP."
          ],
          difficulty: "Intermedia", duration_min: 90, prerequisites: ["L2-4"],
          resources_json: {
              tutorials: [{ name: "Video Tutorial: Modelando el Chasis del CL-4i 'Clay' en Fusion 360", url: "#", type: "video" }],
              cad_files: [
                  { name: "Archivo STEP: Ensamblaje Completo CL-4i (Referencia)", url: "#", type: "step" },
                  { name: "Archivo F3D: Chasis Cerebro CL-4i (Editable)", url: "#", type: "f3d" },
                  { name: "Archivo F3D: Módulo de Propulsión CL-4i (Editable)", url: "#", type: "f3d" }
              ],
              docs: [{ name: "Especificaciones de Diseño Mecánico: CL-4i (Dimensiones y Tolerancias)", url: "#", type: "pdf" }]
          },
          challenge: "Modela la carcasa para un módulo de propulsión del CL-4i, asegurando el correcto alojamiento del motor, ESC, PCB y los conectores magnéticos. Exporta el STL.",
          evaluation: {
              type: "mixed",
              questions: [
                  { q: "¿Qué significa que un software CAD sea 'paramétrico'?", o: ["Solo puede crear modelos con parámetros predefinidos.", "Permite definir relaciones y dimensiones que pueden ser modificadas posteriormente, actualizando el modelo automáticamente.", "Genera los parámetros de impresión 3D automáticamente."], a: 1 },
                  { q: "Al diseñar una carcasa para el CL-4i, ¿qué consideración es importante para el sistema de conexión magnética?", o: ["No dejar espacio para los imanes.", "Asegurar cavidades precisas para los imanes de neodimio y espacio para los pogo pins.", "Hacer las paredes lo más gruesas posible."], a: 1}
              ],
              practical: { type: "file_submission_simulated", description: "Sube tu archivo STL de la carcasa del módulo de propulsión.", file_type: ".stl", check: "basic_manifold_check" },
              passing_score: 75,
              unlocks: ["badge:cad_modeler_fusion360_cl4i"]
          }
        },
        {
          id: "L3-2", moduleId: "M3", order: 2, title: "Impresión 3D de Piezas del CL-4i: FDM y SLA",
          description: "Prepara y lamina los archivos STL de las piezas del CL-4i para impresión 3D. Aprende a seleccionar materiales (PLA, PETG, Resina), configurar parámetros en el slicer y operar las impresoras FDM y SLA de Calypso Labs.",
          objectives: [
              "Utilizar software slicer (ej. Cura, PrusaSlicer, Lychee) para preparar los STLs del CL-4i.",
              "Seleccionar el material y los parámetros de impresión adecuados para las piezas del CL-4i según la tecnología (FDM/SLA).",
              "Operar de forma segura una impresora 3D FDM y SLA, incluyendo la carga de material y el inicio de la impresión.",
              "Realizar el post-procesado básico de piezas impresas (retirar soportes, curado UV para SLA)."
          ],
          difficulty: "Intermedia", duration_min: 60, prerequisites: ["L3-1"],
          resources_json: {
              stl_files: [
                   { name: "STL: Chasis Cerebro CL-4i", url: "#", type: "stl" },
                   { name: "STL: Carcasa Módulo Propulsión CL-4i (Izquierdo)", url: "#", type: "stl" },
                   { name: "STL: Carcasa Módulo Propulsión CL-4i (Derecho)", url: "#", type: "stl" }
              ],
              guides: [
                  { name: "Guía de Slicing para Piezas del CL-4i (Parámetros Recomendados)", url: "#", type: "pdf" },
                  { name: "Manual de Operación: Impresoras 3D FDM de Calypso Labs", url: "#", type: "pdf" },
                  { name: "Manual de Operación: Impresoras 3D SLA de Calypso Labs", url: "#", type: "pdf" }
              ],
              videos: [{ name: "Video: Imprimiendo y Ensamblando el Chasis del CL-4i", url: "#", type: "video" }]
          },
          challenge: "Imprime el chasis del 'Cerebro' del CL-4i usando una de las impresoras de Calypso Labs (o la tuya propia). Documenta tus parámetros de impresión y el resultado.",
          evaluation: {
              type: "mixed",
              questions: [
                  { q: "Al imprimir una pieza del CL-4i en PLA (FDM), ¿qué problema puede causar una velocidad de impresión excesivamente alta?", o: ["Mejor calidad superficial.", "Menor tiempo de impresión y posible mala adhesión entre capas o detalles perdidos.", "Mayor resistencia de la pieza."], a: 1 },
                  { q: "Después de imprimir una pieza con una impresora SLA usando resina, ¿cuál es un paso de post-procesado esencial?", o: ["Lijar la pieza inmediatamente.", "Lavar la pieza en alcohol isopropílico y luego curarla bajo luz UV.", "Pintar la pieza para protegerla del aire."], a: 1 }
              ],
              practical: { type: "photo_submission_simulated", description: "Sube fotos de tu pieza impresa del chasis del CL-4i y los parámetros utilizados." },
              passing_score: 70,
              unlocks: ["badge:impresor3d_cl4i_certificado", "badge:fdm_printer_operator", "badge:sla_printer_operator", "access:calypso_impresoras_3d_uso_guiado"]
          }
        },

        // ----- MÓDULO 4: Ensamblaje y Soldadura del CL-4i -----
        {
          id: "L4-1", moduleId: "M4", order: 1, title: "Ensamblaje Mecánico del CL-4i 'Clay'",
          description: "Aprende a ensamblar todas las piezas mecánicas impresas en 3D del CL-4i, junto con los motores, tornillería y otros componentes no electrónicos. Sigue la guía de ensamblaje paso a paso.",
          objectives: [
              "Identificar todas las piezas mecánicas y hardware necesario para el ensamblaje del CL-4i.",
              "Ensamblar correctamente el chasis principal, los módulos de propulsión y otros sub-ensamblajes mecánicos.",
              "Asegurar el correcto montaje de motores, hélices y el sistema de conexión magnética."
          ],
          difficulty: "Intermedia", duration_min: 60, prerequisites: ["L3-2"],
          resources_json: {
              guides: [{ name: "Guía Ilustrada de Ensamblaje Mecánico del CL-4i", url: "#", type: "pdf" }],
              exploded_views: [{ name: "Vista Explotada Interactiva del Ensamblaje CL-4i", url: "#", type: "interactive_3d" }],
              videos: [{ name: "Video Timelapse: Ensamblaje Mecánico Completo del CL-4i", url: "#", type: "video" }],
              bom_files: [{ name: "Lista de Materiales (BOM) - Hardware Mecánico CL-4i", url: "#", type: "pdf" }]
          },
          challenge: "Ensambla completamente la estructura mecánica de tu CL-4i utilizando las piezas impresas y el hardware necesario.",
          evaluation: {
              type: "auto",
              questions: [
                  { q: "Al montar los motores brushless en los Pods del CL-4i, ¿qué precaución es importante respecto a los tornillos?", o: ["Usar los tornillos más largos posibles para máxima sujeción.", "Asegurarse de que los tornillos no sean tan largos que toquen los bobinados internos del motor.", "No usar tornillos, solo pegamento."], a: 1 },
                  { q: "¿Por qué es importante la correcta alineación de los imanes de neodimio en los módulos del CL-4i?", o: ["Solo por estética.", "Para asegurar una conexión eléctrica y mecánica firme y precisa entre módulos.", "Para aumentar el campo magnético del dron."], a: 1 },
                  { q: "Antes de conectar los módulos de propulsión al 'Cerebro', ¿qué se debe verificar en el ensamblaje mecánico?", o: ["Que la batería esté completamente cargada.", "Que todos los tornillos estén apretados y no haya piezas sueltas que puedan causar vibraciones.", "Que el color de los módulos coincida con el del chasis."], a: 1}
              ],
              passing_score: 80,
              unlocks: ["badge:cl4i_assembler_mecanico"]
          }
        },
        {
          id: "L4-2", moduleId: "M4", order: 2, title: "Soldadura de Componentes en las PCBs del CL-4i",
          description: "Con las PCBs del CL-4i listas (fabricadas o de maquila), aprende a soldar todos los componentes electrónicos, incluyendo el ESP32-S3, conectores, sensores SMD y componentes THT. Utiliza las herramientas de la estación de soldadura de Calypso Labs.",
          objectives: [
              "Identificar la ubicación y orientación de cada componente en las PCBs del CL-4i (Brain Board, Pods).",
              "Aplicar técnicas de soldadura SMD para componentes como el ESP32-S3, sensores y conectores.",
              "Soldar componentes Through-Hole (THT) si los hubiera.",
              "Inspeccionar la calidad de las uniones de soldadura y realizar retrabajo (rework) si es necesario."
          ],
          difficulty: "Alta", duration_min: 120, prerequisites: ["L2-3", "L2-4"],
          resources_json: {
              guides: [{ name: "Guía de Soldadura Específica para PCBs del CL-4i (con fotos)", url: "#", type: "pdf" }],
              videos: [
                  { name: "Video Tutorial: Soldando el ESP32-S3 y Sensores SMD en el CL-4i Brain Board", url: "#", type: "video" },
                  { name: "Video: Técnicas de Rework para el CL-4i", url: "#", type: "video" }
              ],
              placement_diagrams: [
                  { name: "Diagrama de Colocación de Componentes: CL-4i Brain Board", url: "#", type: "pdf" },
                  { name: "Diagrama de Colocación de Componentes: Módulo de Propulsión CL-4i", url: "#", type: "pdf" }
              ]
          },
          challenge: "Solda todos los componentes en la PCB del 'Cerebro' del CL-4i. Comparte fotos macro de tus soldaduras para revisión.",
          evaluation: {
              type: "mixed",
              questions: [
                  { q: "Al soldar un componente SMD como un QFN (Quad Flat No-leads) usando aire caliente, ¿qué es crucial para una buena unión?", o: ["Aplicar una gran cantidad de soldadura en pasta.", "Un correcto precalentamiento de la placa y la aplicación de flux.", "Usar la temperatura más alta posible en la pistola de aire caliente."], a: 1 },
                  { q: "Una soldadura 'fría' en un componente THT se caracteriza por:", o: ["Ser brillante y cóncava.", "Tener un aspecto opaco, granular y formar una mala conexión eléctrica.", "Tener un exceso de soldadura que forma un puente."], a: 1 },
                  { q: "Para aplicar pasta de soldar de forma precisa en los pads del CL-4i Brain Board antes de usar el horno de reflujo, ¿qué herramienta es ideal?", o: ["Una jeringa manual", "Un stencil específico para la PCB del CL-4i Brain", "Un cautín de punta fina"], a: 1}
              ],
              practical_review_simulated: {
                   description: "Sube fotos macro de alta resolución de tu PCB del CL-4i Brain Board ensamblada para una revisión de calidad de soldadura simulada.",
                   rubric: [ "Correcta orientación de componentes polarizados.", "Filetes de soldadura SMD uniformes y sin puentes.", "Buenas uniones en componentes THT.", "Limpieza general de la placa (sin exceso de flux)." ]
              },
              passing_score: 75,
              unlocks: ["badge:smd_soldering_pro_cl4i", "badge:tht_soldering_pro", "access:calypso_estacion_smd_avanzada", "access:calypso_horno_reflujo_supervisado"]
          }
        },

        // ----- MÓDULO 5: Firmware del CL-4i -----
        {
          id: "L5-1", moduleId: "M5", order: 1, title: "Configuración del Entorno y Firmware Base del CL-4i",
          description: "Prepara tu entorno de desarrollo (VS Code + PlatformIO) para el ESP32-S3. Descarga el firmware base del CL-4i y aprende a compilarlo y cargarlo en el 'Cerebro' del dron. Entiende la estructura principal del código.",
          objectives: [
              "Instalar y configurar VS Code con la extensión PlatformIO.",
              "Clonar el repositorio de firmware del CL-4i desde GitHub.",
              "Comprender la estructura de directorios y archivos principales del proyecto de firmware.",
              "Compilar y cargar el firmware base en el ESP32-S3 del CL-4i."
          ],
          difficulty: "Intermedia", duration_min: 60, prerequisites: ["L4-2"],
          resources_json: {
              source_code_project: [
                  { name: "Repositorio GitHub: Firmware CL-4i para ESP32-S3", url: "#", type: "github_repo" }
              ],
              guides: [
                  { name: "Guía Paso a Paso: Configurando PlatformIO para el CL-4i", url: "#", type: "pdf" },
                  { name: "Tutorial: Compilación y Carga del Primer Firmware al CL-4i", url: "#", type: "pdf" }
              ],
              docs: [{ name: "Descripción General: Arquitectura del Firmware CL-4i", url: "#", type: "pdf" }]
          },
          challenge: "Compila y carga exitosamente el firmware base del CL-4i en tu placa 'Cerebro'. Verifica la salida por el monitor serie para confirmar la inicialización.",
          evaluation: {
              type: "auto",
              questions: [
                  { q: "¿Qué archivo principal en un proyecto de PlatformIO define las dependencias, la placa y el framework?", o: ["main.cpp", "platformio.ini", "src/config.h"], a: 1 },
                  { q: "Al cargar el firmware en un ESP32, ¿qué modo debe estar activado generalmente?", o: ["Modo de ejecución normal", "Modo Bootloader (o modo Flash)", "Modo Deep Sleep"], a: 1 },
                  { q: "El repositorio de firmware del CL-4i probablemente contendrá carpetas como 'src', 'lib' e 'include'. ¿Cuál es el propósito principal de la carpeta 'lib'?", o: ["Contener el código fuente principal de la aplicación.", "Almacenar librerías de terceros o personalizadas que el proyecto utiliza.", "Guardar los archivos de configuración del proyecto."], a: 1}
              ],
              passing_score: 80,
              unlocks: ["badge:platformio_wizard_cl4i", "access:calypso_code_zone_basico"]
          }
        },
        {
          id: "L5-2", moduleId: "M5", order: 2, title: "Programación de Sensores del CL-4i: IMU, ToF y UWB",
          description: "Escribe y adapta el código para leer datos de los sensores clave del CL-4i: la IMU (ICM-20948) para orientación, el sensor ToF (VL53L5CX) para detección de distancia, y el módulo UWB (DWM1000) para posicionamiento. Aprende a inicializar y obtener lecturas.",
          objectives: [
              "Inicializar y leer datos de acelerómetro, giroscopio y magnetómetro de la IMU ICM-20948 vía SPI.",
              "Configurar y obtener mediciones de distancia del sensor ToF VL53L5CX vía I2C.",
              "Establecer comunicación básica con el módulo UWB DWM1000 vía SPI para obtener datos de rango (requiere anclas UWB).",
              "Integrar las lecturas de estos sensores en el bucle principal del firmware del CL-4i."
          ],
          difficulty: "Alta", duration_min: 90, prerequisites: ["L5-1", "L2-1"],
          resources_json: {
              source_code_snippets: [
                  { name: "Código Ejemplo: Lectura de IMU ICM-20948 (ESP32)", url: "#", type: "cpp" },
                  { name: "Código Ejemplo: Lectura de Sensor ToF VL53L5CX (ESP32)", url: "#", type: "cpp" },
                  { name: "Código Ejemplo: Comunicación Básica con DWM1000 (ESP32)", url: "#", type: "cpp" }
              ],
              libraries: [
                  { name: "Librería Arduino/ESP-IDF para ICM-20948", url: "#", type: "library_link" },
                  { name: "Librería Arduino/ESP-IDF para VL53L5CX", url: "#", type: "library_link" },
                  { name: "Librería Arduino/ESP-IDF para DWM1000", url: "#", type: "library_link" }
              ]
          },
          challenge: "Modifica el firmware base del CL-4i para leer continuamente los datos del acelerómetro (ejes X, Y, Z) de la IMU y enviarlos por el monitor serie.",
          evaluation: {
              type: "code_submission_simulated",
              description: "Sube el archivo `main.cpp` modificado. Caly verificará la correcta inicialización y lectura de la IMU (simulado).",
              passing_criteria: { imu_init_present: true, imu_read_loop: true, serial_print_xyz: true },
              questions: [
                  { q: "¿Qué protocolo de comunicación utiliza típicamente el sensor ToF VL53L5CX para interactuar con el ESP32?", o: ["SPI", "UART", "I2C"], a: 2 },
                  { q: "La IMU ICM-20948 combina varios sensores. ¿Cuál de los siguientes NO suele estar integrado directamente en una IMU de este tipo?", o: ["Giroscopio", "Acelerómetro", "Sensor GPS"], a: 2 }
              ],
              passing_score: 70,
              unlocks: ["badge:sensor_integration_guru_cl4i", "badge:esp32_firmware_dev_sensores"]
          }
        },
         {
          id: "L5-3", moduleId: "M5", order: 3, title: "Control de Motores y Gestión de Energía en Firmware CL-4i",
          description: "Implementa el control PWM para los motores del CL-4i. Programa la lógica para leer el sensor de corriente (ACS758), el sistema de identificación de módulos y gestionar el estado de la batería (ej. con MAX17043 o BMS).",
          objectives: [
              "Generar señales PWM para controlar la velocidad de los 4 motores del CL-4i a través de los ESCs.",
              "Leer e interpretar los valores del sensor de corriente ACS758 para estimar el consumo.",
              "Implementar la lógica para leer el voltaje del divisor resistivo del sistema de identificación de módulos.",
              "Interactuar con el fuel gauge MAX17043 (o BMS de batería) para obtener el estado de carga (SoC) y voltaje."
          ],
          difficulty: "Alta", duration_min: 75, prerequisites: ["L5-1"],
          resources_json: {
              source_code_snippets: [
                  { name: "Código Ejemplo: Control PWM de Motores (ESP32)", url: "#", type: "cpp" },
                  { name: "Código Ejemplo: Lectura de ADC para ACS758 e ID de Módulo (ESP32)", url: "#", type: "cpp" },
                  { name: "Código Ejemplo: Lectura de MAX17043 (ESP32)", url: "#", type: "cpp" }
              ],
              docs: [
                  { name: "Documento: PWM y Control de ESCs en Drones", url: "#", type: "pdf" },
                  { name: "Nota de Aplicación: Uso del ACS758 para Medición de Corriente", url: "#", type: "pdf" }
              ]
          },
          challenge: "Implementa una función en el firmware que haga girar los 4 motores del CL-4i a baja velocidad (10% del PWM máximo) durante 5 segundos al recibir un comando por el monitor serie.",
          evaluation: {
              type: "code_submission_simulated",
              description: "Sube tu `main.cpp` con la función de prueba de motores. Caly verificará la lógica PWM (simulado).",
              passing_criteria: { pwm_setup_correct: true, motor_test_function_present: true, serial_command_logic: true },
               questions: [
                  { q: "Si un pin PWM del ESP32 se configura con una frecuencia de 500Hz y un ciclo de trabajo del 50%, ¿qué significa?", o: ["El pin estará en alto 500ms y en bajo 500ms.", "El pin cambiará de estado 500 veces por segundo, estando en alto la mitad del tiempo de cada ciclo.", "El pin suministrará 500mA con un voltaje del 50% del VCC."], a: 1 },
                  { q: "El sensor de corriente ACS758 generalmente proporciona una salida de tipo:", o: ["Digital (I2C o SPI)", "Analógica (voltaje proporcional a la corriente)", "PWM"], a: 1 },
                  { q: "¿Para qué se utiliza un 'Fuel Gauge' como el MAX17043 en un sistema alimentado por batería?", o: ["Para regular el voltaje de la batería.", "Para medir con precisión el estado de carga (SoC) y el voltaje de la batería.", "Para aumentar la capacidad de la batería."], a: 1}
              ],
              passing_score: 70,
              unlocks: ["badge:motor_control_expert_cl4i", "badge:power_management_firmware_cl4i"]
          }
        },

        // ----- MÓDULO 6: Conectividad y Control Remoto del CL-4i -----
        {
          id: "L6-1", moduleId: "M6", order: 1, title: "Provisioning del CL-4i vía BLE y Web Bluetooth",
          description: "Aprende a implementar un servicio BLE en el ESP32 del CL-4i para recibir credenciales Wi-Fi. Utiliza la interfaz CL-SetUP (Web Bluetooth) para enviar el SSID y contraseña al dron.",
          objectives: [
              "Configurar un servicio y característica BLE en el ESP32 para recibir datos de provisioning.",
              "Entender el formato del payload de provisioning (ej. WIFI:SSID;PASS:Password;).",
              "Utilizar la interfaz web CL-SetUP para conectarse al CL-4i vía BLE y enviar las credenciales.",
              "Programar el ESP32 para parsear las credenciales recibidas y conectarse a la red Wi-Fi."
          ],
          difficulty: "Intermedia", duration_min: 70, prerequisites: ["L5-1"], // Asumiendo una lección básica de HTML/JS en M1
          resources_json: {
              source_code_esp32: [{ name: "Firmware CL-4i: Módulo de Provisioning BLE", url: "#", type: "cpp_folder" }],
              web_interface_code: [{ name: "Código Fuente: Interfaz CL-SetUP (HTML/JS/CSS)", url: "#", type: "html_zip" }],
              docs: [{ name: "Protocolo de Provisioning BLE para CL-4i", url: "#", type: "pdf" }]
          },
          challenge: "Modifica el firmware del CL-4i para que, además de las credenciales Wi-Fi, acepte un parámetro 'HOSTNAME' vía BLE y lo use para configurar el nombre del dispositivo en la red.",
          evaluation: {
              type: "auto",
              questions: [
                  { q: "En BLE, un 'Servicio' agrupa un conjunto de:", o: ["Dispositivos", "Características", "Paquetes de datos"], a: 1 },
                  { q: "La interfaz CL-SetUP utiliza `navigator.bluetooth.requestDevice()` para:", o: ["Enviar datos directamente.", "Solicitar al usuario que seleccione un dispositivo BLE cercano.", "Leer el estado de la batería del dispositivo."], a: 1 },
                  { q: "Para escribir datos en una característica BLE desde una página web, ¿qué función se utiliza típicamente después de obtener la característica?", o: ["characteristic.readValue()", "characteristic.writeValue()", "characteristic.startNotifications()"], a: 1 }
              ],
              passing_score: 80,
              unlocks: ["badge:ble_provisioner_cl4i", "access:calypso_setup_tool_expert"]
          }
        },
        {
          id: "L6-2", moduleId: "M6", order: 2, title: "Comunicación CL-4i con HUB (Linux+ROS) vía Wi-Fi y WebSockets",
          description: "Configura la comunicación Wi-Fi entre el ESP32 del CL-4i y un HUB (Orange Pi/Raspberry Pi con Linux y ROS). Envía telemetría (IMU, ToF) desde el dron al HUB y recibe comandos. Implementa un servidor WebSocket en el HUB para visualizar datos en una interfaz web.",
          objectives: [
              "Programar el ESP32 para conectarse a una red Wi-Fi y enviar datos (JSON o binario) a una IP y puerto específicos del HUB.",
              "Configurar un script en el HUB (Python/Node.js) para recibir datos del CL-4i y publicarlos en tópicos ROS.",
              "Utilizar ROSBridge para exponer los tópicos ROS a través de WebSockets.",
              "Crear una interfaz web básica que se conecte al WebSocket del HUB y muestre la telemetría en tiempo real."
          ],
          difficulty: "Muy Alta", duration_min: 120, prerequisites: ["L5-3", "L6-1"],
          resources_json: {
              source_code_esp32: [{ name: "Firmware CL-4i: Módulo de Comunicación Wi-Fi con HUB", url: "#", type: "cpp_folder" }],
              source_code_hub: [
                  { name: "Script Python (HUB): Receptor de Telemetría CL-4i y Publicador ROS", url: "#", type: "python" },
                  { name: "Configuración ROSBridge para CL-4i HUB", url: "#", type: "yaml" }
              ],
              web_interface_example: [{ name: "Interfaz Web Sencilla para Visualización de Telemetría CL-4i (HTML/JS)", url: "#", type: "html_zip" }],
              docs: [{ name: "Arquitectura de Comunicación Distribuida CL-4i (ESP32-HUB-Web)", url: "#", type: "pdf" }]
          },
          challenge: "Logra que tu CL-4i envíe datos de su IMU (roll, pitch, yaw) al HUB, y que estos se visualicen en la interfaz web de ejemplo en tiempo real.",
          evaluation: {
              type: "project_review_simulated",
              description: "Sube tu código del ESP32, el script del HUB y la interfaz web. Describe cómo funciona la comunicación. Caly revisará la lógica (simulado).",
              passing_criteria: { esp32_wifi_tx: true, hub_ros_rx_publish: true, websocket_interface_works: true },
              questions: [
                  { q: "¿Qué es ROS (Robot Operating System)?", o: ["Un sistema operativo para robots que reemplaza a Linux.", "Un conjunto de frameworks de software y herramientas para construir aplicaciones robóticas.", "Un protocolo de comunicación inalámbrica para drones."], a: 1 },
                  { q: "WebSockets es un protocolo que permite:", o: ["Comunicación unidireccional del cliente al servidor.", "Comunicación bidireccional y en tiempo real entre un cliente (navegador) y un servidor.", "Solo la transferencia de archivos de video."], a: 1 }
              ],
              passing_score: 70,
              unlocks: ["badge:comunicador_cl4i_avanzado", "badge:ros_iot_architect_cl4i", "access:calypso_api_pro", "access:calypso_mqtt_broker_educational"]
          }
        },

        // ----- MÓDULO 7: Autonomía, IA y Proyecto Final CL-4i -----
        {
          id: "L7-1", moduleId: "M7", order: 1, title: "Fundamentos de Vuelo Autónomo y Control PID para CL-4i",
          description: "Aprende los principios de vuelo (sustentación, fuerzas aerodinámicas) y cómo se aplica el control PID para la estabilización y navegación autónoma del CL-4i. Adapta un controlador PID básico en el firmware.",
          objectives: [
              "Explicar las cuatro fuerzas aerodinámicas y cómo afectan al CL-4i.",
              "Entender los componentes de un controlador PID (Proporcional, Integral, Derivativo) y su rol en la corrección de errores.",
              "Implementar un bucle de control PID básico en el ESP32 para estabilizar un eje del CL-4i (ej. pitch o roll) usando datos de la IMU."
          ],
          difficulty: "Alta", duration_min: 90, prerequisites: ["L5-2", "L5-3"],
          resources_json: {
              docs: [
                  { name: "Documento: Fundamentos de Vuelo para Drones Multirrotor", url: "#", type: "pdf" },
                  { name: "Guía Práctica: Implementando un Controlador PID para Drones", url: "#", type: "pdf" }
              ],
              source_code_snippets: [{ name: "Código Ejemplo: Controlador PID Básico (ESP32)", url: "#", type: "cpp" }],
              videos: [{ name: "Video: Explicación Visual del Control PID en Drones", url: "#", type: "video" }]
          },
          challenge: "Ajusta (tunea) las constantes Kp, Ki, Kd de un controlador PID para el eje 'roll' de tu CL-4i hasta lograr una estabilización aceptable (simulado o en banco de pruebas seguro).",
          evaluation: {
              type: "auto",
              questions: [
                  { q: "En un controlador PID, ¿qué componente es responsable de reaccionar a la magnitud actual del error?", o: ["Integral (I)", "Derivativo (D)", "Proporcional (P)"], a: 2 },
                  { q: "Si un dron tiende a oscilar excesivamente al intentar estabilizarse, ¿qué constante PID podría estar demasiado alta?", o: ["Kp (Proporcional)", "Ki (Integral)", "Kd (Derivativo)"], a: 0 },
                  { q: "La fuerza que se opone directamente al movimiento de un dron a través del aire se llama:", o: ["Sustentación", "Empuje", "Arrastre (Drag)"], a: 2 }
              ],
              passing_score: 75,
              unlocks: ["badge:pid_tuner_cl4i"]
          }
        },
        {
          id: "L7-2", moduleId: "M7", order: 2, title: "Navegación Autónoma del CL-4i: Evasión de Obstáculos y Seguimiento",
          description: "Implementa algoritmos básicos para que el CL-4i navegue de forma autónoma, evadiendo obstáculos con su sensor ToF y siguiendo un objetivo simple usando datos de UWB o visión (conceptual).",
          objectives: [
              "Utilizar los datos del sensor ToF VL53L5CX para detectar obstáculos y modificar la trayectoria del CL-4i.",
              "Desarrollar una lógica de máquina de estados simple para la navegación autónoma básica (ej. avanzar, girar si hay obstáculo).",
              "Comprender cómo se podrían usar los datos UWB para el seguimiento de un objetivo (requiere infraestructura UWB).",
              "(Opcional Avanzado) Integrar una cámara y algoritmos básicos de visión por computadora para seguimiento."
          ],
          difficulty: "Muy Alta", duration_min: 120, prerequisites: ["L7-1", "L6-2"],
          resources_json: {
              source_code_examples: [
                  { name: "Firmware CL-4i: Ejemplo de Evasión de Obstáculos con ToF", url: "#", type: "cpp_folder" },
                  { name: "Firmware CL-4i: Ejemplo de Navegación a Punto de Referencia UWB (Conceptual)", url: "#", type: "cpp_folder" }
              ],
              docs: [{ name: "Algoritmos de Navegación Sencillos para Drones Interiores", url: "#", type: "pdf" }],
              simulators: [{ name: "Acceso a ClaySim (Beta) para Pruebas de Navegación Virtual", url: "#", type: "tool_link" }]
          },
          challenge: "Implementa un algoritmo en tu CL-4i que le permita avanzar en línea recta y detenerse si detecta un obstáculo a menos de 20cm usando el sensor ToF.",
          evaluation: {
              type: "project_review_simulated",
              description: "Sube tu código y un video corto (o descripción detallada) de tu CL-4i realizando la evasión de obstáculos. Caly revisará la lógica (simulado).",
              passing_criteria: { tof_reading_correct: true, obstacle_avoidance_logic: true, safe_stop: true },
              questions: [
                  { q: "¿Qué tipo de información proporciona principalmente un sensor ToF (Time-of-Flight)?", o: ["Color del objeto", "Distancia al objeto más cercano en su campo de visión", "Temperatura ambiente"], a: 1 },
                  { q: "Para un seguimiento preciso de objetivos en interiores sin GPS, ¿qué tecnología mencionada para el CL-4i sería más adecuada?", o: ["Bluetooth Clásico", "UWB (Ultra-Wideband)", "Sensor de temperatura"], a: 1}
              ],
              passing_score: 70,
              unlocks: ["badge:autonomous_navigator_cl4i", "access:claysim_pro_features"]
          }
        },
        {
          id: "L7-3", moduleId: "M7", order: 3, title: "Proyecto Final: Tu CL-4i 'Clay' Personalizado y Presentación",
          description: "Integra todos los conocimientos y componentes para finalizar tu propio dron CL-4i 'Clay'. Documenta tu proceso, personalizaciones (si las hay) y prepara una presentación de tu proyecto funcional.",
          objectives: [
              "Ensamblar, programar y probar un dron CL-4i completamente funcional basado en los recursos del curso.",
              "Documentar el proceso de construcción, los desafíos enfrentados y las soluciones implementadas.",
              "Preparar una presentación clara y concisa de tu proyecto CL-4i, destacando sus características y aprendizajes.",
              "Recibir mentoría final y presentar tu proyecto a la comunidad Calypso Labs."
          ],
          difficulty: "Experto", duration_min: 180, prerequisites: ["L7-2"],
          resources_json: {
              templates: [
                  { name: "Plantilla de Documentación de Proyecto Final CL-4i", url: "#", type: "gdoc_template" },
                  { name: "Plantilla de Presentación de Proyecto CL-4i", url: "#", type: "ppt_template" }
              ],
              guides: [{ name: "Checklist de Entrega del Proyecto Final CL-4i", url: "#", type: "pdf" }],
              support_channels: [{ name: "Canal Discord: Mentoría Proyecto Final CL-4i", url: "#", type: "discord_link" }]
          },
          challenge: "Completa tu dron CL-4i, incluyendo al menos una funcionalidad autónoma básica. Documenta y presenta tu proyecto.",
          evaluation: {
              type: "final_project_submission",
              description: "Entrega tu documentación completa, código fuente final y un video demostrativo de tu CL-4i funcional. Serás evaluado por mentores de Calypso Labs.",
              rubric_items: ["Completitud del ensamblaje y soldadura", "Funcionalidad del firmware base", "Implementación de al menos una característica autónoma", "Calidad de la documentación", "Claridad de la presentación/video"],
              passing_score: 85,
              unlocks: ["certificate:Calypso_CL4i_Innovator_Certified", "badge:cl4i_master_builder", "access:calypso_labs_pro_membership_discount", "access:calypso_lab_mentor_candidate"]
          }
        }
      ];

        if (!localStorage.getItem('calypso_categories')) { localStorage.setItem('calypso_categories', JSON.stringify(CATEGORIES_DATA)); }
        if (!localStorage.getItem('calypso_lessons')) { localStorage.setItem('calypso_lessons', JSON.stringify(LESSONS_DATA)); }
        const GENERAL_RESOURCES_DATA = [ { name: "Componentes", url: "https://store.calypsolabs.com.mx", icon: "🛒" }, { name: "CAD/CAM Software", url: "https://academy.calypsolabs.com.mx/PCBmkr.html", icon: "✍️" }, { name: "PlatformIO IDE", url: "https://platformio.org/", icon: "🛠️" }, { name: "Calculadora Ley de Ohm", url: "https://calypsolabs.com.mx/ohms", icon: "🧮" }, { name: "Digi-Key Componentes", url: "https://www.digikey.com.mx", icon: "🛒" }, { name: "Mouser Electronics", url: "https://www.mouser.mx", icon: "🛒" } ];
    </script>

    <script>        // --- Data Fetching / API Simulation ---
        const API_DELAY = 150; 
        async function fetchCategories() { return new Promise(resolve => { setTimeout(() => { resolve(JSON.parse(localStorage.getItem('calypso_categories')) || []); }, API_DELAY); }); }
        async function fetchCategoryById(id) { return new Promise(resolve => { setTimeout(() => { const c = JSON.parse(localStorage.getItem('calypso_categories')) || []; resolve(c.find(cat => cat.id === id) || null); }, API_DELAY); }); }
        async function fetchLessonsByModuleId(moduleId) { return new Promise(resolve => { setTimeout(() => { const l = JSON.parse(localStorage.getItem('calypso_lessons')) || []; resolve(l.filter(lesson => lesson.moduleId === moduleId).sort((a,b)=>a.order - b.order)); }, API_DELAY); }); }
        async function fetchLessonById(lessonId) { return new Promise(resolve => { setTimeout(() => { const l = JSON.parse(localStorage.getItem('calypso_lessons')) || []; resolve(l.find(lesson => lesson.id === lessonId) || null); }, API_DELAY); }); }

        // --- User Authentication & Progress ---
        function getCurrentUser() { const e = localStorage.getItem('calypso_currentUser'); if (!e) return null; const u = JSON.parse(localStorage.getItem('calypso_users')) || []; return u.find(user => user.email === e) || null; }
        async function loginUser(creds) { return new Promise((res, rej) => { setTimeout(() => { const u = JSON.parse(localStorage.getItem('calypso_users')) || []; const user = u.find(usr => usr.email === creds.email && usr.password === creds.password); if (user) { localStorage.setItem('calypso_currentUser', user.email); res({ success: true, user }); } else { rej({ success: false, message: "Credenciales incorrectas. Intenta de nuevo." }); } }, API_DELAY + 200); }); }
        async function registerUser(userData) { return new Promise((res, rej) => { setTimeout(() => { let users = JSON.parse(localStorage.getItem('calypso_users')) || []; if (users.some(u => u.email === userData.email)) { rej({ success: false, message: "El email ya está registrado." }); return; } if (users.some(u => u.username === userData.username)) { rej({ success: false, message: "El nombre de usuario ya existe." }); return; } const newUser = { id: `user-${Date.now()}`, ...userData, role: 'maker', created_at: new Date().toISOString(), profile_picture_url: '', cover_image_url: '' }; users.push(newUser); localStorage.setItem('calypso_users', JSON.stringify(users)); let allProgress = JSON.parse(localStorage.getItem('calypso_user_progress')) || {}; if (!allProgress[newUser.email]) { allProgress[newUser.email] = { lessons: {}, achievements: [] }; } else if (!allProgress[newUser.email].achievements) { allProgress[newUser.email].achievements = []; } allProgress[newUser.email].achievements.push( {id: 'register_complete', title: 'Registro Completado', icon: '📝', date: new Date().toISOString()}, {id: 'account_created', title: 'Cuenta Creada con Éxito', icon: '👤', date: new Date().toISOString()} ); localStorage.setItem('calypso_user_progress', JSON.stringify(allProgress)); res({ success: true, user: { email: newUser.email, username: newUser.username, role: newUser.role } }); }, API_DELAY + 200); }); }
        function logoutUser() { localStorage.removeItem('calypso_currentUser'); }
        function getUserProgress(userEmail) { if (!userEmail) userEmail = localStorage.getItem('calypso_currentUser'); if (!userEmail) return { lessons: {}, achievements: [] }; const allProgress = JSON.parse(localStorage.getItem('calypso_user_progress')) || {}; const userSpecificProgress = allProgress[userEmail] || { lessons: {}, achievements: [] }; if (!userSpecificProgress.lessons) userSpecificProgress.lessons = {}; if (!userSpecificProgress.achievements) userSpecificProgress.achievements = []; return userSpecificProgress; }
        // --- Helper para obtener íconos de badges ---
        function getIconForBadge(badgeId) {
            // Mapeo de IDs de badge a íconos. Puedes expandir esto.
            const iconMap = {
                "badge:cad_profesional": "⚡",
                "badge:pcb_designer_cl4i_brain": "💡",
                "badge:impresora3d_fdm_operador": "🍥",
                "badge:impresora3d_sla_operador": "💧",
                "badge:estacion_soldadura_smd_experto": "🔥", // Cambiado para diferenciar de herramienta genérica
                "badge:soldador_cl4i_experto": "🛠️",
                "badge:cl4i_ensamblador_certificado": "🔩",
                "badge:cnc_pcb_maker": "⚙️",
                "badge:firmware_esp32_dev": "💻",
                "badge:control_pid_implementador": "📊",
                "badge:api_calypso_integrador": "🔗",
                "badge:claysim_piloto_virtual": "🎮",
                "badge:comunicador_cl4i_avanzado": "📡",
                "badge:cl4i_master_builder": "👑", // Para el proyecto final
                // ... más badges
            };
            for (const key in iconMap) {
                if (badgeId.toLowerCase().includes(key.substring(6))) { // Compara sin el prefijo "badge:"
                    return iconMap[key];
                }
            }
            if (badgeId.startsWith("badge:")) return '🌟'; // Ícono por defecto para skill badge
            if (badgeId.startsWith("access:")) return '🔑'; // Ícono por defecto para acceso
            return '🏆'; // Ícono genérico
        }

        function updateUserProgress(lessonId, score, status, moduleId) {
            const userEmail = localStorage.getItem('calypso_currentUser');
            if (!userEmail) {
                console.error("Intento de actualizar progreso sin usuario logueado.");
                if (typeof showGlobalNotification === "function") { // Verificar si existe la función
                     showGlobalNotification("Debes iniciar sesión para guardar tu progreso.", "error");
                } else {
                    alert("Debes iniciar sesión para guardar tu progreso."); // Fallback
                }
                return false;
            }

            let allProgress = JSON.parse(localStorage.getItem('calypso_user_progress')) || {};
            if (!allProgress[userEmail]) {
                allProgress[userEmail] = { lessons: {}, achievements: [] };
            }
            if (!allProgress[userEmail].lessons) { // Asegurar que lessons exista
                allProgress[userEmail].lessons = {};
            }
            if (!allProgress[userEmail].achievements) { // Asegurar que achievements exista
                allProgress[userEmail].achievements = [];
            }

            allProgress[userEmail].lessons[lessonId] = {
                score,
                status,
                completed_at: status === 'completed' ? new Date().toISOString() : (allProgress[userEmail].lessons[lessonId]?.completed_at || null), // Mantener fecha si ya estaba completado
                moduleId: moduleId
            };

            let lessonCompletedThisTime = false; // Para controlar si se añade el logro genérico de lección

            if (status === 'completed') {
                const lessons = JSON.parse(localStorage.getItem('calypso_lessons')) || [];
                const lessonData = lessons.find(l => l.id === lessonId);

                if (lessonData && lessonData.evaluation && lessonData.evaluation.unlocks) {
                    lessonData.evaluation.unlocks.forEach(unlock => {
                        let achievementExists = allProgress[userEmail].achievements.some(ach => ach.id === unlock);
                        
                        if (!achievementExists) {
                            let title = unlock;
                            let icon = '🏆';
                            let type = 'generic_unlock';

                            if (unlock.startsWith("badge:")) {
                                title = `Habilidad: ${unlock.substring(6).replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
                                icon = getIconForBadge(unlock);
                                type = 'skill_badge';
                                lessonCompletedThisTime = true; // Un badge de habilidad cuenta como completar la lección en términos de logro específico
                            } else if (unlock.startsWith("access:")) {
                                title = `Acceso: ${unlock.substring(7).replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
                                icon = getIconForBadge(unlock);
                                type = 'access_unlock';
                                lessonCompletedThisTime = true;
                            } else if (unlock.startsWith("certificate:")) { // Podrías tener un tipo específico para certificados mayores
                                title = `Certificado Mayor: ${unlock.substring(12).replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
                                icon = '📜';
                                type = 'major_certificate';
                                lessonCompletedThisTime = true;
                            }
                            // Podrías añadir más tipos de unlocks aquí (ej. "credit:", "entry:")

                            allProgress[userEmail].achievements.push({
                                id: unlock,
                                title: title,
                                icon: icon,
                                date: new Date().toISOString(),
                                type: type,
                                lessonSource: lessonId // Para saber de qué lección vino este logro
                            });
                        }
                    });
                }

                // Añadir logro genérico de "Lección Superada" SOLO si no se añadió un badge/access/certificate específico de esta lección
                const genericLessonAchievementId = `lesson_completed_${lessonId}`;
                if (!lessonCompletedThisTime && !allProgress[userEmail].achievements.find(ach => ach.id === genericLessonAchievementId)) {
                    if(lessonData) { // Asegurarse que lessonData existe
                         allProgress[userEmail].achievements.push({
                            id: genericLessonAchievementId,
                            title: `Lección Superada: '${lessonData.title}'`,
                            icon: '🎓',
                            date: new Date().toISOString(),
                            type: 'lesson_completion',
                            lessonSource: lessonId
                        });
                    }
                }
            }

            localStorage.setItem('calypso_user_progress', JSON.stringify(allProgress));
            return true;
        }
        async function updateUserProfileDetails(updatedDetails) { return new Promise((resolve, reject) => { setTimeout(() => { const currentUserEmail = localStorage.getItem('calypso_currentUser'); if (!currentUserEmail) { reject({ success: false, message: "No hay usuario logueado." }); return; } let users = JSON.parse(localStorage.getItem('calypso_users')) || []; const userIndex = users.findIndex(u => u.email === currentUserEmail); if (userIndex > -1) { users[userIndex] = { ...users[userIndex], ...updatedDetails }; localStorage.setItem('calypso_users', JSON.stringify(users)); resolve({ success: true, user: users[userIndex] }); } else { reject({ success: false, message: "Usuario no encontrado." }); } }, API_DELAY + 100); }); }
    </script>

    <script>        // --- Router & Navigation ---
        const routes = { '/': 'homeView', '/curso': 'courseView', '/modulo/:moduleId': 'moduleView', '/leccion/:lessonId': 'lessonView', '/perfil': 'profileView', '/membresias': 'membershipsView', '/login': 'loginView', '/registro': 'registerView' };
        const appRoot = document.getElementById('app-root');
        let currentModuleIdForTheme = null;

        function renderLoadingIndicator(container, message = "Cargando contenido...") {
            container.innerHTML = `<div class="calypso-loader-container"><div class="calypso-loader"></div><p>${message}</p></div>`;
        }

        function updateNavActiveState(currentPath) { document.querySelectorAll('.calypso-nav a[data-navlink]').forEach(link => { link.classList.remove('nav-active'); const linkPath = link.getAttribute('href').substring(1); if (currentPath === linkPath || (currentPath === '/' && linkPath === '/')) { link.classList.add('nav-active'); } else if (linkPath !== '/' && currentPath.startsWith(linkPath) && linkPath.length > 1) { link.classList.add('nav-active'); } }); }
        async function router() {
            const rawPath = window.location.hash.slice(1) || '/';
            let viewFunctionName = null, params = {}, matchedRouteKey = null;
            currentModuleIdForTheme = null; 

            for (const routeKey in routes) {
                const routeRegex = new RegExp("^" + routeKey.replace(/:[^\s/]+/g, '([\\w-]+)') + "$");
                const match = rawPath.match(routeRegex);
                if (match) {
                    viewFunctionName = routes[routeKey];
                    matchedRouteKey = routeKey;
                    const paramNames = (routeKey.match(/:[^\s/]+/g) || []).map(name => name.substring(1));
                    paramNames.forEach((name, index) => { params[name] = match[index + 1]; });
                    if (params.moduleId) { currentModuleIdForTheme = params.moduleId; }
                    else if (params.lessonId) { const lesson = await fetchLessonById(params.lessonId); if(lesson) currentModuleIdForTheme = lesson.moduleId; }
                    break;
                }
            }

            const currentUser = getCurrentUser();
            if ((rawPath.startsWith('/perfil')) && !currentUser) { navigateTo('/login'); return; }

            const sidebar = document.getElementById('calypso-sidebar');
            if (sidebar && sidebar.classList.contains('open')) { toggleSidebar(false); }
            const mainNav = document.getElementById('main-nav');
            if(mainNav && mainNav.classList.contains('open')) { mainNav.classList.remove('open'); document.getElementById('mobile-nav-toggle-btn').setAttribute('aria-expanded','false'); document.getElementById('mobile-nav-toggle-btn').innerHTML = '☰<span class="hidden">Abrir Nav</span>'; }


            applyCurrentTheme(); 

            appRoot.style.animation = 'none'; 
            void appRoot.offsetWidth; 
            appRoot.style.animation = 'fadeInView 0.5s ease-out forwards';

            if (viewFunctionName && typeof window[viewFunctionName] === 'function') {
                renderLoadingIndicator(appRoot); 
                await window[viewFunctionName](appRoot, params); 
                updateNavActiveState(matchedRouteKey || rawPath);
                if (typeof updateSidebarModuleLinks === "function") updateSidebarModuleLinks();
            } else {
                appRoot.innerHTML = `<div class="text-center p-8"><h1 class="view-title" style="color: var(--calypso-error);">Error 404</h1><p class="view-subtitle">Página no encontrada: ${rawPath}</p><a href="#/" class="btn btn-primary">Volver al Inicio</a></div>`;
                updateNavActiveState('error');
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        window.addEventListener('hashchange', router);
        function navigateTo(path) { window.location.hash = path; }
    </script>
    <script>
        const resourceModal = document.getElementById('resourceModal');
        const resourceModalFrame = document.getElementById('resourceModalFrame');
        const resourceModalTitle = document.getElementById('resourceModalTitle');

        function openResourceModal(url, title = "Recurso Externo") {
            if (!resourceModal || !resourceModalFrame || !resourceModalTitle) {
                console.error("Elementos del modal de recurso no encontrados.");
                // Fallback to new tab if modal components are missing
                window.open(url, '_blank');
                return;
            }
            resourceModalTitle.textContent = title;
            resourceModalFrame.src = url;
            resourceModal.showModal();
        }

        function closeResourceModal() {
            if (!resourceModal || !resourceModalFrame) return;
            resourceModal.close();
            resourceModalFrame.src = 'about:blank'; // Important to stop video/audio
            if (resourceModalTitle) resourceModalTitle.textContent = "Cargando Recurso...";
        }
    </script>

    <script>        // --- Sidebar Management ---
        const sidebarElement = document.getElementById('calypso-sidebar');
        const sidebarContentElement = document.getElementById('sidebar-content');

        function initializeSidebar() {
            const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
            const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
            
            if (!sidebarElement || !sidebarToggleBtn || !sidebarCloseBtn || !sidebarContentElement) {
                console.error("Sidebar elements not found. Sidebar will not function.");
                return;
            }

            sidebarToggleBtn.addEventListener('click', () => toggleSidebar());
            sidebarCloseBtn.addEventListener('click', () => toggleSidebar(false));
            
            renderSidebarContent(); 
        }

        function toggleSidebar(forceState) {
            if (!sidebarElement) return;
            const isOpen = sidebarElement.classList.contains('open');
            const shouldOpen = typeof forceState === 'boolean' ? forceState : !isOpen;

            if (shouldOpen) {
                sidebarElement.classList.add('open');
                renderSidebarContent(); 
            } else {
                sidebarElement.classList.remove('open');
            }
        }

        async function renderSidebarContent() {
            if (!sidebarContentElement) return;

            const currentUser = getCurrentUser();
            let html = '';

            if (currentUser) {
                const userProgress = getUserProgress(currentUser.email);
                const allLessons = JSON.parse(localStorage.getItem('calypso_lessons')) || [];
                let completedLessons = 0;
                if(userProgress.lessons) {
                    completedLessons = Object.values(userProgress.lessons).filter(l => l.status === 'completed').length;
                }
                const progressPercentage = allLessons.length > 0 ? Math.round((completedLessons / allLessons.length) * 100) : 0;
                const sidebarAvatarUrl = currentUser.profile_picture_url || `${encodeURIComponent(currentUser.username)}?colors=${getComputedStyle(document.documentElement).getPropertyValue('--theme-accent-primary').trim().substring(1)},${getComputedStyle(document.documentElement).getPropertyValue('--theme-bg-primary').trim().substring(1)}`;

                html += `
                    <div class="sidebar-section sidebar-profile-info">
                        <img src="${sidebarAvatarUrl}" alt="Avatar de ${currentUser.username}" onerror="this.src='${encodeURIComponent(currentUser.username)}?colors=cccccc,333333';">
                        <h4>${currentUser.username}</h4>
                        <p>${currentUser.email}</p>
                        <div class="sidebar-kpis">
                            <div><span>Progreso General:</span> <span>${completedLessons} / ${allLessons.length} Lecc.</span></div>
                            <div class="sidebar-progress-bar-container"><div class="sidebar-progress-bar" style="width: ${progressPercentage}%;"></div></div>
                        </div>
                        <a href="#/perfil" class="btn btn-secondary btn-sm mt-2" style="font-size:0.8rem; width:100%;" onclick="toggleSidebar(false)">Ver Perfil Detallado</a>
                    </div>`;
            } else {
                 html += `<div class="sidebar-section text-center"><p class="mb-2" style="font-size:0.9rem;">Inicia sesión para ver tu progreso y acceder a todas las funcionalidades.</p><a href="#/login" class="btn btn-primary btn-sm" style="font-size:0.8rem;" onclick="toggleSidebar(false)">Iniciar Sesión</a></div>`;
            }

            html += `<div class="sidebar-section">
                        <h3 class="sidebar-section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M19 3H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2V5c0-1.103-.897-2-2-2zM5 19V5h14l.002 14H5z"/><path fill="currentColor" d="M7 7h10v2H7zm0 4h10v2H7zm0 4h7v2H7z"/></svg>
                            Academia
                        </h3>
                        <ul class="sidebar-module-list" id="sidebar-module-links">`;
            
            const categories = await fetchCategories();
            const lessonsData = JSON.parse(localStorage.getItem('calypso_lessons')) || [];

            categories.sort((a,b) => a.order - b.order).forEach(category => {
                html += `<li><div class="sidebar-module-item">
                            <a href="#/modulo/${category.id}" class="sidebar-main-module-link" data-module-id="${category.id}">${category.icon_class} ${category.title}</a>`;
                const lessonsForCategory = lessonsData.filter(l => l.moduleId === category.id).sort((a,b) => a.order - b.order);
                if (lessonsForCategory.length > 0) {
                    html += `<button class="lesson-toggle-btn" data-target="lessons-${category.id}" aria-expanded="false" aria-label="Mostrar lecciones de ${category.title}">▼</button>`;
                }
                html += `</div>`;
                if (lessonsForCategory.length > 0) {
                    html += `<ul class="sidebar-lesson-list" id="lessons-${category.id}">`;
                    lessonsForCategory.forEach(lesson => {
                        html += `<li><a href="#/leccion/${lesson.id}" class="sidebar-lesson-link" data-lesson-id="${lesson.id}" data-parent-module-id="${category.id}">${lesson.title}</a></li>`;
                    });
                    html += `</ul>`;
                }
                html += `</li>`;
            });
            html += `</ul></div>`;

            html += `<div class="sidebar-section">
                        <h3 class="sidebar-section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"/><path fill="currentColor" d="M12.009 10.168-4.169 4.169 1.414 1.414 4.169-4.169-1.414-1.414zm.707-2.828-4.169-4.169L7.124 4.585l4.169 4.169 1.414-1.414zM13 11h-2v5h2v-5zm-2-2h2V4h-2v5z" transform="rotate(45 12 12)"/></svg>
                            Recursos Útiles
                        </h3>
                        <ul class="sidebar-resource-list">`;
            GENERAL_RESOURCES_DATA.forEach(resource => {
                html += `<li><a href="${resource.url}" target="_blank" rel="noopener noreferrer">${resource.icon} ${resource.name}</a></li>`;
            });
            html += `</ul></div>`;

            sidebarContentElement.innerHTML = html;
            addSidebarEventListeners();
            updateSidebarModuleLinks();
        }

        function addSidebarEventListeners() {
            const toggleButtons = sidebarContentElement.querySelectorAll('.lesson-toggle-btn');
            toggleButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation(); 
                    const targetId = button.getAttribute('data-target');
                    const sublist = document.getElementById(targetId);
                    const isExpanded = button.getAttribute('aria-expanded') === 'true';
                    if (sublist) {
                        sublist.classList.toggle('expanded', !isExpanded);
                        button.setAttribute('aria-expanded', String(!isExpanded));
                    }
                });
            });

            sidebarContentElement.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (e) => {
                    if (!link.closest('.sidebar-module-item')?.querySelector('.lesson-toggle-btn[data-target^="lessons-"]')) {
                        if (window.matchMedia("(max-width: 960px)").matches || !e.target.closest('.lesson-toggle-btn')) {
                             toggleSidebar(false);
                        }
                    }
                });
            });
        }
        
        function updateSidebarModuleLinks() {
            const currentHash = window.location.hash;
            document.querySelectorAll('#calypso-sidebar .sidebar-main-module-link, #calypso-sidebar .sidebar-lesson-link').forEach(link => {
                link.classList.remove('active-module-link');
            });

            let activeLinkFound = false;

            document.querySelectorAll('#calypso-sidebar .sidebar-lesson-link').forEach(link => {
                if (link.getAttribute('href') === currentHash) {
                    link.classList.add('active-module-link');
                    activeLinkFound = true;
                    const parentModuleId = link.getAttribute('data-parent-module-id');
                    const parentModuleItem = document.querySelector(`#calypso-sidebar .sidebar-main-module-link[data-module-id="${parentModuleId}"]`)?.closest('li');
                    if (parentModuleItem) {
                        const toggleBtn = parentModuleItem.querySelector('.lesson-toggle-btn');
                        const sublist = parentModuleItem.querySelector('.sidebar-lesson-list');
                        if (toggleBtn && sublist && !sublist.classList.contains('expanded')) {
                            toggleBtn.setAttribute('aria-expanded', 'true');
                            sublist.classList.add('expanded');
                        }
                    }
                }
            });

            if (!activeLinkFound) {
                document.querySelectorAll('#calypso-sidebar .sidebar-main-module-link').forEach(link => {
                    if (link.getAttribute('href') === currentHash) {
                        link.classList.add('active-module-link');
                    }
                });
            }
        }
    </script>

    <script>        // --- Dynamic Island Logic ---
        async function updateDynamicIsland() {
            const dynamicIslandSection = document.getElementById('dynamic_island_section');
            if (!dynamicIslandSection) return; 

            const dynamicIslandTitleElement = dynamicIslandSection.querySelector('#dynamic_island_title');
            const dynamicIslandContentWrapper = dynamicIslandSection.querySelector('#dynamic_island_content_wrapper');

            if (!dynamicIslandTitleElement || !dynamicIslandContentWrapper) return;

            const currentUser = getCurrentUser();
            const allLessons = JSON.parse(localStorage.getItem('calypso_lessons')) || []; 
            const allCategories = JSON.parse(localStorage.getItem('calypso_categories')) || [];

            let titleText = "¿Por qué acreditarse en Calypso Labs?";
            let contentHTML = `
                <div class="dynamic-island-content">
                    <ul style="list-style:none; padding-left:0;">
                        <li class="mb-4">✔️ <strong style="color:var(--theme-accent-primary);">Acceso Maker Exclusivo:</strong> Participa en retos de diseño, accede a recursos premium, APIs especializadas y sorteos de hardware real (Jetson, SSDs).</li>
                        <li class="mb-4">✔️ <strong style="color:var(--theme-accent-primary);">Caly Asistente IA:</strong> Tu tutor personal de IA que te acompaña, evalúa tu progreso y te ofrece recomendaciones personalizadas y soporte técnico básico.</li>
                        <li class="mb-4">✔️ <strong style="color:var(--theme-accent-primary);">Certifica Tu Dominio Global:</strong> Cada lección aprobada genera un certificado digital único con código QR verificable, validando tus habilidades específicas.</li>
                        <li class="mb-4">✔️ <strong style="color:var(--theme-accent-primary);">API MQTT y Nube Educativa:</strong> Obtén acceso a nuestros servidores MQTT y APIs en la nube para potenciar tus proyectos IoT y embebidos.</li>
                        <li class="mb-4">✔️ <strong style="color:var(--theme-accent-primary);">Suma Logros, Desbloquea Herramientas:</strong> Tu conocimiento aquí sí abre puertas. Avanza y obtén acceso a más software, hardware y horas de laboratorio.</li>
                        <li>✔️ <strong style="color:var(--theme-accent-primary);">Premios y Becas Reales:</strong> Los makers destacados pueden ganar Jetson Nano, SSDs, horas gratuitas de maquila PCB y acceso a nuestro laboratorio físico (según disponibilidad y méritos).</li>
                    </ul>
                </div>`;
            
            dynamicIslandContentWrapper.classList.remove('di-success', 'di-info', 'di-warning');

            if (currentUser && allLessons.length > 0 && allCategories.length > 0) {
                const userProgress = getUserProgress(currentUser.email);
                const userLessonsProgress = userProgress.lessons || {}; 
                let personalizedMessages = [];

                // Check for recently completed lessons
                if(userLessonsProgress) { 
                    for (const lessonId in userLessonsProgress) {
                        if (userLessonsProgress[lessonId].status === 'completed') {
                            const lessonInfo = allLessons.find(l => l.id === lessonId);
                            const categoryInfo = allCategories.find(c => c.id === lessonInfo?.moduleId);
                            const felicitacionKey = `felicitacion_home_lesson_${lessonId}_${currentUser.email}`;

                            if (lessonInfo && categoryInfo && !sessionStorage.getItem(felicitacionKey) ) {
                                 personalizedMessages.push({ 
                                    priority: 1, 
                                    type: 'success', 
                                    title: `¡Felicidades, ${currentUser.username}!`, 
                                    html: `<div class="dynamic-island-content">
                                            <p>Acabas de completar la lección <strong class="di-highlight">${lessonInfo.title}</strong> (Categoría: ${categoryInfo.title}) con una calificación de <strong class="di-highlight">${userLessonsProgress[lessonId].score}%</strong>.</p>
                                            <p class="mt-2">¡Excelente trabajo! Revisa tus <a href="#/perfil" class="btn btn-secondary btn-sm">Logros y Certificados</a>.</p>
                                           </div>`, 
                                    action: () => { sessionStorage.setItem(felicitacionKey, 'true'); } 
                                });
                            }
                        }
                    }
                }
                
                // Suggest next lesson if no recent completion message
                let nextLessonSuggested = false;
                if (personalizedMessages.filter(p => p.priority === 1).length === 0) { 
                    for (const category of allCategories.sort((a,b)=>a.order - b.order)) {
                        const lessonsInCategory = allLessons.filter(l => l.moduleId === category.id).sort((a,b)=>a.order - b.order);
                        for (const lesson of lessonsInCategory) {
                            const prog = userLessonsProgress[lesson.id];
                            if (!prog || (prog.status !== 'completed' && prog.status !== 'in_progress')) { // Suggest if not started or failed
                                personalizedMessages.push({ 
                                    priority: 2, 
                                    type: 'info', 
                                    title: 'Tu Próxima Aventura Maker', 
                                    html: `<div class="dynamic-island-content">
                                            <p>Hola <strong class="di-highlight">${currentUser.username}</strong>, ¿listo para tu siguiente desafío? Te recomendamos continuar con: <strong class="di-highlight">${lesson.title}</strong> (Categoría: ${category.title}).</p>
                                            <p class="text-sm text-gray-400">${lesson.description.substring(0,120)}...</p>
                                            <p class="mt-2"><a href="#/leccion/${lesson.id}" class="btn btn-primary btn-sm">Comenzar Lección Ahora</a></p>
                                           </div>`, 
                                    action: null 
                                });
                                nextLessonSuggested = true; 
                                break; 
                            }
                        }
                        if (nextLessonSuggested) break; 
                    }
                }
                
                // Message if all lessons are completed
                if (!nextLessonSuggested && allLessons.length > 0 && allLessons.every(l => userLessonsProgress[l.id]?.status === 'completed' )) {
                    if (personalizedMessages.filter(p => p.priority <= 2).length === 0) { // Only if no other higher priority message
                         const capstoneModule = allCategories.find(c => c.id === "M7"); // Check for capstone project
                        personalizedMessages.push({ 
                            priority: 3, 
                            type: 'success', 
                            title: '¡Curso Maestro Completado!', 
                            html: `<div class="dynamic-island-content">
                                    <p>¡Increíble hazaña, <strong class="di-highlight">${currentUser.username}</strong>! Has dominado todas las lecciones de la Academia Calypso el Laboratorio te abre susu puertas y te invita a seguir el recorrido! </p>
                                    ${capstoneModule ? `<p>Es el momento perfecto para aplicar tus conocimientos en el <a href="#/modulo/M7" style="color:var(--theme-accent-secondary); font-weight:bold;">Proyecto Integrador</a>.</p>` : ''}
                                    <p>También puedes explorar <a href="#/membresias" style="color:var(--theme-accent-secondary); font-weight:bold;">membresías avanzadas</a> para llevar tus proyectos al siguiente nivel.</p>
                                    <p><span>¿Sabías que...?</span> "<strong>CL-4i</strong>" Significa: "Laboratorio Calypso para Interiores". Y hace referencia al recorrido que acabas de ralizar!</p>
                                   </div>`,
                            action: null 
                        });
                    }
                }

                personalizedMessages.sort((a, b) => a.priority - b.priority);

                if (personalizedMessages.length > 0) {
                    const messageToShow = personalizedMessages[0];
                    titleText = messageToShow.title; 
                    contentHTML = messageToShow.html;
                    dynamicIslandContentWrapper.classList.add(`di-${messageToShow.type}`);
                    if (messageToShow.action) { 
                        messageToShow.action(); 
                    }
                }
            }
            dynamicIslandTitleElement.innerHTML = titleText; 
            dynamicIslandContentWrapper.innerHTML = contentHTML;
        }
    </script>

    <script>        // --- View Rendering Functions ---
        function homeView(container, params) {
            container.innerHTML = `
                <section class="text-center py-12">
                    <h1 class="view-title text-gradient-green mb-4" style="font-size: 3rem;">Bienvenido a Calypso Labs</h1>
                    <p class="view-subtitle mb-8" style="font-size: 1.2rem;">🧠 “Cada herramienta es un privilegio. Cada módulo, una llave.”<br><strong>Aprende, acredita y evoluciona en el universo maker con CL-4i.</strong></p>
                    <a href="#/curso" class="btn btn-primary font-orbitron" style="padding: 0.9rem 2rem; font-size: 1.15rem;">"@CL-4i" ¡Explora todas lecciones!</a>
                </section>
                <section id="dynamic_island_section" class="py-8 px-4">
                    <h2 id="dynamic_island_title" class="view-title mb-6" style="font-size:2rem; color: var(--theme-accent-secondary);"></h2>
                    <div id="dynamic_island_content_wrapper" class="max-w-3xl mx-auto p-6 glass">
                        <!-- Content for dynamic island by JS -->
                    </div>
                </section>
                <section class="py-10 px-4">
                    <h2 class="view-title mb-10" style="font-size:2rem; color: var(--theme-accent-secondary);">Filosofía del Ecosistema Calypso</h2>
                    <div class="philosophy-cards-container">
                        <div class="philosophy-card glass">
                            <div class="philosophy-card-header">
                                <span class="philosophy-card-icon">🏆</span>
                                <h3 class="philosophy-card-title">Acceso por Mérito y Habilidad</h3>
                            </div>
                            <p>En Calypso Labs, el acceso a herramientas avanzadas, servicios de laboratorio y espacios de colaboración no se compra; <strong class="text-gradient-green">se gana a través del conocimiento, la dedicación y la habilidad demostrada en nuestra plataforma.</strong> Creemos en el poder del aprendizaje práctico.</p>
                        </div>
                        <div class="philosophy-card glass">
                            <div class="philosophy-card-header">
                                <span class="philosophy-card-icon">🌍</span>
                                <h3 class="philosophy-card-title">Apertura, Accesibilidad y Open Source</h3>
                            </div>
                            <p>No restringimos la adquisición de componentes básicos ni servicios de maquila estándar. Recursos educativos fundamentales, enlaces, herramientas de diseño CAD/EDA y referencias de fabricación <strong class="text-gradient-green">están abiertos y disponibles desde el inicio</strong>, promoviendo un aprendizaje continuo, autodidacta y alineado con la filosofía Open Source.</p>
                        </div>
                        <div class="philosophy-card glass">
                            <div class="philosophy-card-header">
                                <span class="philosophy-card-icon">🧠</span>
                                <h3 class="philosophy-card-title">Caly: Tu Guía y Mentor IA</h3>
                            </div>
                            <p>Nuestro objetivo es acompañarte desde tu primer clic hasta la incubación y el éxito de tu proyecto. Serás guiado por <strong class="text-gradient-green">Caly, tu tutor IA personalizado</strong>, quien evalúa tu progreso, te ofrece recomendaciones, te ayuda a depurar y desbloquea recursos según tus avances y logros.</p>
                        </div>
                    </div>
                </section>`;
            if (typeof updateDynamicIsland === "function") {
                updateDynamicIsland();
            } else {
                console.warn("updateDynamicIsland no está definida cuando se renderiza homeView.");
            }
        }

        async function courseView(container, params) {
            renderLoadingIndicator(container, "Cargando categorías del curso...");
            try {
                const categories = await fetchCategories();
                if (!categories || categories.length === 0) {
                    container.innerHTML = `<div class="text-center p-10"><h2 class="view-title" style="color:var(--calypso-warning);">Sin Categorías</h2><p class="view-subtitle">Actualmente no hay categorías de curso disponibles. Vuelve más tarde.</p></div>`;
                    return;
                }
                let categoriesHTML = `
                    <div class="text-center mb-10">
                        <h1 class="view-title">Categorías | "@CL-4i"</h1>
                        <p class="view-subtitle">Explora las diferentes áreas de conocimiento para convertirte en un experto maker con Caly, desde los fundamentos hasta la creación de un proyecto IoT integrador.</p>
                    </div>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">`;
                categories.sort((a,b)=>a.order - b.order).forEach(category => {
                    categoriesHTML += `
                        <div class="module-card">
                            <h2 class="module-card-title">${category.icon_class} ${category.title}</h2>
                            <p class="module-card-description">${category.description}</p>
                            <a href="#/modulo/${category.id}" class="btn btn-secondary mt-auto">Ver Lecciones del Módulo</a>
                        </div>`;
                });
                categoriesHTML += `</div>`;
                container.innerHTML = categoriesHTML;
            } catch (error) {
                console.error("Error cargando categorías:", error);
                container.innerHTML = `<div class="text-center p-10"><h2 class="view-title" style="color:var(--calypso-error);">Error de Carga</h2><p class="view-subtitle">No se pudieron cargar las categorías. Por favor, intenta recargar la página.</p></div>`;
            }
        }

        async function moduleView(container, params) {
            const moduleId = params.moduleId;
            if (!moduleId) {
                container.innerHTML = `<div class="text-center p-10"><h2 class="view-title" style="color:var(--calypso-error);">Error</h2><p class="view-subtitle">ID de categoría no especificado.</p></div>`;
                return;
            }
            renderLoadingIndicator(container, `Cargando categoría ${moduleId}...`);
            try {
                const category = await fetchCategoryById(moduleId);
                if (!category) {
                    container.innerHTML = `<div class="text-center p-10"><h2 class="view-title" style="color:var(--calypso-error);">Categoría No Encontrada</h2><p class="view-subtitle">La categoría solicitada no existe o no está disponible.</p></div>`;
                    return;
                }
                const lessons = await fetchLessonsByModuleId(moduleId);
                let lessonsHTML = '';
                if (lessons && lessons.length > 0) {
                    lessonsHTML += `<div class="lessons-container"><h3 class="module-card-title h3">Lecciones Disponibles en esta Categoría:</h3><ul class="module-card-description">`;
                    const user = getCurrentUser();
                    const userProgress = user ? getUserProgress(user.email) : {};
                    const lessonsProgress = userProgress.lessons || {};

                    lessons.forEach(lesson => {
                        const lessonProg = lessonsProgress[lesson.id];
                        let lessonStatusText = user ? "No iniciado" : "";
                        let lessonStatusClass = user ? "status-notstarted" : ""; 
                        let statusIcon = user ? "⚪" : ""; 

                        if (user && lessonProg) {
                            if (lessonProg.status === 'completed') {
                                lessonStatusText = `Completado ${lessonProg.score}%`;
                                lessonStatusClass = "status-completed";
                                statusIcon = "🟢"; 
                            } else if (lessonProg.status === 'in_progress') {
                                lessonStatusText = `En progreso`;
                                lessonStatusClass = "status-inprogress";
                                statusIcon = "🟡"; 
                            } else if (lessonProg.status === 'failed') {
                                lessonStatusText = `Fallido ${lessonProg.score}%`;
                                lessonStatusClass = "status-failed";
                                statusIcon = "🔴"; 
                            }
                        } else if (!user) {
                             lessonStatusText = "(Inicia sesión para ver progreso)";
                             lessonStatusClass = "text-gray-500";
                        }

                        lessonsHTML += `
                        <li class="lesson-list-item p-4 rounded-md glass">
                            <div class="flex items-center justify-between">
                                <a href="#/leccion/${lesson.id}" class="font-semibold text-lg hover:text-gradient-green">${statusIcon} ${lesson.title}</a>
                                ${user ? `<span class="status-badge ${lessonStatusClass}" style="font-size:0.7rem; padding: 0.2rem 0.5rem;">${lessonStatusText}</span>` : `<span class="text-xs ${lessonStatusClass}">${lessonStatusText}</span>`}
                            </div>
                            <p class="text-sm text-gray-400 mt-1">${lesson.description.substring(0,150)}...</p>
                        </li>`;
                    });
                    lessonsHTML += `</ul></div>`;
                } else {
                    lessonsHTML = `<p class="mt-6 text-gray-400 text-center p-4 glass">Aún no hay lecciones disponibles para esta categoría. ¡Vuelve pronto!</p>`;
                }
                container.innerHTML = `
                    <div class="module-detail-container">
                        <div class="flex flex-wrap justify-between items-start mb-6 gap-4">
                            <div>
                                <h1 class="module-detail-title">${category.icon_class} ${category.title}</h1>
                                <p class="text-sm" style="color:var(--theme-text-secondary);">Categoría Principal en CL-4i</p>
                            </div>
                            <a href="#/curso" class="btn btn-secondary btn-sm">← Volver a Categorías</a>
                        </div>
                        <p class="module-detail-description text-lg">${category.description}</p>
                        ${lessonsHTML}
                    </div>`;
            } catch (error) {
                console.error("Error cargando módulo:", error);
                container.innerHTML = `<div class="text-center p-10"><h2 class="view-title" style="color:var(--calypso-error);">Error de Carga</h2><p class="view-subtitle">No se pudo cargar la categoría: ${error.message}.</p></div>`;
            }
        }

        function getIconForResourceType(type) {
            const typeLower = type?.toLowerCase();
            switch(typeLower) {
                case 'pdf': return '📄';
                case 'video': return '🎬';
                case 'code': return '💻';
                case 'repo': return '📦'; // Un ícono diferente para repo
                case 'tool': return '🛠️';
                case 'app': return '📱'; // Para aplicaciones
                case 'guide': return '🧭';
                case 'template': return '📝';
                case 'api': return '🔗';
                case 'image': return '🖼️';
                case 'infographic': return '📊'; // Específico para infografías
                case 'article': return '📰';
                case 'link': return '🌐'; // Enlace web genérico
                default: return '📎';
            }
        }

        async function lessonView(container, params) {
            const { lessonId } = params;
            if (!lessonId) {
                container.innerHTML = `<div class="text-center p-10"><h2 class="view-title" style="color:var(--calypso-error);">Error</h2><p class="view-subtitle">ID de lección no especificado.</p></div>`;
                return;
            }
            renderLoadingIndicator(container, `Cargando lección ${lessonId}...`);

            try {
                const lesson = await fetchLessonById(lessonId);
                if (!lesson) {
                    container.innerHTML = `<div class="text-center p-10"><h2 class="view-title" style="color:var(--calypso-error);">Lección No Encontrada</h2><p class="view-subtitle">La lección solicitada no existe.</p></div>`;
                    return;
                }

                const category = await fetchCategoryById(lesson.moduleId);
                const user = getCurrentUser();
                const userProgress = user ? getUserProgress(user.email) : {};
                const lessonProgress = userProgress.lessons ? userProgress.lessons[lesson.id] : null;
                const allLessons = JSON.parse(localStorage.getItem('calypso_lessons')) || []; // Para los prerrequisitos

                // --- Sección de Prerrequisitos ---
                let prerequisitesHTML = '';
                if (lesson.prerequisites && lesson.prerequisites.length > 0) {
                    prerequisitesHTML = `
                    <div class="lesson-prerequisites mt-8 p-4 glass rounded-lg">
                        <h3 class="font-orbitron text-xl mb-3" style="color:var(--theme-accent-primary);">📚 Antes de Empezar</h3>
                        <p class="mb-2" style="color:var(--theme-text-secondary);">Para aprovechar al máximo esta lección, te recomendamos haber completado o tener familiaridad con:</p>
                        <ul class="list-none pl-0 space-y-1">
                            ${lesson.prerequisites.map(prereqId => {
                                const prereqLesson = allLessons.find(l => l.id === prereqId);
                                return `<li class="flex items-center">
                                            <span class="text-lg mr-2" style="color:var(--theme-accent-secondary);">➔</span>
                                            ${prereqLesson ? `<a href="#/leccion/${prereqLesson.id}" class="hover:underline" style="color:var(--theme-accent-secondary);">${prereqLesson.title}</a>` : `<span style="color:var(--theme-text-secondary);">Lección ID: ${prereqId} (No encontrada)</span>`}
                                        </li>`;
                            }).join('')}
                        </ul>
                    </div>`;
                }

                // --- Sección de Recursos ---
                let resourcesSectionHTML = '';
                if (lesson.resources_json && Object.keys(lesson.resources_json).length > 0) {
                    let resourcesContentHTML = '<div class="py-8 px-4">'; // Contenedor para las categorías de recursos
                    for (const key in lesson.resources_json) {
                        const resourcesList = lesson.resources_json[key];
                        if (Array.isArray(resourcesList) && resourcesList.length > 0) {
                            let resourceCategoryTitle = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                            // Mapeo de títulos más amigables
                            if (key === "docs") resourceCategoryTitle = "Documentación Esencial";
                            else if (key === "videos") resourceCategoryTitle = "Tutoriales en Video";
                            else if (key === "repo") resourceCategoryTitle = "Repositorios de Código";
                            else if (key === "app" || key === "tool") resourceCategoryTitle = "Herramientas y Aplicaciones";
                            else if (key === "lecturas") resourceCategoryTitle = "Lecturas Recomendadas";
                            else if (key === "guias" || key === "guide") resourceCategoryTitle = "Guías Prácticas";
                            else if (key === "plantillas" || key === "template") resourceCategoryTitle = "Plantillas Útiles";

                            resourcesContentHTML += `<div class=" mb-4"><strong class="block mb-3 text-gradient-green text-xl font-orbitron">${resourceCategoryTitle}</strong>`;
                            resourcesContentHTML += '<ul class="list-none pl-0 grid grid-cols-1 md:grid-cols-2 gap-4">';
                            const modalResourceTypes = ['pdf', 'video', 'link', 'infographic', 'guide', 'api']; // Add types you want in modal
                            
                            resourcesList.forEach(item => {
                                if (typeof item === 'object' && item.name && item.url) {
                                    const icon = getIconForResourceType(item.type);
                                    let linkAction = '';
                                    let targetIcon = `<span class="text-sm ml-2" style="color: var(--theme-accent-primary);">↗</span>`; // Default: new tab icon

                                    // Check if resource type is suitable for modal
                                    if (modalResourceTypes.includes(item.type?.toLowerCase())) {
                                        linkAction = `href="javascript:void(0);" onclick="openResourceModal('${item.url}', '${item.name.replace(/'/g, "\\'")}')"`;
                                        targetIcon = `<span class="text-sm ml-2" style="color: var(--theme-accent-primary);" title="Abrir en modal">🖼️</span>`; // Modal icon
                                    } else {
                                        linkAction = `href="${item.url}" target="_blank" rel="noopener noreferrer"`;
                                    }

                                    resourcesContentHTML += `
                                        <li class="glass p-4 rounded-lg hover:shadow-xl transition-all duration-200 ease-in-out transform hover:-translate-y-1">
                                            <a ${linkAction} class="flex items-start group">
                                                <span class="text-3xl mr-4 mt-1 transition-all">${icon}</span>
                                                <div class="flex-grow">
                                                    <span class="font-semibold text-base group-hover:underline mb-1" style="color: var(--theme-accent-secondary);">${item.name}</span>
                                                    ${item.description ? `<p class="text-xs mt-1" style="color: var(--theme-text-secondary);">${item.description}</p>` : ''}
                                                </div>
                                                ${targetIcon}
                                            </a>
                                        </li>`;
                                } else if (typeof item === 'string') { // Fallback
                                     resourcesContentHTML += `<li class="ml-2"><a href="${item}" target="_blank" rel="noopener noreferrer" class="hover:underline">${item.split('/').pop() || item}</a></li>`;
                                }
                            });
                            resourcesContentHTML += '</ul></div>';
                        }
                    }
                    resourcesContentHTML += '</div>';
                    resourcesSectionHTML = `<div class="lesson-resources mt-8"><h2 class="view-title text-2xl mb-6" style="text-align:left; color:var(--theme-accent-primary);">Recursos de Apoyo</h2>${resourcesContentHTML}</div>`;
                } else {
                    resourcesSectionHTML = `<div class="lesson-resources  mt-8"><h2 class="view-title text-2xl mb-6" style="text-align:left; color:var(--theme-accent-primary);">Recursos de Apoyo</h2><p class="text-sm p-4 glass rounded-md" style="color: var(--theme-text-secondary);">No hay recursos específicos listados para esta lección. ¡Explora los recursos generales de la categoría!</p></div>`;
                }
                
                // --- Sección de Evaluación ---
                let evaluationHTML = '';
                if (lesson.evaluation) {
                    if (user) {
                        if (lessonProgress && lessonProgress.status === 'completed') {
                            evaluationHTML = `
                                <div class="mt-8 p-6 rounded-lg glass text-center">
                                    <h3 class="font-orbitron text-2xl mb-3" style="color: var(--calypso-success);">🎉 ¡Lección Superada! 🎉</h3>
                                    <p style="color: var(--theme-text-primary);">Has completado esta lección con una calificación de: <strong style="color:var(--calypso-success); font-size:1.2em;">${lessonProgress.score}%</strong>.</p>
                                    <p class="mt-2 text-sm" style="color: var(--theme-text-secondary);">Tu conocimiento ha sido validado. ¡Sigue así, maker!</p>
                                    <div id="certificate-actions" class="mt-6">
                                        <button class="btn btn-primary btn-lg" onclick="generateCertificatePDF('${user.username}', '${category?.title || 'Curso Calypso'}', '${lesson.title}', ${lessonProgress.score}, 'CERT-${lesson.id.replace(/\W/g, '')}-${user.id.substring(0,8).toUpperCase()}')">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="mr-2"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                                            Descargar Certificado
                                        </button>
                                        <div id="qr-code-container" class="hidden"></div>
                                    </div>
                                </div>`;
                        } else { // No completada, o fallida, o en progreso (asumimos que si no es 'completed', se puede (re)intentar)
                            if (lesson.evaluation.questions && lesson.evaluation.questions.length > 0) {
                                evaluationHTML = `
                                    <form id="lesson-evaluation-form" class="mt-8 glass" style="padding: 2rem;">
                                        <h3 class="font-orbitron text-2xl mb-6 text-center" style="color:var(--theme-accent-primary);">📝 Pon a Prueba tu Conocimiento</h3>`;
                                if (lessonProgress && lessonProgress.status === 'failed') {
                                    evaluationHTML += `<p class="mb-4 text-center p-3 rounded-md" style="background-color: rgba(255,71,71,0.1); border: 1px solid var(--calypso-error); color: var(--calypso-error);">Intento anterior: ${lessonProgress.score}%. ¡No te rindas! Revisa el material y vuelve a intentarlo.</p>`;
                                }
                                lesson.evaluation.questions.forEach((q, index) => {
                                    evaluationHTML += `
                                        <div class="form-group mb-6">
                                            <fieldset role="radiogroup" aria-labelledby="q${index}-label">
                                            <legend id="q${index}-label" class="mb-3 font-medium text-lg" style="color:var(--theme-text-primary);">${index + 1}. ${q.q}</legend>
                                            <div class="space-y-2">
                                            ${q.o.map((option, i) => `
                                                <label class="inline-label block p-3 rounded-md hover:bg-opacity-20 cursor-pointer border border-transparent hover:border-[var(--theme-accent-primary)] has-[:checked]:bg-[var(--theme-accent-glow)] has-[:checked]:border-[var(--theme-accent-primary)] transition-all">
                                                    <input type="radio" name="q${index}" value="${i}" required class="mr-3">
                                                    <span class="text-base" style="color:var(--theme-text-primary);">${option}</span>
                                                </label>`).join('')}
                                            </div>
                                            </fieldset>
                                        </div>`;
                                });
                                evaluationHTML += `<button type="submit" class="btn btn-primary btn-lg w-full mt-6">Enviar Evaluación y Validar</button></form>`;
                            } else if (lesson.evaluation.type === "practical_review_simulated" || lesson.evaluation.type === "mixed") { // Si es práctico o mixto sin preguntas quiz
                                evaluationHTML = `<div class="mt-8 p-6 rounded-lg glass text-center">
                                                    <h3 class="font-orbitron text-2xl mb-3" style="color:var(--theme-accent-primary);">🚀 Desafío Práctico Avanzado</h3>
                                                    <p style="color:var(--theme-text-primary);" class="mb-2">Esta lección culmina con un desafío práctico que requiere tu atención y aplicación de habilidades.</p>
                                                    ${lesson.challenge ? `<p class="mb-4 text-sm italic p-3 bg-[var(--theme-bg-tertiary)] rounded-md" style="color:var(--theme-text-secondary);">${lesson.challenge}</p>` : ''}
                                                    ${lesson.evaluation.rubric ? `<div class="text-left mb-4"><strong style="color:var(--theme-text-primary);">Criterios de Evaluación (Simulados):</strong><ul class="list-disc pl-5 mt-1 text-sm" style="color:var(--theme-text-secondary);">${lesson.evaluation.rubric.map(r => `<li>${r}</li>`).join('')}</ul></div>` : ''}
                                                    <button id="complete-practical-challenge" class="btn btn-primary btn-lg mt-4">He Completado el Desafío</button>
                                                 </div>`;
                            } else {
                                 evaluationHTML = `<p class="mt-8 p-4 rounded-md text-center glass" style="color: var(--theme-text-secondary);">Esta lección se enfoca en la comprensión y aplicación. Revisa el desafío y considera marcarla como completada si has alcanzado los objetivos (función de completado manual futura).</p>`;
                            }
                        }
                        evaluationHTML += `<div id="lesson-evaluation-result" class="form-message mt-6"></div>`;

                    } else { // Usuario no logueado
                        evaluationHTML = `<div class="mt-8 p-6 rounded-lg glass text-center">
                                            <h3 class="font-orbitron text-2xl mb-3" style="color:var(--calypso-warning);">Acción Requerida</h3>
                                            <p style="color:var(--theme-text-secondary);">Debes <a href="#/login" class="font-bold hover:underline" style="color:var(--theme-accent-primary);">iniciar sesión</a> o <a href="#/registro" class="font-bold hover:underline" style="color:var(--theme-accent-primary);">registrarte</a> para realizar la evaluación, guardar tu progreso y obtener tu certificado.</p>
                                         </div>`;
                    }
                } else { // No hay objeto 'evaluation'
                     evaluationHTML = `<p class="mt-8 p-4 rounded-md text-center glass" style="color: var(--theme-text-secondary);">No hay una evaluación formal para esta lección. Asegúrate de comprender los conceptos y completar cualquier actividad práctica sugerida.</p>`;
                }

                // --- Renderizado Final ---
                container.innerHTML = `
                    <div class="lesson-detail-container pb-12">
                        <header class="mb-10 border-b border-[var(--theme-glass-border)] pb-8">
                            <div class="flex flex-col md:flex-row justify-between items-start gap-4">
                                <div class="flex-grow">
                                    <p class="text-sm mb-2" style="color:var(--theme-text-secondary);">
                                        Estás en: <a href="#/curso" class="hover:underline" style="color:var(--theme-accent-secondary);">Academia "@CL-4i"</a> / 
                                        <a href="#/modulo/${lesson.moduleId}" class="hover:underline" style="color:var(--theme-accent-secondary);">${category?.title || 'N/A'}</a>
                                    </p>
                                    <h1 class="lesson-detail-title text-4xl md:text-5xl text-gradient-green">${lesson.title}</h1>
                                    <p class="text-base mt-2" style="color:var(--theme-text-secondary);">
                                        Dificultad: <span style="color:var(--theme-text-primary);">${lesson.difficulty || 'No especificada'}</span> | 
                                        Duración Estimada: <span style="color:var(--theme-text-primary);">${lesson.duration_min || 'N/A'} min</span>
                                    </p>
                                </div>
                                <a href="#/modulo/${lesson.moduleId}" class="btn btn-secondary btn-sm mt-2 md:mt-0 whitespace-nowrap">← Volver a la Categoría</a>
                            </div>
                        </header>
                        
                        <article class="prose prose-invert max-w-none text-lg leading-relaxed" style="color:var(--theme-text-primary);">
                            ${lesson.description}
                        </article>

                        ${lesson.importance_statement ? `
                        <section class="lesson-context mt-10 p-6 glass rounded-xl shadow-lg">
                            <h2 class="font-orbitron text-2xl mb-4 flex items-center" style="color:var(--theme-accent-primary);"><span class="text-3xl mr-3">💡</span> ¿Por Qué es Clave esta Lección?</h2>
                            <p style="color:var(--theme-text-primary); line-height:1.8;">${lesson.importance_statement}</p>
                            ${lesson.cl4i_connection ? `<p class="mt-4 text-sm p-3 rounded-md bg-[var(--theme-bg-tertiary)]" style="color:var(--theme-text-secondary); border-left: 3px solid var(--theme-accent-secondary);"><strong style="color:var(--theme-accent-secondary);">Conexión con CL-4i:</strong> ${lesson.cl4i_connection}</p>` : ''}
                        </section>` : ''}

                        ${lesson.objectives && lesson.objectives.length > 0 ? `
                        <section class="lesson-objectives mt-10">
                            <h2 class="view-title text-2xl mb-6" style="text-align:left; color:var(--theme-accent-primary);">Objetivos de Aprendizaje</h2>
                            <ul class="list-none pl-0 space-y-3">
                                ${lesson.objectives.map(obj => `<li class="flex items-start p-3  mb-4 glass rounded-md hover:bg-[var(--theme-accent-glow)] transition-colors">
                                                                    <span class="text-xl mr-3 mt-px" style="color:var(--theme-accent-secondary);">🎯</span>
                                                                    <span style="color:var(--theme-text-primary);">${obj}</span>
                                                                 </li>`).join('')}
                            </ul>
                        </section>` : ''}
                        
                        ${prerequisitesHTML}
                        
                        ${resourcesSectionHTML}

                        ${lesson.challenge ? `
                        <section class="lesson-challenge mt-10 p-6 glass rounded-xl shadow-lg bg-gradient-to-br from-[var(--theme-bg-secondary)] to-[var(--theme-bg-tertiary)]">
                             <h2 class="font-orbitron text-2xl mb-4 flex items-center" style="color:var(--theme-accent-primary);"><span class="text-3xl mr-3">🚀</span> Desafío Práctico</h2>
                             <div class="prose prose-invert max-w-none" style="color:var(--theme-text-primary);">${lesson.challenge}</div>
                        </section>` : ''}

                        ${lesson.caly_support && lesson.caly_support.length > 0 ? `
                        <section class="lesson-caly-support mt-10 p-6 glass rounded-xl">
                             <h2 class="font-orbitron text-2xl mb-4 flex items-center" style="color:var(--theme-accent-primary);"><span class="text-3xl mr-3">🧠</span> Consejos de Caly@IA</h2>
                             <ul class="list-none pl-0 space-y-2">
                                ${lesson.caly_support.map(tip => `<li class="flex items-start"><span class="text-lg mr-2 mt-px" style="color:var(--theme-accent-secondary);">></span><span style="color:var(--theme-text-primary); font-size:0.95rem;">${tip}</span></li>`).join('')}
                             </ul>
                        </section>` : ''}
                        
                        <section class="lesson-evaluation-section mt-10">${evaluationHTML}</section>
                    </div>`;

                // --- Lógica de Eventos para Evaluación ---
                const evalForm = document.getElementById('lesson-evaluation-form');
                const resultDiv = document.getElementById('lesson-evaluation-result');
                
                if (evalForm && resultDiv) {
                    const submitBtn = evalForm.querySelector('button[type="submit"]');
                    evalForm.addEventListener('submit', async (event) => {
                        event.preventDefault();
                        const originalBtnHTML = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = `<span class="btn-spinner"></span> Evaluando tu conocimiento...`;
                        hideFormMessage(resultDiv);

                        const formData = new FormData(event.target);
                        let score = 0, correctAnswers = 0;
                        if (lesson.evaluation && lesson.evaluation.questions && lesson.evaluation.questions.length > 0) {
                            lesson.evaluation.questions.forEach((q, index) => {
                                if (formData.get(`q${index}`) !== null && parseInt(formData.get(`q${index}`)) === q.a) correctAnswers++;
                            });
                            score = lesson.evaluation.questions.length > 0 ? Math.round((correctAnswers / lesson.evaluation.questions.length) * 100) : 0;
                        }
                        
                        const passed = score >= (lesson.evaluation?.passing_score || 70); 
                        const status = passed ? 'completed' : 'failed';
                        updateUserProgress(lesson.id, score, status, lesson.moduleId);

                        showFormMessage(resultDiv,
                            passed ? `¡Felicidades, ${user.username}! Aprobaste con ${score}%. Tu progreso y certificado están listos.` : `Resultado: ${score}%. No alcanzaste el mínimo. ¡Revisa el material y anímate a intentarlo de nuevo!`,
                            passed ? 'success' : 'error'
                        );
                        
                        if (passed) {
                             // Ocultar el formulario de evaluación y mostrar el mensaje de éxito con el botón de certificado.
                             evalForm.style.display = 'none';
                             // Re-renderizar la vista para mostrar la sección de certificado y actualizar UI general.
                             setTimeout(() => {
                                router(); // Re-renderiza la vista completa
                                if (typeof updateDynamicIsland === "function") updateDynamicIsland(); 
                             }, 2000); 
                        } else {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnHTML;
                        }
                    });
                }

                const completePracticalBtn = document.getElementById('complete-practical-challenge');
                if (completePracticalBtn && user && lesson.evaluation && (lesson.evaluation.type === "practical_review_simulated" || lesson.evaluation.type === "mixed") && (!lesson.evaluation.questions || lesson.evaluation.questions.length === 0)) {
                    completePracticalBtn.addEventListener('click', async () => {
                        const originalBtnHTML = completePracticalBtn.innerHTML;
                        completePracticalBtn.disabled = true;
                        completePracticalBtn.innerHTML = `<span class="btn-spinner"></span> Procesando...`;
                        hideFormMessage(resultDiv);

                        // Simular una "revisión" para este tipo de desafío.
                        // Aquí, simplemente lo marcaremos como completado con un 100% (o una nota fija)
                        const score = 100; // O podría ser un valor fijo si no hay "calificación"
                        const status = 'completed';
                        updateUserProgress(lesson.id, score, status, lesson.moduleId);

                        showFormMessage(resultDiv, `¡Excelente ${user.username}! Has marcado el desafío práctico como completado. Tu progreso ha sido actualizado.`, 'success');
                        
                        setTimeout(() => {
                            router(); // Re-renderizar para mostrar certificado, etc.
                            if (typeof updateDynamicIsland === "function") updateDynamicIsland();
                        }, 2000);
                    });
                }


            } catch (error) {
                console.error("Error cargando lección:", error);
                container.innerHTML = `<div class="text-center p-10"><h2 class="view-title" style="color:var(--calypso-error);">Error de Carga</h2><p class="view-subtitle">No se pudo cargar la lección: ${error.message}. Por favor, recarga la página o contacta a soporte.</p></div>`;
            }
        }

        function membershipsView(container, params) {
            container.innerHTML = `
                <div class="text-center mb-12">
                    <h1 class="view-title">Membresías Calypso Labs</h1>
                    <p class="view-subtitle">Elige el plan que impulse tu viaje maker al siguiente nivel y desbloquea todo el potencial de Calypso Labs. El acceso inicial es por mérito y aprendizaje.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 mb-5 gap-6 md:gap-8">
                    <div class="philosophy-card glass">
                        <h4><strong class="philosophy-card-title">🎯 ¡Acceso Público y Sin Barreras!</strong></h4>
                        <p class="text-[#d7e3ea]">Dirigido a 🧑‍🎓 estudiantes, aprendices autodidactas y makers entusiastas. Esta es una oportunidad <strong>sin barreras económicas iniciales</strong>. Aquí, tu mérito, constancia y habilidades demostradas son la clave para convertirte en un verdadero <strong>Maker Calypso</strong>.</p>
                        <p class="text-[#d7e3ea]">Desbloquea acceso a las herramientas físicas <strong>¡Dentro del laboratorio!</strong>.</p>
                    </div>
                    
                    <div class="philosophy-card glass">
                        <h4><strong class="philosophy-card-title">✨ Beneficios Exclusivos (Acceso Maker):</strong></h4>
                        <ul class="ml-5 mt-1 list-disc space-y-0.5 text-[#d7e3ea] marker:text-sky-400">
                            <li>🏆 Participación en sorteos, becas y recompensas por logros.</li>
                            <li>🎁 Oportunidad de ganar hardware (Jetson, SSDs para IA), ⏱️ horas gratuitas (maquila PCB, simulación avanzada, VPS).</li>
                            <li>🧪 Acceso a pruebas de APIs (MQTT educativo), despliegues en la nube para proyectos académicos y personales.</li>
                            <li>🎓 Certificados digitales con QR por cada lección y módulo completado.</li>
                        </ul>
                    </div>
                    
                    <div class="philosophy-card glass">
                        <h4><strong class="philosophy-card-title">🚀 Tu Viaje Comienza Aquí:</strong></h4>
                        <p class="text-[#d7e3ea]">El "Acceso Maker" es tu punto de partida. Demuestra tu capacidad, completa los módulos y obtén recompensas para explorar y utilizar nuestro laboratorio y recursos en la nube. ¡Dale vida a tu proyecto ahora!</p>
                        <a href="#/curso" class="btn btn-primary font-orbitron mt-auto" style="padding: 0.8rem 1.5rem; font-size: 1rem;">Navega en el ecosistema maker "@CL-4i"</a>
                    </div>
                </div>

              <div class="text-center text-content-secondary mt-6 mb-5 max-w-2xl mx-auto">
                  <nav class="flex flex-wrap justify-center gap-4 text-xs md:text-sm my-2 text-gray-400">
                    <span class="flex items-center gap-1"> <span class="text-lg">✅</span> <span>Completo</span>  </span>
                    <span class="flex items-center gap-1"> | <span class="text-lg">🛠️</span> <span>Limitado/Básico</span>  </span>
                    <span class="flex items-center gap-1"> | <span class="text-lg">❌</span> <span>No disponible</span>  </span>
                    <span class="flex items-center gap-1"> | <span class="text-xs text-gray-400">Nivel según membresía:</span> <span class="font-bold">parcial / básica / remota / avanzada</span> </span>
                  </nav>
              </div>
                <div class="memberships-table-container glass p-2 md:p-4">
                    <table class="memberships-table w-full text-base border-separate border-spacing-y-1">
                        <thead>
                            <tr class="bg-[#14161a] text-[#16aaff] font-orbitron text-lg">
                                <th class="p-3 rounded-tl-xl">Beneficio / Característica</th>
                                <th class="text-center p-3">Acceso Maker<br><small class="text-gray-400 font-normal">(Gratuito por mérito)</small></th>
                                <th class="text-center p-3">STUDENT PRO<br><small class="text-gray-400 font-normal">(Próximamente)</small></th>
                                <th class="text-center p-3">CLOUD MAKER<br><small class="text-gray-400 font-normal">(Próximamente)</small></th>
                                <th class="text-center p-3 rounded-tr-xl">FULL ACCESS LAB<br><small class="text-gray-400 font-normal">(Próximamente)</small></th>
                            </tr>
                        </thead>
                        <tbody class="bg-[#181b20] text-[#fafbfc]">
                            <tr><td>Asistente IA Caly (básico y feedback en vivo)</td><td class="text-center">✅</td><td class="text-center">✅ Avanzado</td><td class="text-center">✅ Prioritario</td><td class="text-center">✅ Dedicado</td></tr>
                            <tr><td>Proyectos de ejemplo, plantillas y recursos técnicos</td><td class="text-center">🛠️ Básico</td><td class="text-center">✅ Completo</td><td class="text-center">✅ Premium</td><td class="text-center">✅ Premium</td></tr>
                            <tr><td>Acceso a foros y comunidad Maker</td><td class="text-center">🛠️ Limitado</td><td class="text-center">✅</td><td class="text-center">✅</td><td class="text-center">✅ Prioridad</td></tr>
                            <tr><td>Descuentos en componentes y maquila PCB</td><td class="text-center">❌</td><td class="text-center">✅</td><td class="text-center">✅</td><td class="text-center">✅</td></tr>
                            <tr><td>Horas de simulación en nube (avanzado)</td><td class="text-center">❌</td><td class="text-center">🛠️ Básico</td><td class="text-center">✅ </td><td class="text-center">✅</td></tr>
                            <tr><td>Acceso a API MQTT & Dashboard Cloud</td><td class="text-center">🛠️ Educativo</td><td class="text-center">✅ Estándar</td><td class="text-center">✅</td><td class="text-center">✅</td></tr>
                            <tr><td>Soporte técnico y mentoría personalizada</td><td class="text-center">❌</td><td class="text-center">🛠️ Email Básico</td><td class="text-center">✅ Remota</td><td class="text-center">✅ Avanzada Dedicada</td></tr>
                            <tr><td>Acceso a laboratorio físico (presencial, beta)</td><td class="text-center">❌</td><td class="text-center">🛠️ Parcial (Eventos)</td><td class="text-center">❌</td><td class="text-center">✅ Completo</td></tr>
                            <tr><td>Participación en retos y sorteos con premios</td><td class="text-center">✅</td><td class="text-center">✅ Mejorados</td><td class="text-center">✅ VIP</td><td class="text-center">✅ VIP Plus</td></tr>
                            <tr>
                                <td></td>
                                <td class="text-center p-3"><button class="btn btn-secondary btn-sm" disabled>Estás Aquí</button></td>
                                <td class="text-center p-3"><button class="btn btn-primary btn-sm" disabled>Próximamente</button></td>
                                <td class="text-center p-3"><button class="btn btn-primary btn-sm" disabled>Próximamente</button></td>
                                <td class="text-center p-3"><button class="btn btn-primary btn-sm" disabled>Próximamente</button></td>
                            </tr>
                        </tbody>
                    </table>
                     <p class="text-xs text-center mt-4 text-gray-500">🛠️ Acceso limitado o básico. Precios y características de membresías de pago son referenciales y estarán disponibles próximamente.</p>
                </div>
              <section id="infraestructura" class="py-12 mt-6 md:py-16">
                <h2 class="view-title">Nuestra Infraestructura y Capacidades</h2>
                <p class="text-center view-subtitle mb-8 max-w-2xl mx-auto">Equipados con tecnología de punta y un espacio dedicado para llevar tus ideas del concepto a la realidad. Ofrecemos prototipado rápido, fabricación, desarrollo electrónico avanzado y mucho más para los miembros calificados.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                  <div class="philosophy-card glass"><h4 class="philosophy-card-title">🌐 Centro de Datos & Cloud</h4><p>Servidor IBM-01 (Linux Mint) con NAS Synology, VPS dedicados, backups redundantes y red privada segura. Preparado para balanceo de carga, CCTV y servicios de nube híbrida para tus proyectos IoT.</p><ul><li>Hosting VPS Dedicado</li><li>Almacenamiento NAS Seguro y Rápido</li><li>Red Privada IoT Segregada</li><li>Servicios de Nube Híbrida (MQTT, API Gateway)</li></ul></div>
                  <div class="philosophy-card glass"><h4 class="philosophy-card-title">🔥 Estación de Soldadura Profesional</h4><p>Montaje y reparación electrónica de precisión con estación doble (aire caliente y cautín), microscopio digital y herramientas de diagnóstico avanzadas. Ideal para SMD fino y pruebas funcionales.</p><ul><li>Prototipado Rápido (Through-Hole y SMD)</li><li>Soldadura SMD de Precisión (hasta 0201)</li><li>Reparación y Rework de Circuitos</li><li>Inspección Óptica y Control de Calidad</li></ul></div>
                  <div  class="philosophy-card glass"><h4  class="philosophy-card-title">🤖 Pick and Place SMD Automatizado</h4><p>Máquina CNC para colocación automática de componentes SMD, horno de reflujo controlado por perfil térmico y estación de pasta soldante con dispensador neumático y curado UV.</p><ul><li>Ensamblaje Automatizado de PCBs (Pequeñas Series)</li><li>Aplicación Precisa de Pasta de Soldar</li><li>Curado en Horno de Reflujo Controlado</li><li>Soldadura Selectiva UV para Componentes Sensibles</li></ul></div>
                  <div  class="philosophy-card glass"><h4 class="philosophy-card-title">💡 Laboratorio de Desarrollo Electrónico</h4><p>Espacio dedicado para codificación, control embebido, diseño de circuitos, experimentación con MCUs (ESP32, STM32, Raspberry Pi Pico) y desarrollo de soluciones IoT completas.</p><ul><li>Diseño Esquemático y Layout de PCB (Fusion360 by Autodesk, Altium, Eagle, entre otros.)</li><li>Programación de Microcontroladores Avanzada</li><li>Desarrollo de Sistemas Embebidos y IoT</li><li>Bancos de Pruebas y Debugging con Osciloscopio y Analizador Lógico</li></ul></div>
                  <div  class="philosophy-card glass"><h4 class="philosophy-card-title">⚙️ Fresado CNC para PCBs y Prototipos</h4><p>Fresadora QuickCircuit 5000 para fabricación rápida de PCBs in-house, enrutado de doble capa, aislamiento para soldadura UV y creación de prototipos mecánicos ligeros.</p><ul><li>Fabricación de PCBs In-House (Prototipos Rápidos)</li><li>Maquinado de Precisión para Cajas y Soportes</li><li>Grabado y Corte de Materiales Blandos</li><li>Creación de Stencils Personalizados para SMD</li></ul></div>
                  <div  class="philosophy-card glass"><h4 class="philosophy-card-title">🔬 Impresión 3D Avanzada (FDM & SLA)</h4><p>Tecnología FDM (cámara cerrada) para piezas funcionales y prototipos robustos, y SLA de alta precisión (resina UV) para detalles finos, moldes y piezas con acabados superiores.</p><ul><li>Prototipado Rápido y Funcional (FDM: ABS, PETG, Nylon)</li><li>Impresión de Alta Resolución y Detalles Finos (SLA)</li><li>Diseño y Modelado 3D Asistido</li><li>Post-Procesado de Piezas (Curado UV, Lijado, Pintura)</li></ul></div>
                </div>
              </section>
            `;
        }
        
        function showFormMessage(element, message, type) {
            if(!element) return;
            element.textContent = message;
            element.className = 'form-message'; 
            if (type) element.classList.add(`form-message-${type}`);
            element.classList.add('show');
        }
        function hideFormMessage(element) {
            if(!element) return;
            element.classList.remove('show');
            setTimeout(() => { if(element) element.textContent = ''; }, 300);
        }

        function loginView(container, params) {
            if (getCurrentUser()) { navigateTo('/perfil'); return; }
            container.innerHTML = `
                <div class="form-container glass" style="max-width: 400px;">
                    <h2 class="view-title mb-8" style="font-size: 1.8rem;">Iniciar Sesión en Calypso</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="email">Correo Electrónico</label>
                            <input type="email" id="email" name="email" required autocomplete="email">
                        </div>
                        <div class="form-group">
                            <label for="password">Contraseña</label>
                            <input type="password" id="password" name="password" required autocomplete="current-password">
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Acceder a Mi Cuenta Maker</button>
                        <p id="login-message" class="form-message"></p>
                    </form>
                    <p class="text-center mt-6">¿Aún no eres maker en Calypso? <a href="#/registro" style="color:var(--theme-accent-primary); font-weight:bold;" class="hover:underline">Regístrate Aquí y Comienza tu Viaje</a>.</p>
                </div>`;

            const form = document.getElementById('login-form');
            const msgP = document.getElementById('login-message');
            const submitBtn = form.querySelector('button[type="submit"]');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideFormMessage(msgP);
                const originalBtnHTML = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = `<span class="btn-spinner"></span> Verificando credenciales...`;

                try {
                    await loginUser({ email: form.email.value, password: form.password.value });
                    updateNavUI();
                    renderSidebarContent();
                    if (typeof updateDynamicIsland === "function" && (window.location.hash === '#/' || window.location.hash === '')) updateDynamicIsland();
                    navigateTo('/perfil'); 
                } catch (error) {
                    showFormMessage(msgP, error.message || "Error desconocido al iniciar sesión. Verifica tus datos.", "error");
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnHTML;
                }
            });
        }

        function registerView(container, params) {
            if (getCurrentUser()) { navigateTo('/perfil'); return; }
            container.innerHTML = `
                <div class="form-container glass" style="max-width: 400px;">
                    <h2 class="view-title mb-8" style="font-size: 1.8rem;">Crear Tu Cuenta Maker</h2>
                    <form id="register-form">
                        <div class="form-group">
                            <label for="username">Nombre de Usuario (Maker ID)</label>
                            <input type="text" id="username" name="username" required autocomplete="username" pattern="[a-zA-Z0-9_]{3,20}" title="3-20 caracteres, letras, números y guion bajo.">
                        </div>
                        <div class="form-group">
                            <label for="email">Correo Electrónico</label>
                            <input type="email" id="email" name="email" required autocomplete="email">
                        </div>
                        <div class="form-group">
                            <label for="password">Contraseña Segura</label>
                            <input type="password" id="password" name="password" required minlength="8" autocomplete="new-password" title="Mínimo 8 caracteres.">
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Unirme a la Comunidad Calypso Labs</button>
                        <p id="register-message" class="form-message"></p>
                    </form>
                    <p class="text-center mt-6">¿Ya tienes una cuenta? <a href="#/login" style="color:var(--theme-accent-primary); font-weight:bold;" class="hover:underline">Inicia Sesión Aquí</a>.</p>
                </div>`;

            const form = document.getElementById('register-form');
            const msgP = document.getElementById('register-message');
            const submitBtn = form.querySelector('button[type="submit"]');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideFormMessage(msgP);
                const originalBtnHTML = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = `<span class="btn-spinner"></span> Creando tu cuenta maker...`;

                try {
                    await registerUser({ username: form.username.value, email: form.email.value, password: form.password.value });
                    showFormMessage(msgP, "¡Registro exitoso! Serás redirigido para iniciar sesión.", "success");
                    setTimeout(() => navigateTo('/login'), 2500);
                } catch (error) {
                    showFormMessage(msgP, error.message || "Error desconocido durante el registro. Intenta de nuevo.", "error");
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnHTML;
                }
            });
        }
        async function profileView(container, params) {
            const user = getCurrentUser();
            if (!user) { navigateTo('/login'); return; }

            renderLoadingIndicator(container, "Cargando tu perfil maker...");

            const categories = await fetchCategories();
            const allLessons = JSON.parse(localStorage.getItem('calypso_lessons')) || [];
            const userProgress = getUserProgress(user.email);

            // --- Progreso en el Curso ---
            let progressHTML = `<ul class="lesson-list ">`;
            if (categories.length > 0) {
                categories.sort((a, b) => a.order - b.order).forEach(category => {
                    progressHTML += `<li class="glass module-card p-4 rounded-lg mb-3">
                                        <h4 class="text-lg font-orbitron mb-2" style="color:var(--theme-accent-secondary);">${category.icon_class} ${category.title}</h4>`;
                    const lessonsInCategory = allLessons.filter(l => l.moduleId === category.id).sort((a, b) => a.order - b.order);
                    if (lessonsInCategory.length > 0) {
                        progressHTML += `<ul class="pl-5 mt-2 space-y-1 text-sm">`;
                        lessonsInCategory.forEach(lesson => {
                            const lessonProg = userProgress.lessons?.[lesson.id];
                            let lessonStatus = 'No iniciado';
                            let lessonColor = 'var(--theme-text-secondary)';
                            let statusIcon = '⚪';
                            let scoreText = '';

                            if (lessonProg) {
                                scoreText = lessonProg.score !== undefined ? ` (${lessonProg.score}%)` : '';
                                if (lessonProg.status === 'completed') {
                                    lessonStatus = `Completado${scoreText}`;
                                    lessonColor = 'var(--calypso-success)';
                                    statusIcon = '🟢';
                                } else if (lessonProg.status === 'in_progress') {
                                    lessonStatus = 'En progreso';
                                    lessonColor = 'var(--calypso-warning)';
                                    statusIcon = '🟡';
                                } else if (lessonProg.status === 'failed') {
                                    lessonStatus = `Fallido${scoreText}`;
                                    lessonColor = 'var(--calypso-error)';
                                    statusIcon = '🔴';
                                }
                            }
                            progressHTML += `<li style="color:${lessonColor}; display:flex; align-items:center; gap: 0.5rem; padding: 0.25rem 0;">
                                                <span class="mr-1 text-lg">${statusIcon}</span>
                                                <a href="#/leccion/${lesson.id}" class="hover:underline flex-grow" style="color: var(--theme-text-primary);">${lesson.title}</a>
                                                <span class="text-xs opacity-80">${lessonStatus}</span>
                                             </li>`;
                        });
                        progressHTML += `</ul>`;
                    } else {
                        progressHTML += `<p class="text-xs text-gray-500 pl-5">(Próximamente lecciones aquí)</p>`;
                    }
                    progressHTML += `</li>`;
                });
            } else {
                progressHTML += `<li>No hay categorías de curso definidas actualmente.</li>`;
            }
            progressHTML += '</ul>';

            // --- Logros y Reconocimientos ---
            let achievementsHTML = '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 profile-achievements-grid">';
            const userAchievements = (userProgress.achievements || []).sort((a,b) => new Date(b.date) - new Date(a.date));
            
            if (userAchievements.length > 0) {
                userAchievements.forEach(ach => {
                    let cardClass = 'achievement-card glass lesson-list-item flex flex-col items-center justify-start p-3 min-h-[120px]'; // Asegurar altura mínima y padding
                    let iconHTML = `<span class="achievement-icon text-3xl mb-2">${ach.icon || '🏆'}</span>`;
                    let titleHTML = `<p class="achievement-title text-sm font-semibold text-center leading-tight">${ach.title}</p>`;
                    let typeDescription = '';

                    switch(ach.type) {
                        case 'skill_badge':
                            cardClass += ' border-2 border-opacity-50'; // Borde distintivo
                            cardClass = cardClass.replace('border-opacity-50', `border-[var(--theme-accent-primary)]`); // Asegurar el color del borde
                            typeDescription = `<p class="text-xs mt-1" style="color:var(--theme-accent-secondary); font-style:italic;">Habilidad Validada</p>`;
                            break;
                        case 'access_unlock':
                            cardClass += ' border-2 border-opacity-50';
                            cardClass = cardClass.replace('border-opacity-50', `border-[var(--calypso-warning)]`);
                            typeDescription = `<p class="text-xs mt-1" style="color:var(--calypso-warning); font-style:italic;">Acceso Otorgado</p>`;
                            break;
                        case 'major_certificate':
                            cardClass += ' border-2 border-opacity-50';
                            cardClass = cardClass.replace('border-opacity-50', `border-[var(--calypso-success)]`);
                            typeDescription = `<p class="text-xs mt-1" style="color:var(--calypso-success); font-style:italic;">Certificación Principal</p>`;
                            break;
                        case 'lesson_completion':
                             // Sin borde especial o descripción de tipo, es un logro estándar
                            break;
                        default: // generic_unlock u otros
                            cardClass += ' border-opacity-30';
                            cardClass = cardClass.replace('border-opacity-30', `border-[var(--theme-text-secondary)]`);
                            break;
                    }

                    achievementsHTML += `
                        <div class="${cardClass}" title="${ach.title} - Obtenido el ${new Date(ach.date).toLocaleDateString('es-ES')}">
                            ${iconHTML}
                            ${titleHTML}
                            ${typeDescription}
                            <p class="achievement-date text-xs mt-auto pt-1" style="color:var(--theme-text-secondary);">${new Date(ach.date).toLocaleDateString('es-ES', { day:'2-digit', month: 'short', year: 'numeric' })}</p>
                        </div>`;
                });
            } else {
                achievementsHTML = '<p style="color:var(--theme-text-secondary);" class="text-center p-6 glass col-span-full rounded-lg">Aún no has desbloqueado logros. ¡Completa tu registro y las lecciones para empezar a coleccionarlos!</p>';
            }
            achievementsHTML += '</div>';

            // --- Resto del HTML del Perfil (sin cambios significativos, solo usando el achievementsHTML generado arriba) ---
            const profilePicUrl = user.profile_picture_url || `https://source.boringavatars.com/beam/120/${encodeURIComponent(user.username)}?colors=${getComputedStyle(document.documentElement).getPropertyValue('--theme-accent-primary').trim().substring(1)},${getComputedStyle(document.documentElement).getPropertyValue('--theme-bg-primary').trim().substring(1)}`;
            const coverPicUrl = user.cover_image_url || 'https://source.unsplash.com/random/1200x300/?abstract,circuits,futuristic';

            container.innerHTML = `
                <div class="p-0" style="background: transparent; border:none; box-shadow:none;">
                    <div class="profile-cover" style="background-image: url('${coverPicUrl}');">
                        <img src="${profilePicUrl}" alt="Avatar de ${user.username}" class="profile-avatar-main" onerror="this.src='https://source.boringavatars.com/beam/120/${encodeURIComponent(user.username)}?colors=cccccc,333333';">
                    </div>
                    <div class="profile-info-bar glass">
                        <div class="profile-main-details">
                            <h1 class="profile-username-main">${user.username}</h1>
                            <p class="profile-email-main">${user.email}</p>
                        </div>
                        <div class="profile-meta-details">
                            <p><span class="font-orbitron">Rol:</span> ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</p>
                            <p><span class="font-orbitron">Maker desde:</span> ${new Date(user.created_at).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                        </div>
                    </div>
                    <div class="profile-content-area p-4 md:p-6 mt-4 glass">
                        <h2 class="profile-section-title">Personaliza Tu Identidad Maker</h2>
                        <form id="profile-customization-form" class="form-container" style="max-width: none; padding:0; margin-top:1rem;">
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="form-group">
                                    <label for="profile-pic-url">URL Imagen de Perfil (Avatar):</label>
                                    <input type="url" id="profile-pic-url" name="profile_picture_url" value="${user.profile_picture_url || ''}" placeholder="https://ejemplo.com/avatar.jpg">
                                </div>
                                <div class="form-group">
                                    <label for="cover-pic-url">URL Imagen de Portada (Banner):</label>
                                    <input type="url" id="cover-pic-url" name="cover_image_url" value="${user.cover_image_url || ''}" placeholder="https://ejemplo.com/portada.jpg">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary mt-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 8.012a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm.024-3.364A.5.5 0 0 1 3 4.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.476-.652zm-.005 6.678a.5.5 0 0 1 .5.5H15.5a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.48-.638zM1 2.5A1.5 1.5 0 0 1 2.5 1h11A1.5 1.5 0 0 1 15 2.5v11a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 13.5V2.5z"/></svg>
                                Guardar Cambios de Imagen
                            </button>
                            <p id="profile-save-message" class="form-message mt-3"></p>
                        </form>

                        <h2 class="profile-section-title">Progreso de Academia "@CL-4i"</h2>
                        ${progressHTML}

                        <h2 class="profile-section-title">Mis Logros y Habilidades Verificadas</h2>
                        ${achievementsHTML}
                    </div>
                </div>`;

            // --- Lógica para el formulario de personalización (sin cambios, ya estaba bien) ---
            const customizationForm = document.getElementById('profile-customization-form');
            const saveMessageP = document.getElementById('profile-save-message');
            const submitBtnProfile = customizationForm?.querySelector('button[type="submit"]'); // Añadido optional chaining

            if (customizationForm && saveMessageP && submitBtnProfile) { // Asegurarse que todos los elementos existen
                customizationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    hideFormMessage(saveMessageP);
                    const originalBtnHTML = submitBtnProfile.innerHTML;
                    submitBtnProfile.disabled = true;
                    submitBtnProfile.innerHTML = `<span class="btn-spinner"></span> Actualizando imágenes...`;

                    const newProfilePicUrl = document.getElementById('profile-pic-url').value.trim();
                    const newCoverPicUrl = document.getElementById('cover-pic-url').value.trim();

                    try {
                        await updateUserProfileDetails({ profile_picture_url: newProfilePicUrl, cover_image_url: newCoverPicUrl });
                        showFormMessage(saveMessageP, "¡Imágenes de perfil actualizadas con éxito!", "success");

                        const avatarImg = document.querySelector('.profile-avatar-main');
                        const coverDiv = document.querySelector('.profile-cover');
                        if (avatarImg) avatarImg.src = newProfilePicUrl || `https://source.boringavatars.com/beam/120/${encodeURIComponent(user.username)}?colors=${getComputedStyle(document.documentElement).getPropertyValue('--theme-accent-primary').trim().substring(1)},${getComputedStyle(document.documentElement).getPropertyValue('--theme-bg-primary').trim().substring(1)}`;
                        if (coverDiv) coverDiv.style.backgroundImage = `url('${newCoverPicUrl || 'https://source.unsplash.com/random/1200x300/?abstract,technology,circuits'}')`;
                        
                        if (typeof renderSidebarContent === "function") renderSidebarContent(); 
                    } catch (error) {
                        showFormMessage(saveMessageP, error.message || "Error al actualizar las imágenes del perfil.", "error");
                    } finally {
                        submitBtnProfile.disabled = false;
                        submitBtnProfile.innerHTML = originalBtnHTML;
                    }
                });
            } else {
                console.warn("Formulario de personalización o sus elementos no encontrados en profileView.");
            }
        }
    </script>
    
    <script>        // --- Theme Management ---
        const themeToggleButton = document.getElementById('theme-toggle-btn');
        const appWrapper = document.querySelector('.app-wrapper');

        function applyTheme(themeMode, themeConfig) {
            if (!themeConfig || !themeConfig[themeMode]) {
                themeConfig = GLOBAL_DEFAULT_THEME; 
            }
            const activeTheme = { ...GLOBAL_DEFAULT_THEME[themeMode], ...(themeConfig[themeMode] || {}) };

            for (const [key, value] of Object.entries(activeTheme)) {
                 document.documentElement.style.setProperty(key, value);
            }
            
            if (appWrapper) { // Apply background images specifically to app-wrapper
                const mainBg = activeTheme['--app-background-image'] || GLOBAL_DEFAULT_THEME[themeMode]['--app-background-image'] || 'none';
                const auroraBg = activeTheme['--app-background-aurora'] || GLOBAL_DEFAULT_THEME[themeMode]['--app-background-aurora'] || 'none';
                let combinedBg = [];
                if (mainBg && mainBg !== 'none') combinedBg.push(mainBg);
                if (auroraBg && auroraBg !== 'none') combinedBg.push(auroraBg);
                appWrapper.style.backgroundImage = combinedBg.length > 0 ? combinedBg.join(', ') : 'none';
            }


            localStorage.setItem('calypso_color_mode', themeMode);
            if (themeToggleButton) themeToggleButton.innerHTML = themeMode === 'light' ? '☾<span class="sr-only"></span>' : '☼<span class="sr-only"></span>';
            document.body.className = themeMode; 
        }

        function applyCurrentTheme() {
            const preferredMode = localStorage.getItem('calypso_color_mode') || 'dark';
            let moduleThemeConfig = null;
            let currentCategories = [];
            try {
                currentCategories = JSON.parse(localStorage.getItem('calypso_categories')) || CATEGORIES_DATA;
            } catch(e) {
                currentCategories = CATEGORIES_DATA; 
            }

            if (currentModuleIdForTheme) {
                const categoryData = currentCategories.find(m => m.id === currentModuleIdForTheme);
                if (categoryData && categoryData.theme) {
                    moduleThemeConfig = categoryData.theme;
                }
            }
            applyTheme(preferredMode, moduleThemeConfig); 
        }

        function toggleLightDarkMode() {
            const currentMode = localStorage.getItem('calypso_color_mode') || 'dark';
            const newMode = currentMode === 'light' ? 'dark' : 'light';
            let currentCategories = [];
             try {
                currentCategories = JSON.parse(localStorage.getItem('calypso_categories')) || CATEGORIES_DATA;
            } catch(e) {
                currentCategories = CATEGORIES_DATA;
            }
            let moduleThemeConfig = null;
            if (currentModuleIdForTheme) {
                const categoryData = currentCategories.find(m => m.id === currentModuleIdForTheme);
                if (categoryData && categoryData.theme) {
                    moduleThemeConfig = categoryData.theme;
                }
            }
            applyTheme(newMode, moduleThemeConfig); 
        }

        if (themeToggleButton) {
            themeToggleButton.addEventListener('click', toggleLightDarkMode);
        }
        
        async function generateCertificatePDF(userName, categoryName, lessonName, score, certificateId) {
            // --- Pre-validación y Configuración Inicial ---
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                console.error("jsPDF no está cargado. Asegúrate de que la librería esté incluida y disponible en window.jspdf.");
                alert("Error: La librería para generar PDF no está cargada.");
                return;
            }

            if (typeof QRCode === 'undefined') {
                console.warn("La librería QRCode no está cargada. El certificado se generará sin código QR.");
                // Podrías decidir no generar el PDF aquí si el QR es mandatorio:
                // alert("Error: La librería para generar el código QR no está cargada.");
                // return;
            }

            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            // --- Obtención de Estilos y Fallbacks ---
            const getThemeStyle = (varName, fallback) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim() || fallback;

            const accentColor = getThemeStyle('--theme-accent-primary', '#007bff');
            const textColorPrimary = getThemeStyle('--theme-text-primary', '#212529');
            const textColorSecondary = getThemeStyle('--theme-text-secondary', '#6c757d');
            // const bgColorPrimaryPDF = getThemeStyle('--theme-bg-primary', '#ffffff'); // No usado directamente en este diseño
            const bgColorSecondaryPDF = getThemeStyle('--theme-bg-secondary', '#f8f9fa');

            // --- Fallbacks para Datos de Entrada ---
            const userNameClean = userName || "Participante Valioso";
            const categoryNameClean = categoryName || "Categoría General";
            const lessonNameClean = lessonName || "Lección Completada";
            const scoreClean = score || 0;
            const certificateIdClean = certificateId || "N/A-" + Date.now(); // ID único si no se provee

            // --- Constantes de Fuentes (IMPORTANTE: deben estar cargadas en jsPDF) ---
            // Si 'Orbitron' e 'Inter' no están cargadas, jsPDF usará Helvetica por defecto.
            // Considera una función async para cargar fuentes antes de llamar a esta función.
            // Ejemplo: await loadCustomFonts(doc);
            const FONT_TITLE = 'Helvetica'; // Cambiar a 'Orbitron' si está cargada y registrada
            const FONT_MAIN = 'Helvetica';  // Cambiar a 'Inter' si está cargada y registrada

            try {
                // --- INICIO DEL DIBUJO DEL PDF ---

                // 1. Fondo del Certificado
                doc.setFillColor(bgColorSecondaryPDF);
                doc.rect(0, 0, pageWidth, pageHeight, 'F');

                // Patrón sutil de fondo (opcional)
                doc.setLineWidth(0.1);
                doc.setDrawColor(accentColor); // O un gris muy claro: "#e0e0e0"
                for (let i = 0; i < pageWidth; i += 15) { doc.line(i, 0, i, pageHeight); }
                for (let j = 0; j < pageHeight; j += 15) { doc.line(0, j, pageWidth, j); }

                // 2. Bordes Decorativos
                doc.setLineWidth(2);
                doc.setDrawColor(accentColor);
                doc.rect(5, 5, pageWidth - 10, pageHeight - 10); // Borde exterior
                doc.setLineWidth(0.5);
                doc.setDrawColor(textColorSecondary); // O un tono más claro del accentColor
                doc.rect(8, 8, pageWidth - 16, pageHeight - 16); // Borde interior

                // 3. Logo (Ejemplo de texto, idealmente cargar imagen)
                // const calypsoLogoBase64PNG = "data:image/png;base64,TU_LOGO_AQUI...";
                // try { doc.addImage(calypsoLogoBase64PNG, 'PNG', 15, 15, 50, 18); } catch (e) { ... }
                doc.setFont(FONT_TITLE, 'bold');
                doc.setFontSize(20);
                doc.setTextColor(accentColor);
                doc.text("CALYPSO LABS", 15, 25);

                // 4. Título del Certificado
                doc.setFont(FONT_TITLE, 'bold');
                doc.setFontSize(28);
                doc.setTextColor(textColorPrimary);
                doc.text("CERTIFICADO DE LOGRO", pageWidth / 2, 55, { align: 'center' });

                doc.setFont(FONT_MAIN, 'normal');
                doc.setFontSize(11);
                doc.setTextColor(textColorSecondary);
                doc.text("Sistema de Acreditación Maker Avanzado", pageWidth / 2, 65, { align: 'center' });

                // 5. Texto de Otorgamiento
                doc.setFont(FONT_MAIN, 'normal');
                doc.setFontSize(14);
                doc.setTextColor(textColorPrimary);
                doc.text("Con orgullo se otorga este certificado a:", pageWidth / 2, 85, { align: 'center' });

                // 6. Nombre del Usuario
                doc.setFont(FONT_TITLE, 'bold');
                doc.setFontSize(30);
                doc.setTextColor(accentColor);
                doc.text(userNameClean.toUpperCase(), pageWidth / 2, 105, { align: 'center' });

                // 7. Razón del Certificado
                doc.setFont(FONT_MAIN, 'normal');
                doc.setFontSize(12);
                doc.setTextColor(textColorPrimary);
                doc.text("Por completar exitosamente la lección:", pageWidth / 2, 120, { align: 'center' });

                doc.setFont(FONT_MAIN, 'bold');
                doc.setFontSize(16);
                const lessonTitleText = `${lessonNameClean}`;
                const lessonTextLines = doc.splitTextToSize(lessonTitleText, pageWidth - 80); // Max width para el título
                doc.text(lessonTextLines, pageWidth / 2, 135, { align: 'center' });

                let currentY = 135 + (lessonTextLines.length * (doc.getFontSize() * 0.5)); // Ajusta 0.5 según interlineado
                currentY += 7; // Espacio

                doc.setFont(FONT_MAIN, 'normal');
                doc.setFontSize(11);
                doc.setTextColor(textColorSecondary);
                doc.text(`Parte de la categoría: ${categoryNameClean}`, pageWidth / 2, currentY, { align: 'center' });
                currentY += 11; // Espacio

                // 8. Calificación
                doc.setFont(FONT_MAIN, 'bold');
                doc.setFontSize(12);
                doc.setTextColor(textColorPrimary);
                doc.text(`Calificación Obtenida: ${scoreClean}%`, pageWidth / 2, currentY, { align: 'center' });

                // 9. Información al Pie (Fecha, ID)
                const emissionDate = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
                const bottomMargin = 15;
                doc.setFont(FONT_MAIN, 'normal');
                doc.setFontSize(9);
                doc.setTextColor(textColorSecondary);
                doc.text("Calypso Labs Academy", 20, pageHeight - bottomMargin);
                doc.text(`ID del Certificado: ${certificateIdClean}`, 20, pageHeight - bottomMargin - 5);
                doc.text(`Emitido el: ${emissionDate}`, 20, pageHeight - bottomMargin - 10);

                // 10. Código QR (Asíncrono)
                const qrContainerId = 'qr-code-container'; // ID del div para el QR
                const qrContainer = document.getElementById(qrContainerId);

                if (typeof QRCode !== 'undefined' && qrContainer) {
                    // SOLUCIÓN AL ERROR: Reducir los datos del QR
                    const validationUrl = `https://www.calypsolabs.com.mx/validate?id=${certificateIdClean}`;
                    const qrCodeData = validationUrl; // Solo la URL o un identificador corto

                    // Usamos una promesa para manejar la generación del QR
                    await new Promise((resolve, reject) => {
                        qrContainer.innerHTML = '';
                        qrContainer.classList.remove('hidden'); // Asegúrate que 'hidden' sea display:none

                        new QRCode(qrContainer, {
                            text: qrCodeData,
                            width: 80, // Tamaño del QR en el DOM (no afecta el tamaño en PDF directamente)
                            height: 80,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.M // Nivel M es un buen compromiso para URLs
                        });

                        // Esperar un breve momento para que el QR se renderice en el DOM
                        setTimeout(() => {
                            try {
                                const qrCanvas = qrContainer.querySelector('canvas');
                                const qrImgElement = qrContainer.querySelector('img');
                                let qrImgDataUrl = null;

                                if (qrCanvas) {
                                    qrImgDataUrl = qrCanvas.toDataURL('image/png');
                                } else if (qrImgElement) {
                                    // Si es una <img>, su .src podría ya ser un data URL, o necesitarías dibujarla a un canvas
                                    qrImgDataUrl = qrImgElement.src;
                                }

                                if (qrImgDataUrl) {
                                    const qrPdfSize = 30; // Tamaño del QR en el PDF (mm)
                                    const qrPdfX = pageWidth - qrPdfSize - 15; // Posición X
                                    const qrPdfY = pageHeight - qrPdfSize - bottomMargin - 5; // Posición Y

                                    doc.addImage(qrImgDataUrl, 'PNG', qrPdfX, qrPdfY, qrPdfSize, qrPdfSize);

                                    doc.setFont(FONT_MAIN, 'normal');
                                    doc.setFontSize(8);
                                    doc.setTextColor(textColorSecondary);
                                    doc.text("Verifica este certificado", qrPdfX + qrPdfSize / 2, qrPdfY + qrPdfSize + 4, { align: 'center', maxWidth: qrPdfSize + 20 });
                                } else {
                                    console.warn("No se pudo obtener la imagen del código QR del DOM.");
                                }
                                resolve(); // Resuelve la promesa haya o no QR
                            } catch (error) {
                                console.error("Error procesando el código QR para el PDF:", error);
                                reject(error); // Rechaza la promesa en caso de error grave
                            } finally {
                                qrContainer.classList.add('hidden');
                                qrContainer.innerHTML = '';
                            }
                        }, 200); // 200ms suele ser suficiente. Ajustar si es necesario.
                    });
                } else {
                    if (!qrContainer) console.warn(`Contenedor QR con id '${qrContainerId}' no encontrado. Certificado sin QR.`);
                    // Si QRCode no está definido, ya se advirtió al inicio.
                }

                // --- FINALIZACIÓN Y GUARDADO DEL PDF ---
                // Esto se ejecuta después de que la promesa del QR se resuelva (o si se omite el QR)
                const fileName = `Certificado_Calypso_${userNameClean.replace(/\s+/g, '_')}_${lessonNameClean.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
                console.log(`Certificado PDF generado: ${fileName}`);

            } catch (error) {
                console.error("Error catastrófico generando el certificado PDF:", error);
                alert("Ocurrió un error muy grave al generar el certificado. Revisa la consola para más detalles.");
            }
        }
    </script>

    <script>        // --- UI Updates & Event Listeners ---
        function updateNavUI() {
            const currentUser = getCurrentUser();
            const navLogin = document.getElementById('nav-login');
            const navRegister = document.getElementById('nav-register');
            const navLogout = document.getElementById('nav-logout');
            const navPerfil = document.getElementById('nav-perfil');

            navLogin?.classList.toggle('hidden', !!currentUser);
            navRegister?.classList.toggle('hidden', !!currentUser);
            navLogout?.classList.toggle('hidden', !currentUser);
            if (navPerfil) {
                navPerfil.classList.toggle('hidden', !currentUser);
                if (currentUser) navPerfil.textContent = `Hola, ${currentUser.username}`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof initializeSidebar === "function") initializeSidebar();
            else console.error("initializeSidebar no está definida.");

            updateNavUI();
            applyCurrentTheme(); 

            const logoutButton = document.getElementById('nav-logout');
            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    logoutUser();
                    updateNavUI();
                    if(typeof renderSidebarContent === "function") renderSidebarContent();
                    if (typeof updateDynamicIsland === "function" && (window.location.hash === '#/' || window.location.hash === '')) updateDynamicIsland();
                    currentModuleIdForTheme = null; 
                    applyCurrentTheme();
                    navigateTo('/');
                });
            }

            document.getElementById('nav-login')?.addEventListener('click', () => navigateTo('/login'));
            document.getElementById('nav-register')?.addEventListener('click', () => navigateTo('/registro'));

            const mobileNavToggleBtn = document.getElementById('mobile-nav-toggle-btn');
            const mainNav = document.getElementById('main-nav');
            if (mobileNavToggleBtn && mainNav) {
                mobileNavToggleBtn.addEventListener('click', () => {
                    const isOpen = mainNav.classList.toggle('open');
                    mobileNavToggleBtn.setAttribute('aria-expanded', isOpen.toString());
                    mobileNavToggleBtn.innerHTML = isOpen ? '✕<span class="sr-only"></span>' : '👤<span class="sr-only"></span>';
                });
                mainNav.querySelectorAll('a, button.btn-nav').forEach(link => {
                    link.addEventListener('click', () => {
                        if (mainNav.classList.contains('open')) {
                            mainNav.classList.remove('open');
                            mobileNavToggleBtn.setAttribute('aria-expanded', 'false');
                            mobileNavToggleBtn.innerHTML = '👤<span class="sr-only"></span>';
                        }
                    });
                });
            }
            
            if (typeof router === "function") router(); 
            else console.error("Router no definido.");
            
            if (typeof initializeCalyChat === "function") initializeCalyChat();
            
            if (typeof updateDynamicIsland === "function" && (window.location.hash === '#/' || window.location.hash === '')) {
                updateDynamicIsland();
            }

            const currentYearSpan = document.getElementById('current-year');
            if (currentYearSpan) { currentYearSpan.textContent = new Date().getFullYear(); }
        });
    </script>

    <script>        // --- Caly Chat Widget ---
        function initializeCalyChat() {
            const chatContainer = document.getElementById('caly-chat-widget-container');
            if (!chatContainer) return;

            chatContainer.innerHTML = `
                <div id="caly-widget">
                    <div id="caly-header" aria-expanded="false" aria-controls="caly-body">
                        <h3>Caly Asistente IA 🧠</h3>
                        <span id="caly-toggle-icon">🔼</span>
                    </div>
                    <div id="caly-body" role="log" aria-live="polite">
                        <div id="caly-messages">
                            <div class="caly-response">¡Hola! Soy Caly, tu asistente IA de Calypso Labs. ¿En qué puedo ayudarte hoy con el curso, tus proyectos maker o alguna duda sobre electrónica y programación?</div>
                        </div>
                        <div id="caly-input-area" role="form">
                            <input type="text" id="caly-input" placeholder="Pregúntame algo..." aria-label="Escribe tu pregunta para Caly">
                            <button id="caly-send" class="btn btn-primary" aria-label="Enviar pregunta">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/></svg>
                            </button>
                        </div>
                    </div>
                </div>`;

            const widget = document.getElementById('caly-widget');
            const header = document.getElementById('caly-header');
            const toggleIcon = document.getElementById('caly-toggle-icon'); // Should be caly-toggle-icon based on HTML

            if(!widget || !header || !toggleIcon) return;

            header.addEventListener('click', () => {
                const isOpen = widget.classList.toggle('open');
                header.setAttribute('aria-expanded', isOpen.toString());
            });

            const sendButton = document.getElementById('caly-send');
            const input = document.getElementById('caly-input');
            const messagesDiv = document.getElementById('caly-messages');

            if(!sendButton || !input || !messagesDiv) return;

            const addMessage = (text, sender = 'user') => {
                const msgDiv = document.createElement('div');
                msgDiv.textContent = text;
                msgDiv.className = sender === 'user' ? 'user-message' : 'caly-response';
                messagesDiv.appendChild(msgDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight; 
                return msgDiv; 
            };
            
            const calyResponses = {
                "hola": "¡Hola! Soy Caly. ¿Listo para crear algo increíble o aprender algo nuevo sobre el CL-4i? Pregúntame lo que necesites.",
                "ayuda": "¡Claro que sí! Estoy aquí para ayudarte. Especifica tu duda: ¿Es sobre una lección, un componente, KiCad, programación ESP32, MQTT, o algo más general de Calypso Labs?",
                "cl-4i": "El CL-4i es nuestro proyecto insignia: un droide educativo modular y open-hardware. Está diseñado para que aprendas robótica, electrónica y programación de forma práctica y divertida. El curso te guía en su construcción, programación y personalización avanzada.",
                "cad": "PCBmkr es la introdicción al desarrollo en software EDA (Electronic Design Automation) open source mas potente. En Calypso Labs diseñamos esquemáticos y PCBs con herramientas CAD / CAM Profesionales. En el Módulo 2, 'Diseño Electrónico y Esquemáticos Profesionales', encontrarás lecciones detalladas para dominarlo.",
                "mqtt": "MQTT (Message Queuing Telemetry Transport) es un protocolo de mensajería ligero, ideal para proyectos IoT y comunicación entre dispositivos. En Calypso Labs lo exploramos en el Módulo 5, 'Conectividad BLE, Wi-Fi y Provisioning Seguro', donde podrás usar nuestro broker educativo.",
                "certificado": "¡Claro! Los certificados digitales foliados y con QR se generan automáticamente al completar satisfactoriamente cada lección que tenga una evaluación. Podrás descargarlos en formato PDF desde la página de la lección o desde tu perfil de usuario en la sección de Logros.",
                "proyecto": "Si te refieres al Proyecto Integrador (Módulo M7), es la culminación del Curso Maestro y academia remota del Laboratorio Calypso. Aplicarás todo lo aprendido para diseñar y construir un dispositivo IoT completo. ¡Es tu oportunidad de brillar!",
                "simulador": "Nuestro simulador ClaySim (Módulo M6) te permite probar algoritmos de navegación y control para robots en un entorno 3D antes de implementarlos en hardware real. Es una herramienta muy útil para el desarrollo autónomo.",
                "gracias": "¡De nada! Es un placer ayudarte. Mi objetivo es que tu experiencia en Calypso Labs sea lo más productiva y enriquecedora posible. ¡Sigue aprendiendo, creando e innovando!",
                "default": "Entendido. Estoy procesando tu consulta. Para preguntas muy específicas, te recomiendo revisar los recursos detallados de cada lección, o si es algo más complejo, puedes consultar en los foros de la comunidad Calypso o a un mentor si tienes acceso."
            };

            const handleCalyInput = () => {
                const userText = input.value.trim();
                if (userText) {
                    addMessage(userText, 'user');
                    input.value = ''; 
                    
                    const thinkingMsgDiv = addMessage("Caly está analizando tu pregunta...", 'caly-response');
                    thinkingMsgDiv.style.fontStyle = 'italic';
                    thinkingMsgDiv.style.opacity = '0.7';

                    setTimeout(() => {
                        if (messagesDiv.contains(thinkingMsgDiv)) { 
                           messagesDiv.removeChild(thinkingMsgDiv);
                        }
                        let calyResponseText = calyResponses.default;
                        let foundResponse = false;
                        for (const keyword in calyResponses) {
                            if (userText.toLowerCase().includes(keyword)) {
                                calyResponseText = calyResponses[keyword];
                                foundResponse = true;
                                break; 
                            }
                        }
                        if (!foundResponse && userText.length > 10) { 
                            calyResponseText = `Hmm, esa es una pregunta interesante: "${userText.substring(0,30)}...". No tengo una respuesta predefinida para eso. ¿Podrías intentar reformularla o buscar palabras clave relacionadas con los módulos del curso? También puedes consultar los recursos específicos de cada lección.`;
                        }
                        addMessage(calyResponseText, 'caly');
                    }, 900 + Math.random() * 800); // Slightly longer, more varied "thinking" time
                }
            };

            sendButton.addEventListener('click', handleCalyInput);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    handleCalyInput();
                }
            });
        }
    </script>

</body>
</html>